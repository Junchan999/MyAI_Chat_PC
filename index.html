<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ï¼­ï½™AIChat_PC (ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ç‰ˆ)</title>
    <style>
        html {
            height: 100%;
        }
        body {
            height: 100vh;
            margin: 0;
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(to bottom, #e0fff0, #ffffff);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            flex-wrap: nowrap;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
            gap: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #2e8b57;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .header-profile-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            flex-grow: 1;
            min-width: 200px;
        }
        .header-profile-switcher label {
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .header-profile-switcher select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 0.9em;
            max-width: 250px;
        }
        .header-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        .header-buttons {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
        }

        .header-buttons button,
        .modal-buttons button,
        .csv-buttons-container button,
        .csv-buttons-container label,
        .chat-history-list-footer button,
        .sort-controls button,
        #save-edited-message-button,
        #download-pdf-button,
        .tab-button {
            padding: 10px 18px;
            border: none;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            white-space: nowrap;
            min-width: 100px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        .header-buttons button:hover,
        .modal-buttons button:hover,
        .csv-buttons-container button:hover,
        .csv-buttons-container label:hover,
        .chat-history-list-footer button:hover,
        .sort-controls button:hover,
        #save-edited-message-button:hover,
        #download-pdf-button:hover,
        .tab-button:hover {
            opacity: 0.95;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        #persona-button,
        #load-chat-history-button,
        #new-chat-button,
        #settings-button,
        #help-button {
            background-color: #f0f0f0;
            color: #444;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        #persona-button:hover,
        #load-chat-history-button:hover,
        #new-chat-button:hover,
        #settings-button:hover,
        #help-button:hover {
            background-color: #e0e0e0;
            color: #222;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        #delete-selected-button { background-color: #dc3545; }
        #edit-selected-button { background-color: #ffc107; color: #333; }
        #play-selected-button { background-color: #28a745; }
        #stop-speech-button { background-color: #6c757d; }
        #save-chat-summary-button { background-color: #007bff; }
        #print-pdf-button { background-color: #17a2b8; }


        .main-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 20px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            overflow: hidden;
        }

        #side-panel {
            width: 280px;
            min-width: 280px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #side-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            color: #2e8b57;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            flex-grow: 1;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #datetime-display {
            text-align: center;
            padding: 8px;
            background-color: rgba(240, 240, 240, 0.7);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 1.2em;
            color: #555;
            flex-shrink: 0;
        }
        .chat-box {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .message.selected { background-color: #ffebee; border: 1px solid #e57373; }
        .message img.message-image { max-width: 100%; border-radius: 10px; margin-bottom: 8px; }
        .user-message { background-color: #c8e6c9; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 5px; }
        .error-message { background-color: #f8d7da; color: #721c24; align-self: flex-start; }
        .summary-message { background-color: #fef9e7; align-self: center; width: 95%; max-width: 95%; border: 1px solid #fceecb; text-align: left; }
        .timestamp { font-size: 0.75em; color: #888; margin-top: 4px; }
        
        .input-area {
            display: flex;
            flex-direction: column;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            flex-grow: 1;
            min-height: 0;
        }
        #image-preview-container {
            position: relative;
            margin-bottom: 8px;
            display: none;
            width: fit-content;
        }
        #image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ddd; }
        #remove-image-button {
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            border-radius: 50%; border: none; background-color: rgba(0, 0, 0, 0.6);
            color: white; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center;
        }
        
        .input-controls { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .input-buttons-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 8px; 
            flex-wrap: wrap;
            align-items: flex-end;
        }
        #text-input {
            flex-grow: 1; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 12px; 
            padding: 10px 15px; 
            resize: vertical;
            font-family: inherit; 
            font-size: 1em;
            min-height: 120px;
        }
        #text-input:focus {
            outline: none; border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        #file-input-button, #mic-button, #send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 1.6em;
            line-height: 48px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        #file-input-button:hover, #mic-button:hover, #send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #file-input-button { background-color: #4CAF50; }
        #mic-button { background-color: #007bff; }
        #mic-button.recording { background-color: #dc3545; }
        #send-button { background-color: #6f42c1; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content {
            background-color: #fefefe; margin: 2.5vh auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 800px;
            border-radius: 8px; display: flex; flex-direction: column;
            max-height: 95vh;
        }
        #settings-modal .modal-content { max-width: 500px; }
        #persona-modal .modal-content { max-width: 90vw; }
        .modal-body { overflow-y: auto; padding-right: 10px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content h2 { margin-top: 0; flex-shrink: 0; }
        .modal-content h3 { font-size: 1.1em; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .name-setting-container { display: flex; gap: 10px; align-items: center; }
        .name-setting-container label { flex-basis: 100px; }
        .name-setting-container input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        #persona-textarea, #summary-prompt-textarea, #api-key-input {
            width: 100%; margin-top: 10px; box-sizing: border-box; border-radius: 4px;
            border: 1px solid #ccc; padding: 8px; font-family: inherit;
        }
        #persona-textarea { height: 250px; resize: vertical; }
        #summary-prompt-textarea { height: 200px; resize: vertical; }
        #api-key-input { height: auto; }

        .examples-container { margin-top: 10px; }
        .examples-container button { margin-right: 5px; margin-bottom: 5px; }
        .modal-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 20px; flex-shrink: 0; }
        .settings-columns { display: flex; gap: 30px; flex-wrap: wrap; justify-content: space-between; }
        .settings-column { flex: 1; min-width: 320px; }
        .sound-settings div { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .sound-settings label { min-width: 80px; white-space: nowrap; }
        .sound-settings input[type="range"] { flex-grow: 1; width: auto; }
        .sound-settings span { min-width: 30px; text-align: right; }
        #chat-history-list-modal .modal-content { max-width: 900px; }
        #chat-history-search-input { width: calc(100% - 20px); padding: 10px; margin: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #chat-history-list { list-style: none; padding: 0; margin: 0 10px; border: 1px solid #eee; border-radius: 5px; overflow-y: auto; max-height: 60vh; margin-bottom: 10px; }
        #chat-history-list li { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s ease; display: flex; align-items: center; }
        #chat-history-list li:last-child { border-bottom: none; }
        #chat-history-list li:hover { background-color: #e8f5e9; }
        #chat-history-list li .history-item-content { flex-grow: 1; margin-left: 10px; }
        #chat-history-list li .title { font-weight: bold; color: #333; }
        #chat-history-list li .date-time { font-size: 0.8em; color: #666; margin-top: 4px; }
        .chat-history-list-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-top: 1px solid #eee; flex-wrap: wrap; gap: 10px; }
        .chat-history-list-footer .left-buttons, .chat-history-list-footer .right-buttons { display: flex; gap: 10px; flex-wrap: nowrap; }
        .sort-controls { display: flex; align-items: center; gap: 5px; flex-wrap: nowrap; }
        .sort-controls label { white-space: nowrap; margin-right: 5px; }
        .sort-controls select { padding: 6px 8px; border-radius: 5px; border: 1px solid #ccc; background-color: #fff; font-size: 0.9em; }
        #save-settings-button, #test-key-button, #save-key-button { background-color: #28a745; min-width: 100px; }
        #delete-key-button { background-color: #dc3545; min-width: 100px; }
        .modal-buttons .right-buttons button { background-color: #28a745; }
        #test-key-button { background-color: #17a2b8; }
        .csv-buttons-container button, .csv-buttons-container label { background-color: #6f42c1; min-width: 150px; }
        #export-all-history-button { background-color: #20c997; }
        #import-csv-input, #import-all-history-input, #import-md-input { display: none; }
        .chat-history-list-footer .left-buttons, .chat-history-list-footer .right-buttons { display: flex; gap: 10px; flex-wrap: nowrap; }
        .chat-history-list-footer button { min-width: 120px; }
        #select-all-history-button { background-color: #007bff; }
        #deselect-all-history-button { background-color: #6c757d; }
        #load-selected-history-button { background-color: #28a745; }
        #delete-selected-history-button { background-color: #dc3545; }
        .sort-controls button { background-color: #6c757d; min-width: unset; padding: 8px 12px; border-radius: 20px; }
        .sort-controls button:hover { background-color: #5a6268; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #download-pdf-button { background-color: #007bff; }
        .sort-order-icon { font-size: 1.1em; vertical-align: middle; }
        .tab-navigation { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; flex-wrap: wrap; gap: 5px; }
        .tab-button { padding: 10px 15px; border: none; background-color: #f0f0f0; color: #555; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; transition: background-color 0.3s ease, color 0.3s ease; border: 1px solid #ddd; border-bottom: none; box-shadow: none; margin-right: -1px; min-width: unset; }
        .tab-button:hover { background-color: #e0e0e0; color: #333; transform: none; box-shadow: none; z-index: 1; }
        .tab-button.active { background-color: #fff; color: #2e8b57; border-color: #2e8b57; border-bottom-color: #fff; position: relative; z-index: 2; }
        .tab-body { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .tab-pane { display: none; padding: 10px 0; }
        .tab-pane.active { display: block; }

        @media (max-width: 1250px) { .main-container { flex-direction: column; align-items: center; gap: 10px; padding: 10px; overflow-y: auto; } #side-panel { order: -2; width: 100%; max-width: 600px; margin-bottom: 10px; } header { flex-wrap: wrap; } .header-profile-switcher { margin-left: 0; width: 100%; order: 3; } .header-controls { justify-content: flex-end; } header h1 { font-size: 1.2em; } }
        @media (max-width: 768px) { body { font-size: 0.9em; } header { padding: 8px 10px; flex-direction: column; align-items: flex-start; gap: 5px; } header h1 { font-size: 1.3em; margin-bottom: 5px; } .header-profile-switcher { width: 100%; justify-content: space-between; margin-bottom: 10px; } .header-profile-switcher select { flex-grow: 1; } .header-controls { width: 100%; justify-content: center; } .header-buttons { flex-wrap: wrap; justify-content: center; gap: 8px; } .header-buttons button { padding: 8px 15px; font-size: 0.9em; min-width: unset; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .main-container { gap: 15px; padding: 10px; } #side-panel { width: 100%; max-width: 95%; padding: 15px; } .chat-container { width: 100%; max-width: 95%; } .message { max-width: 90%; padding: 8px 12px; font-size: 0.95em; } .timestamp { font-size: 0.7em; } #text-input { min-height: 100px; } .modal-content { width: calc(100% - 20px); margin: 10px auto; padding: 15px; max-height: 98vh; } #settings-modal .modal-content, #persona-modal .modal-content, #chat-history-list-modal .modal-content, #pdf-viewer-modal .modal-content { max-width: 95vw; } .modal-body { padding-right: 0; } .tab-navigation { flex-direction: column; align-items: stretch; } .tab-button { border-radius: 8px; margin-right: 0; margin-bottom: 5px; border-bottom: 1px solid #ddd; } .tab-button.active { border-bottom: 1px solid #2e8b57; } .settings-columns { flex-direction: column; gap: 15px; } .name-setting-container { flex-direction: column; align-items: flex-start; } .name-setting-container label { flex-basis: 100%; width: 100%; margin-bottom: 5px; } .csv-buttons-container { flex-direction: column; gap: 10px; align-items: stretch; } .csv-buttons-container button, .csv-buttons-container label { width: 100%; box-sizing: border-box; min-width: unset; } .sound-settings div { flex-wrap: wrap; } .sound-settings label { flex-basis: 100%; } #chat-history-search-input { width: calc(100% - 20px); margin: 10px 0; } #chat-history-list { max-height: 50vh; } .chat-history-list-footer { flex-direction: column; align-items: stretch; gap: 10px; } .chat-history-list-footer .left-buttons, .chat-history-list-footer .right-buttons, .sort-controls { width: 100%; justify-content: space-between; flex-wrap: wrap; gap: 5px; } .chat-history-list-footer button, .sort-controls select, .sort-controls button { flex-grow: 1; flex-basis: calc(50% - 5px); box-sizing: border-box; min-width: unset; text-align: center; } .sort-controls label { flex-basis: 100%; text-align: left; } .sort-controls select, .sort-controls button { flex-basis: calc(50% - 5px); } }
        @media (max-width: 480px) { header h1 { font-size: 1.1em; } .header-buttons button { font-size: 0.85em; padding: 6px 12px; } .main-container { padding: 5px; } #side-panel, .chat-container { padding: 10px; } .message { max-width: 95%; } #file-input-button, #mic-button, #send-button { width: 40px; height: 40px; font-size: 1.2em; line-height: 40px; } .modal-content { width: calc(100% - 10px); margin: 5px auto; padding: 10px; } .chat-history-list-footer .left-buttons button, .chat-history-list-footer .right-buttons button, .sort-controls select, .sort-controls button { flex-basis: 100%; } }
        @media print { body { margin: 0; padding: 0; } header, #side-panel, .input-area, .modal, .chat-history-list-footer { display: none !important; } .main-container { display: block; padding: 0; margin: 0; } .chat-container { border: none; box-shadow: none; max-width: none; width: 100%; background-color: #fff; backdrop-filter: none; overflow: visible; } #datetime-display { display: none; } .chat-box { overflow: visible; padding: 10px; } .message, .chat-log .message { box-shadow: none; border: 1px solid #eee; margin-bottom: 5px; padding: 8px 12px; border-radius: 8px; max-width: 100%; word-wrap: break-word; page-break-inside: avoid; } .user-message { background-color: #e0f0e0; text-align: left; margin-left: 0; border-bottom-right-radius: 8px; border-bottom-left-radius: 5px;} .bot-message { background-color: #f0f0f0; text-align: left; border-bottom-left-radius: 5px;} .chat-log .speaker { font-weight: bold; margin-bottom: 0px; display: block; } .chat-log .timestamp { font-size: 0.75em; color: #666; margin-top: 2px; display: block; text-align: right;} .message-content { margin-top: 2px; } .summary-message { background-color: #fff8e6; border: 1px solid #ffeeba; text-align: left; margin: 10px 0; } .summary-message h3 { font-size: 1.1em; margin-top: 0; margin-bottom: 5px; border-bottom: none; } .summary-message h2 { font-size: 1.4em; margin-top: 10px; margin-bottom: 5px; border-bottom: none; } .summary-message p { margin-top: 5px; margin-bottom: 0; } h1, h2, h3 { color: #2e8b57; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; } hr { border: 0; border-top: 1px dashed #ccc; margin: 15px 0; } .message-image { max-width: 80%; height: auto; border-radius: 5px; margin-top: 5px; display: block; margin-left: auto; margin-right: auto; } .chat-log { padding: 10px 0; } }
    </style>
</head>
<body>

<header>
    <h1>MyAI Chat History Ver2.60</h1>
    <div class="header-profile-switcher">
        <label for="header-profile-select">ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«:</label>
        <select id="header-profile-select"></select>
    </div>
    <div class="header-controls">
        <div class="header-buttons">
            <button id="persona-button">å„ç¨®è¨­å®š</button>
            <button id="delete-selected-button" style="display: none;">é¸æŠã‚’å‰Šé™¤</button>
            <button id="edit-selected-button" style="display: none;">é¸æŠã‚’ç·¨é›†</button>
            <button id="play-selected-button" style="display: none;">é¸æŠã‚’å†ç”Ÿ</button>
            <button id="stop-speech-button" style="display: none;">éŸ³å£°åœæ­¢</button>
            <button id="save-chat-summary-button">ãƒãƒ£ãƒƒãƒˆä¿å­˜</button>
            <button id="load-chat-history-button">å±¥æ­´ä¸€è¦§</button>
            <button id="print-pdf-button" style="display: none;">PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <button id="new-chat-button">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>
            <button id="settings-button">APIè¨­å®š</button>
            <button id="help-button">å–æ‰±èª¬æ˜æ›¸</button>
        </div>
    </div>
</header>

<input type="file" id="image-file-input" style="display: none;" accept="image/*">
<input type="file" id="import-csv-input" style="display: none;" accept=".csv">
<input type="file" id="import-all-history-input" style="display: none;" accept=".json">
<input type="file" id="import-md-input" style="display: none;" accept=".md">


<div class="main-container">
    <div class="chat-container">
        <div id="datetime-display"></div>
        <div class="chat-box" id="chat-box"></div>
    </div>
    
    <div id="side-panel">
        <div class="input-area">
            <div id="image-preview-container">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-button">&times;</button>
            </div>
            <div class="input-controls">
                <div class="input-buttons-container">
                    <button id="file-input-button" title="ç”»åƒã‚’é¸æŠ">ğŸ“</button>
                    <button id="mic-button" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
                    <button id="send-button" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡">âœˆï¸</button>
                </div>
                <textarea id="text-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã¾ãŸã¯ç”»åƒã‚’ãƒšãƒ¼ã‚¹ãƒˆ... (Shift+Enterã§æ”¹è¡Œ)"></textarea>
            </div>
        </div>
        <p style="font-size: 0.8em; color: #777; margin-top: 10px; text-align: center;">â€» ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¨è¨­å®šã¯PCãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜ãƒ»èª­è¾¼ã•ã‚Œã¾ã™ã€‚</p>
        <p style="font-size: 0.8em; color: #777; margin-top: 5px; text-align: center;">â€» APIã‚­ãƒ¼ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚</p>
    </div>
</div>

<!-- å„ç¨®è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="persona-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-persona-modal">&times;</span>
        <h2>å„ç¨®è¨­å®š</h2>

        <div id="profile-manager" style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1eaff;">
            <h3 style="margin-top:0; color:#005a9c;">è¨­å®šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <p style="font-size: 0.9em; color: #666; margin-top: 0; margin-bottom: 10px;">
                è¨­å®šã®çµ„ã¿åˆã‚ã›ã‚’ã€Œãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€ã¨ã—ã¦ä¿å­˜ã—ã€åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚è¨­å®šã®ä¿å­˜ã¯ã“ã“ã§è¡Œã„ã¾ã™ã€‚
            </p>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="profile-select" style="font-weight: bold;">ç¾åœ¨ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«:</label>
                <select id="profile-select" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; min-width: 150px;"></select>
                <button id="save-profile-button" class="modal-profile-button" style="background-color: #28a745;" title="ç¾åœ¨ã®è¨­å®šã‚’ã€é¸æŠä¸­ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¸Šæ›¸ãä¿å­˜ã—ã¾ã™ã€‚">ğŸ’¾ ç¾è¨­å®šã‚’ä¿å­˜</button>
                <button id="save-as-new-profile-button" class="modal-profile-button" style="background-color: #007bff;" title="ç¾åœ¨ã®è¨­å®šã‚’ã€æ–°ã—ã„åå‰ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚">â• æ–°è¦ä¿å­˜</button>
                <button id="delete-profile-button" class="modal-profile-button" style="background-color: #dc3545;" title="é¸æŠä¸­ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>
        </div>
        <style>
            .modal-profile-button {
                padding: 8px 15px; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; transition: opacity 0.2s;
            }
            .modal-profile-button:hover { opacity: 0.85; }
        </style>

        <div class="tab-navigation">
            <button class="tab-button active" data-tab="history-file-management">å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</button>
            <button class="tab-button" data-tab="ai-response-settings">AIå¿œç­”è¨­å®š</button>
            <button class="tab-button" data-tab="app-behavior-settings">ã‚¢ãƒ—ãƒªå‹•ä½œè¨­å®š</button>
        </div>

        <div class="modal-body tab-body">
            <div id="history-file-management" class="tab-pane active">
                <h3>å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    ã€Œå…¨å±¥æ­´ã‚’JSONã§ä¿å­˜ã€ã§å…¨ã¦ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã€ã€Œå…¨å±¥æ­´ã‚’JSONã‹ã‚‰èª­è¾¼ã€ã§ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
                    ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                </p>
                <div class="csv-buttons-container">
                    <button id="export-all-history-button" style="background-color: #20c997;">å…¨å±¥æ­´ã‚’JSONã§ä¿å­˜</button>
                    <label for="import-all-history-input" style="background-color: #6f42c1;">å…¨å±¥æ­´ã‚’JSONã‹ã‚‰èª­è¾¼</label>
                </div>
                <hr style="margin-top:20px; border-top:1px dashed #eee;">
                <h3>MDãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    ã€Œãƒãƒ£ãƒƒãƒˆä¿å­˜ã€ã§ä½œæˆã—ãŸMarkdown (.md) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å±¥æ­´ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
                </p>
                <div class="csv-buttons-container">
                    <label for="import-md-input" id="import-md-button" style="background-color: #6f42c1;">MDãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼</label>
                </div>
            </div>

            <div id="ai-response-settings" class="tab-pane">
                <div class="settings-columns">
                    <div class="settings-column">
                        <h3>AIã®æ€§æ ¼ï¼ˆãƒšãƒ«ã‚½ãƒŠ_ãƒ¡ã‚¿ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</h3>
                        <p>AIã®æŒ¯ã‚‹èˆã„ã‚’æŒ‡å®šã™ã‚‹æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                        <textarea id="persona-textarea" placeholder="ä¾‹ï¼šã‚ãªãŸã¯è¦ªåˆ‡ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚çµµæ–‡å­—ã‚’ãŸãã•ã‚“ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åŠ±ã¾ã—ã¦ãã ã•ã„ã€‚"></textarea>
                        <div class="examples-container">
                            <p>è¨­å®šä¾‹:</p>
                            <button class="persona-example-btn" data-persona="ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€è¦ªåˆ‡ã§å„ªã—ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å¸¸ã«ä¸å¯§ãªè¨€è‘‰é£ã„ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚">å„ªã—ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</button>
                            <button class="persona-example-btn" data-persona="ã‚ãªãŸã¯ç‰¹å®šã®åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚è³ªå•ã«å¯¾ã—ã¦ã€å°‚é–€ç”¨èªã‚’äº¤ãˆã¤ã¤ã€å¸¸ã«ç°¡æ½”ã‹ã¤æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„ã€‚">ç°¡æ½”ãªå°‚é–€å®¶</button>
                            <button class="persona-example-btn" data-persona="ã‚ã‚“ãŸã¯é–¢è¥¿å¼ã‚’è©±ã™ã€æ°—ã•ããªå‹é”ã‚„ã§ã€‚ã‚¿ãƒ¡å£ã§ã€ãŸã¾ã«å†—è«‡ã‚’äº¤ãˆãªãŒã‚‰è¿”äº‹ã—ã¦ãªã€‚">é–¢è¥¿å¼ã®å‹é”</button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h3>ãƒãƒ£ãƒƒãƒˆæ¦‚è¦ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                        <p>ãƒãƒ£ãƒƒãƒˆä¿å­˜æ™‚ã®æ¦‚è¦ç”ŸæˆAIã¸ã®æŒ‡ç¤ºã§ã™ã€‚<br><code>{CONVERSATION_HISTORY}</code>ã«ä¼šè©±å±¥æ­´ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ã€‚</p>
                        <textarea id="summary-prompt-textarea" placeholder="ä¾‹ï¼šä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  &quot;title&quot;: &quot;ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)&quot;,\n  &quot;summary&quot;: &quot;ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)&quot;\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---"></textarea>
                        <button id="reset-summary-prompt-button" style="margin-top: 10px; background-color: #6c757d; color: white; padding: 10px 18px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.15); white-space: nowrap;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
                        <h3>ä¼šè©±å±¥æ­´ã®åå‰è¨­å®š</h3>
                        <div class="name-setting-container" style="margin-bottom: 10px;"><label for="user-name-input">ã‚ãªãŸã®åå‰:</label><input type="text" id="user-name-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼"></div>
                        <div class="name-setting-container"><label for="ai-name-input">AIã®åå‰:</label><input type="text" id="ai-name-input" placeholder="AI"></div>
                    </div>
                </div>
            </div>

            <div id="app-behavior-settings" class="tab-pane">
                <div class="settings-columns">
                    <div class="settings-column">
                        <h3>ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h3>
                        <div class="sound-settings">
                            <div><input type="checkbox" id="sound-on-off" checked><label for="sound-on-off">AIå¿œç­”æ™‚ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’é³´ã‚‰ã™</label></div>
                            <div><label for="sound-type-select">ã‚µã‚¦ãƒ³ãƒ‰ã®ç¨®é¡:</label><select id="sound-type-select"><option value="sine">ã‚µã‚¤ãƒ³æ³¢ (æ¨™æº–)</option><option value="square">çŸ©å½¢æ³¢ (ãƒ”ã‚³ãƒ”ã‚³)</option><option value="sawtooth">ã®ã“ãã‚Šæ³¢ (ãƒ–ã‚¶ãƒ¼)</option><option value="triangle">ä¸‰è§’æ³¢ (ãƒã‚¤ãƒ«ãƒ‰)</option></select></div>
                        </div>
                    </div>
                    <div class="settings-column">
                        <div class="sound-settings" style="margin-top: 0;">
                            <div><input type="checkbox" id="tts-on-off" checked><label for="tts-on-off">AIå¿œç­”ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã‚‹</label></div>
                            <div><label for="tts-voice-select">éŸ³å£°ã®ç¨®é¡:</label><select id="tts-voice-select"></select></div>
                            <div><label for="tts-rate-input">é€Ÿåº¦:</label><input type="range" id="tts-rate-input" min="0.1" max="2" step="0.1" value="1"><span id="tts-rate-value">1.0</span></div>
                            <div><label for="tts-pitch-input">ãƒ”ãƒƒãƒ:</label><input type="range" id="tts-pitch-input" min="0" max="2" step="0.1" value="1"><span id="tts-pitch-value">1.0</span></div>
                            <div><label for="tts-volume-input">éŸ³é‡:</label><input type="range" id="tts-volume-input" min="0" max="1" step="0.1" value="1"><span id="tts-volume-value">1.0</span></div>
                        </div>
                    </div>
                </div>
                <hr style="margin-top:20px; border-top:1px dashed #eee;">
                <p style="font-size: 0.9em; color: #666; margin-top: 20px; margin-bottom: 10px;">
                    ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®šã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜/èª­è¾¼ã—ã¾ã™ã€‚<br>
                    ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«ã¯å‘ãã¾ã›ã‚“ã€‚
                </p>
                <div class="csv-buttons-container">
                    <button id="export-csv-button" style="background-color: #6f42c1;">ç¾è¨­å®šã‚’CSVã§ä¿å­˜</button>
                    <label for="import-csv-input" id="import-csv-button" style="background-color: #6f42c1;">è¨­å®šã‚’CSVã‹ã‚‰èª­è¾¼</label>
                </div>
            </div>
        </div>

        <div class="modal-buttons">
            <div></div>
            <div class="right-buttons"><button id="save-settings-button">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>
</div>

<!-- APIã‚­ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-settings-modal">&times;</span>
        <h2>Gemini APIã‚­ãƒ¼è¨­å®š</h2>
        <div class="modal-body">
            <p>ã“ã“ã«å–å¾—ã—ãŸGemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                â€» APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚å…±ç”¨ã®PCãªã©ã§ã¯ã”æ³¨æ„ãã ã•ã„ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨å‰Šé™¤ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </p>
            <input type="password" id="api-key-input" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›...">
            <div id="test-key-result"></div>
        </div>
        <div class="modal-buttons">
            <button id="delete-key-button">ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
            <div class="right-buttons"><button id="test-key-button">APIã‚­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ</button><button id="save-key-button">è¨­å®š</button></div>
        </div>
    </div>
</div>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-message-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-edit-message-modal">&times;</span>
        <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç·¨é›†</h2>
        <div class="modal-body">
            <textarea id="edit-message-textarea" style="width: 100%; height: 150px; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
            <button id="save-edited-message-button">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="chat-history-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-chat-history-list-modal">&times;</span>
        <h2>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ä¸€è¦§</h2>
        <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
            ã“ã®ãƒªã‚¹ãƒˆã¯ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã€‚ã€Œå„ç¨®è¨­å®šã€ã‹ã‚‰JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚<br>
            ã“ã“ã§ã®å¤‰æ›´ï¼ˆèª­ã¿è¾¼ã¿ã€å‰Šé™¤ï¼‰ã¯ã€å†åº¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãªã„ã¨ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
        </p>
        <input type="text" id="chat-history-search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„æ—¥ä»˜ã§æ¤œç´¢...">
        <ul id="chat-history-list"></ul>
        <div class="chat-history-list-footer">
            <div class="left-buttons"><button id="select-all-history-button">å…¨é¸æŠ</button><button id="deselect-all-history-button">å…¨è§£é™¤</button><button id="load-selected-history-button">é¸æŠã‚’èª­è¾¼</button></div>
            <div class="sort-controls"><label for="sort-by-select">ä¸¦ã¹æ›¿ãˆ:</label><select id="sort-by-select"><option value="date">æ—¥ä»˜</option><option value="title">ã‚¿ã‚¤ãƒˆãƒ«</option></select><button id="sort-order-button"><span id="sort-order-icon" class="sort-order-icon">â†“</span></button></div>
            <div class="right-buttons"><button id="delete-selected-history-button">é¸æŠã‚’å‰Šé™¤</button></div>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdf-viewer-modal" class="modal">
    <div class="modal-content" style="max-width: 90%; height: 90vh;">
        <span class="close-button" id="close-pdf-viewer-modal">&times;</span>
        <h2>PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <div class="modal-body" style="flex-grow: 1; display: flex; flex-direction: column;">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                <strong>ğŸ’¡ã”æ³¨æ„:</strong> æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ä¸‹ã®ã€ŒPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã®PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãŒæä¾›ã™ã‚‹ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ„å›³ã—ãªã„ã‚‚ã®ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </p>
            <iframe id="pdf-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="modal-buttons"><button id="download-pdf-button">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button></div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // DOMè¦ç´ ã®å–å¾—
    const chatBox = document.getElementById('chat-box'), textInput = document.getElementById('text-input'), sendButton = document.getElementById('send-button'), micButton = document.getElementById('mic-button'), saveChatSummaryButton = document.getElementById('save-chat-summary-button'), loadChatHistoryButton = document.getElementById('load-chat-history-button'), printPdfButton = document.getElementById('print-pdf-button'), newChatButton = document.getElementById('new-chat-button'), helpButton = document.getElementById('help-button'), datetimeDisplay = document.getElementById('datetime-display'), imageFileInput = document.getElementById('image-file-input'), fileInputButton = document.getElementById('file-input-button'), imagePreviewContainer = document.getElementById('image-preview-container'), imagePreview = document.getElementById('image-preview'), removeImageButton = document.getElementById('remove-image-button'), userNameInput = document.getElementById('user-name-input'), aiNameInput = document.getElementById('ai-name-input'), deleteSelectedButton = document.getElementById('delete-selected-button'), editSelectedButton = document.getElementById('edit-selected-button'), playSelectedButton = document.getElementById('play-selected-button'), stopSpeechButton = document.getElementById('stop-speech-button');
    const personaButton = document.getElementById('persona-button'), personaModal = document.getElementById('persona-modal'), closePersonaModal = document.getElementById('close-persona-modal'), personaTextarea = document.getElementById('persona-textarea'), saveSettingsButton = document.getElementById('save-settings-button'), personaExampleBtns = document.querySelectorAll('.persona-example-btn'), settingsButton = document.getElementById('settings-button'), settingsModal = document.getElementById('settings-modal'), closeSettingsModal = document.getElementById('close-settings-modal'), apiKeyInput = document.getElementById('api-key-input'), saveKeyButton = document.getElementById('save-key-button'), soundOnOff = document.getElementById('sound-on-off'), soundTypeSelect = document.getElementById('sound-type-select'), testKeyButton = document.getElementById('test-key-button'), deleteKeyButton = document.getElementById('delete-key-button'), testKeyResult = document.getElementById('test-key-result'), summaryPromptTextarea = document.getElementById('summary-prompt-textarea'), resetSummaryPromptButton = document.getElementById('reset-summary-prompt-button');
    const importCsvInput = document.getElementById('import-csv-input'), exportCsvButton = document.getElementById('export-csv-button'), exportAllHistoryButton = document.getElementById('export-all-history-button'), importAllHistoryInput = document.getElementById('import-all-history-input'), importMdInput = document.getElementById('import-md-input');
    const editMessageModal = document.getElementById('edit-message-modal'), closeEditMessageModal = document.getElementById('close-edit-message-modal'), editMessageTextarea = document.getElementById('edit-message-textarea'), saveEditedMessageButton = document.getElementById('save-edited-message-button');
    const chatHistoryListModal = document.getElementById('chat-history-list-modal'), closeChatHistoryListModal = document.getElementById('close-chat-history-list-modal'), chatHistoryList = document.getElementById('chat-history-list'), chatHistorySearchInput = document.getElementById('chat-history-search-input'), selectAllHistoryButton = document.getElementById('select-all-history-button'), deselectAllHistoryButton = document.getElementById('deselect-all-history-button'), deleteSelectedHistoryButton = document.getElementById('delete-selected-history-button'), loadSelectedHistoryButton = document.getElementById('load-selected-history-button');
    const sortBySelect = document.getElementById('sort-by-select'), sortOrderButton = document.getElementById('sort-order-button'), sortOrderIcon = document.getElementById('sort-order-icon');
    const pdfViewerModal = document.getElementById('pdf-viewer-modal'), closePdfViewerModal = document.getElementById('close-pdf-viewer-modal'), pdfFrame = document.getElementById('pdf-frame'), downloadPdfButton = document.getElementById('download-pdf-button');
    const ttsOnOff = document.getElementById('tts-on-off'), ttsVoiceSelect = document.getElementById('tts-voice-select'), ttsRateInput = document.getElementById('tts-rate-input'), ttsRateValue = document.getElementById('tts-rate-value'), ttsPitchInput = document.getElementById('tts-pitch-input'), ttsPitchValue = document.getElementById('tts-pitch-value'), ttsVolumeInput = document.getElementById('tts-volume-input'), ttsVolumeValue = document.getElementById('tts-volume-value');
    const tabNavigation = document.querySelector('.tab-navigation'), tabButtons = document.querySelectorAll('.tab-button'), tabPanes = document.querySelectorAll('.tab-pane');
    const headerProfileSelect = document.getElementById('header-profile-select'), profileSelect = document.getElementById('profile-select'), saveProfileButton = document.getElementById('save-profile-button'), saveAsNewProfileButton = document.getElementById('save-as-new-profile-button'), deleteProfileButton = document.getElementById('delete-profile-button');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentApiKey = '', currentConversationHistory = [], allChatSummaries = [], attachedImage = null, editingMessageElement = null, currentActiveSummaryData = null, currentChatUniqueId = null, currentSortBy = 'date', currentSortOrder = 'desc', ttsEnabled = true, selectedTtsVoice = null, availableVoices = [], ttsRate = 1.0, ttsPitch = 1.0, ttsVolume = 1.0;
    const PROFILES_KEY = 'myAIProfiles';

    // --- è¨­å®šä¿å­˜/èª­è¾¼é–¢æ•° (ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ) ---
    function saveCurrentProfileSettings() {
        const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}');
        const activeProfileName = profileSelect.value;
        if (!activeProfileName) return;
        const settings = { persona: personaTextarea.value.trim(), summaryPrompt: summaryPromptTextarea.value.trim(), userName: userNameInput.value.trim(), aiName: aiNameInput.value.trim(), soundEnabled: soundOnOff.checked, soundType: soundTypeSelect.value, ttsEnabled: ttsOnOff.checked, ttsVoiceName: ttsVoiceSelect.value, ttsRate: parseFloat(ttsRateInput.value), ttsPitch: parseFloat(ttsPitchInput.value), ttsVolume: parseFloat(ttsVolumeInput.value), chatHistorySortBy: currentSortBy, chatHistorySortOrder: currentSortOrder };
        if (!profilesData.profiles) profilesData.profiles = {};
        profilesData.profiles[activeProfileName] = settings;
        profilesData.activeProfile = activeProfileName;
        profilesData.apiKey = apiKeyInput.value.trim();
        try {
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
            console.log(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${activeProfileName}ã€ã«è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
        } catch (e) { console.error('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼:', e); }
    }

    function loadAllSettingsFromLocalStorage() {
        try {
            const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}');
            currentApiKey = profilesData.apiKey || '';
            apiKeyInput.value = currentApiKey;
            updateProfileSelector(profilesData.profiles || {}, profilesData.activeProfile);
            const activeProfileName = profilesData.activeProfile || profileSelect.value;
            const settings = profilesData.profiles ? profilesData.profiles[activeProfileName] : null;
            if (settings) {
                applySettingsToUI(settings);
                console.log(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${activeProfileName}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
                return true;
            }
        } catch (e) { console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼:', e); }
        initializeDefaultProfile();
        return false;
    }
    
    function applySettingsToUI(settings) {
        personaTextarea.value = settings.persona || '';
        summaryPromptTextarea.value = settings.summaryPrompt || '';
        userNameInput.value = settings.userName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        aiNameInput.value = settings.aiName || 'AI';
        soundOnOff.checked = typeof settings.soundEnabled === 'boolean' ? settings.soundEnabled : true;
        soundTypeSelect.value = settings.soundType || 'sine';
        ttsOnOff.checked = typeof settings.ttsEnabled === 'boolean' ? settings.ttsEnabled : true;
        ttsEnabled = ttsOnOff.checked;
        if (settings.ttsVoiceName) ttsVoiceSelect.value = settings.ttsVoiceName;
        ttsRate = settings.ttsRate !== undefined ? parseFloat(settings.ttsRate) : 1.0;
        ttsPitch = settings.ttsPitch !== undefined ? parseFloat(settings.ttsPitch) : 1.0;
        ttsVolume = settings.ttsVolume !== undefined ? parseFloat(settings.ttsVolume) : 1.0;
        ttsRateInput.value = ttsRate;
        ttsRateValue.textContent = ttsRate.toFixed(1);
        ttsPitchInput.value = ttsPitch;
        ttsPitchValue.textContent = ttsPitch.toFixed(1);
        ttsVolumeInput.value = ttsVolume;
        ttsVolumeValue.textContent = ttsVolume.toFixed(1);
        currentSortBy = settings.chatHistorySortBy || 'date';
        currentSortOrder = settings.chatHistorySortOrder || 'desc';
        sortBySelect.value = currentSortBy;
        sortOrderIcon.textContent = (currentSortOrder === 'asc' ? 'â†‘' : 'â†“');
        loadVoices();
    }

    function updateProfileSelector(profiles, activeProfileName) {
        [profileSelect, headerProfileSelect].forEach(selector => {
            selector.innerHTML = '';
            const profileNames = Object.keys(profiles);
            if (profileNames.length === 0) {
                selector.innerHTML = '<option value="">ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãªã—</option>';
                return;
            }
            profileNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === activeProfileName) option.selected = true;
                selector.appendChild(option);
            });
        });
    }

    function initializeDefaultProfile() {
        const defaultSettings = { persona: '', summaryPrompt: `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  "title": "ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)",\n  "summary": "ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)"\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---`, userName: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', aiName: 'AI', soundEnabled: true, soundType: 'sine', ttsEnabled: true, ttsVoiceName: '', ttsRate: 1.0, ttsPitch: 1.0, ttsVolume: 1.0, chatHistorySortBy: 'date', chatHistorySortOrder: 'desc' };
        const profilesData = { activeProfile: 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ', profiles: { 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': defaultSettings }, apiKey: '' };
        localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
        updateProfileSelector(profilesData.profiles, 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ');
        applySettingsToUI(defaultSettings);
    }
    
    function switchActiveProfile(profileName) {
        const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY));
        profilesData.activeProfile = profileName;
        localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
        applySettingsToUI(profilesData.profiles[profileName]);
        profileSelect.value = profileName;
        headerProfileSelect.value = profileName;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadAllSettingsFromLocalStorage();
        updateSpeechControlButtonVisibility();
        startNewChat(true); 
        tabPanes.forEach((pane, index) => pane.classList.toggle('active', index === 0));
        tabButtons.forEach((button, index) => button.classList.toggle('active', index === 0));
    });

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    newChatButton.addEventListener('click', () => startNewChat(false));
    saveChatSummaryButton.addEventListener('click', () => { if (checkApiKey()) createChatSummary(); });
    loadChatHistoryButton.addEventListener('click', () => { displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); chatHistoryListModal.style.display = 'block'; });
    printPdfButton.addEventListener('click', () => { if (currentActiveSummaryData) showPdfPreviewOfChatSummary(); else alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); });
    helpButton.addEventListener('click', showHelp);
    
    function sendMessage() { if (textInput.value.trim() !== '' || attachedImage) { if (!checkApiKey()) return; handleUserInput(textInput.value); textInput.value = ''; } }
    sendButton.addEventListener('click', sendMessage);
    textInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });

    textInput.addEventListener('paste', handlePaste);
    fileInputButton.addEventListener('click', () => imageFileInput.click());
    imageFileInput.addEventListener('change', handleFileSelect);
    removeImageButton.addEventListener('click', removeAttachedImage);
    
    settingsButton.addEventListener('click', () => { testKeyResult.textContent = ''; testKeyResult.className = ''; settingsModal.style.display = 'block'; });
    closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
    saveKeyButton.addEventListener('click', () => { currentApiKey = apiKeyInput.value.trim(); saveCurrentProfileSettings(); settingsModal.style.display = 'none'; alert('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚'); });
    testKeyButton.addEventListener('click', testApiKey);
    deleteKeyButton.addEventListener('click', () => { if (confirm('ç¾åœ¨ã®APIã‚­ãƒ¼è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) { currentApiKey = ''; apiKeyInput.value = ''; saveCurrentProfileSettings(); alert('APIã‚­ãƒ¼è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚'); testKeyResult.textContent = ''; testKeyResult.className = ''; } });

    personaButton.addEventListener('click', () => { personaModal.style.display = 'block'; loadVoices(); });
    closePersonaModal.addEventListener('click', () => personaModal.style.display = 'none');
    saveSettingsButton.addEventListener('click', () => personaModal.style.display = 'none');
    personaExampleBtns.forEach(btn => btn.addEventListener('click', () => { personaTextarea.value = btn.dataset.persona; }));
    
    saveProfileButton.addEventListener('click', () => { saveCurrentProfileSettings(); alert(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileSelect.value}ã€ã‚’ç¾åœ¨ã®è¨­å®šã§ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸã€‚`); });
    saveAsNewProfileButton.addEventListener('click', () => {
        const newProfileName = prompt('æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«');
        if (newProfileName && newProfileName.trim() !== '') {
            saveCurrentProfileSettings();
            const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY));
            const currentSettings = profilesData.profiles[profilesData.activeProfile];
            profilesData.profiles[newProfileName.trim()] = { ...currentSettings };
            profilesData.activeProfile = newProfileName.trim();
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
            updateProfileSelector(profilesData.profiles, profilesData.activeProfile);
            alert(`æ–°ã—ã„ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${newProfileName}ã€ã‚’ä½œæˆã—ã€ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`);
        }
    });
    deleteProfileButton.addEventListener('click', () => {
        const profileNameToDelete = profileSelect.value;
        if (!profileNameToDelete) return;
        const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY));
        if (Object.keys(profilesData.profiles).length <= 1) { alert('æœ€å¾Œã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚'); return; }
        if (confirm(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileNameToDelete}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            delete profilesData.profiles[profileNameToDelete];
            profilesData.activeProfile = Object.keys(profilesData.profiles)[0];
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
            loadAllSettingsFromLocalStorage();
            alert(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${profileNameToDelete}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        }
    });
    
    function handleProfileSwitch() { switchActiveProfile(this.value); alert(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€Œ${this.value}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`); }
    profileSelect.addEventListener('change', handleProfileSwitch);
    headerProfileSelect.addEventListener('change', handleProfileSwitch);

    resetSummaryPromptButton.addEventListener('click', () => { summaryPromptTextarea.value = `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  "title": "ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)",\n  "summary": "ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)"\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---`; alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); });

    exportCsvButton.addEventListener('click', exportSettingsAsCsv);
    importCsvInput.addEventListener('change', importSettingsFromCsv);
    exportAllHistoryButton.addEventListener('click', exportAllChatSummaries);
    importAllHistoryInput.addEventListener('change', importAllChatSummaries);
    importMdInput.addEventListener('change', importMarkdownFile);
    deleteSelectedButton.addEventListener('click', deleteSelectedMessages);
    editSelectedButton.addEventListener('click', openEditMessageModal);
    playSelectedButton.addEventListener('click', playSelectedMessages);
    stopSpeechButton.addEventListener('click', () => { window.speechSynthesis.cancel(); updateSpeechControlButtonVisibility(); });
    micButton.addEventListener('click', () => { if (!checkApiKey()) return; if (isRecording) recognition.stop(); else recognition.start(); });

    window.addEventListener('click', (event) => { if (event.target == personaModal) personaModal.style.display = 'none'; if (event.target == settingsModal) settingsModal.style.display = 'none'; if (event.target == editMessageModal) editMessageModal.style.display = 'none'; if (event.target == pdfViewerModal) { pdfViewerModal.style.display = 'none'; pdfFrame.src = ''; } });
    
    closeChatHistoryListModal.addEventListener('click', () => chatHistoryListModal.style.display = 'none');
    chatHistorySearchInput.addEventListener('input', () => displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder));
    sortBySelect.addEventListener('change', (event) => { currentSortBy = event.target.value; displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); });
    sortOrderButton.addEventListener('click', () => { currentSortOrder = (currentSortOrder === 'asc' ? 'desc' : 'asc'); sortOrderIcon.textContent = (currentSortOrder === 'asc' ? 'â†‘' : 'â†“'); displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); });
    selectAllHistoryButton.addEventListener('click', () => document.querySelectorAll('.history-item-checkbox').forEach(c => c.checked = true));
    deselectAllHistoryButton.addEventListener('click', () => document.querySelectorAll('.history-item-checkbox').forEach(c => c.checked = false));
    deleteSelectedHistoryButton.addEventListener('click', () => { const checked = document.querySelectorAll('.history-item-checkbox:checked'); if (checked.length === 0) { alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; } if (confirm(`${checked.length}ä»¶ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { const idsToDelete = Array.from(checked).map(c => c.dataset.chatid); allChatSummaries = allChatSummaries.filter(s => !idsToDelete.includes(s.chatId)); displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); alert(`${checked.length}ä»¶ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`); } });
    loadSelectedHistoryButton.addEventListener('click', () => { const checked = document.querySelectorAll('.history-item-checkbox:checked'); if (checked.length === 0) { alert('èª­ã¿è¾¼ã‚€é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; } let selected = []; checked.forEach(c => { const summary = allChatSummaries.find(s => s.chatId === c.dataset.chatid); if (summary) selected.push(summary); }); if (selected.length > 0) { selected.sort((a, b) => new Date(b.date) - new Date(a.date)); loadChatFromSummary(selected[0]); chatHistoryListModal.style.display = 'none'; alert(`ã€Œ${selected[0].title}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`); } });
    closePdfViewerModal.addEventListener('click', () => { pdfViewerModal.style.display = 'none'; pdfFrame.src = ''; });
    
    // --- ãƒãƒ£ãƒƒãƒˆé–¢é€£ã®é–¢æ•° ---
    function startNewChat(isInitial) { if (!isInitial && currentConversationHistory.length > 0) { if (!confirm("ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) return; } chatBox.innerHTML = ''; currentConversationHistory = []; saveChatSummaryButton.style.display = 'inline-flex'; loadChatHistoryButton.style.display = 'inline-flex'; printPdfButton.style.display = 'none'; newChatButton.style.display = 'inline-flex'; deleteSelectedButton.style.display = 'none'; editSelectedButton.style.display = 'none'; playSelectedButton.style.display = 'none'; stopSpeechButton.style.display = 'none'; currentActiveSummaryData = null; currentChatUniqueId = crypto.randomUUID(); removeAttachedImage(); if (isInitial && !currentApiKey) { addMessage("ã“ã‚“ã«ã¡ã¯ï¼ã€ŒAPIè¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚", 'bot'); speakText("ã“ã‚“ã«ã¡ã¯ï¼APIè¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"); } else { const userName = userNameInput.value || 'ã‚ãªãŸ'; const aiName = aiNameInput.value || 'AI'; const greetingMessage = `ã“ã‚“ã«ã¡ã¯ã€${userName}ã•ã‚“ï¼${aiName}ã§ã™ã€‚ä½•ã§ã‚‚è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚`; addMessage(greetingMessage, 'bot'); speakText(greetingMessage); } textInput.focus(); updateDeleteButtonVisibility(); }
    function handleUserInput(message) { if (!message.trim() && !attachedImage) return; addMessage(message, 'user', { image: attachedImage }); currentConversationHistory.push({ role: 'user', content: message, image: attachedImage, timestamp: new Date().toISOString() }); getAIResponse(); removeAttachedImage(); }
    async function getAIResponse() { if (!checkApiKey()) return; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${currentApiKey}`; const thinkingMessage = addMessage('è€ƒãˆä¸­...', 'bot'); let contents = currentConversationHistory.map(item => { const parts = []; if (item.content && item.content.trim() !== '') parts.push({ text: item.content }); if (item.role === 'user' && item.image) parts.push({ inlineData: { mimeType: item.image.mimeType, data: item.image.base64 } }); return { role: item.role === 'user' ? 'user' : 'model', parts: parts.length > 0 ? parts : [{ text: '' }] }; }); const requestBody = { contents }; const persona = personaTextarea.value.trim(); if (persona) requestBody.systemInstruction = { parts: [{ text: persona }] }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); if (thinkingMessage && thinkingMessage.parentNode) chatBox.removeChild(thinkingMessage); if (!response.ok) { const errorData = await response.json(); throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error?.message || JSON.stringify(errorData)}`); } const data = await response.json(); if (data.candidates?.[0]?.content?.parts?.[0]?.text) { const aiResponse = data.candidates[0].content.parts[0].text; addMessage(aiResponse, 'bot'); if (soundOnOff.checked) playNotificationSound(soundTypeSelect.value || 'sine'); speakText(aiResponse); currentConversationHistory.push({ role: 'assistant', content: aiResponse, timestamp: new Date().toISOString() }); } else { throw new Error("APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚"); } } catch (error) { console.error('Fetchã‚¨ãƒ©ãƒ¼:', error); if (thinkingMessage && thinkingMessage.parentNode) chatBox.removeChild(thinkingMessage); let errorMessage = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`; if (String(error.message).includes('429')) errorMessage = 'APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚'; addMessage(errorMessage, 'bot', { isError: true }); speakText(errorMessage); } }
    function addMessage(text, sender, options = {}) { const { isError = false, isSummary = false, timestamp = null, image = null } = options; const messageElement = document.createElement('div'); let messageClass = sender === 'user' ? 'user-message' : (isError ? 'error-message' : (isSummary ? 'summary-message' : 'bot-message')); messageElement.classList.add('message', messageClass); const messageTimestamp = timestamp ? new Date(timestamp) : new Date(); messageElement.dataset.id = messageTimestamp.getTime(); if (!isSummary) messageElement.addEventListener('click', () => { messageElement.classList.toggle('selected'); updateDeleteButtonVisibility(); }); if (image) { const imgElement = document.createElement('img'); if (image.base64 && image.mimeType) imgElement.src = `data:${image.mimeType};base64,${image.base64}`; else imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjBGMDg4Ii8+PHRleHQgeD0iMyIgeT0iMzgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiPuaOpeS4gTwvdGV4dD48L3RleHQ+PC9zdmc+'; imgElement.classList.add('message-image'); messageElement.appendChild(imgElement); } const textElement = document.createElement('div'); textElement.classList.add('message-content-text'); const urlRegex = /(?:^|(?<=\s))\[?(https?:\/\/[^\s]+?)(?:\]|\)|\.)?(?=\s|$)/g; let processedText = (text || '').replace(/\n/g, '<br>').replace(urlRegex, (match, url) => `<a href="${url.replace(/^[.,!?:;\]\)]+|[.,!?:;\]\)]+$/g, '')}" target="_blank">${url}</a>`); textElement.innerHTML = processedText; if(text || (!text && !image)) messageElement.appendChild(textElement); const timestampElement = document.createElement('div'); timestampElement.classList.add('timestamp'); timestampElement.textContent = formatTimestamp(messageTimestamp); messageElement.appendChild(timestampElement); chatBox.appendChild(messageElement); chatBox.scrollTop = chatBox.scrollHeight; return messageElement; }
    async function testApiKey() { const keyToTest = apiKeyInput.value.trim(); if (!keyToTest) { alert('ãƒ†ã‚¹ãƒˆã™ã‚‹APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; } testKeyResult.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...'; testKeyResult.className = ''; try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${keyToTest}`); if (response.ok) { testKeyResult.textContent = 'âœ… APIã‚­ãƒ¼ã¯æœ‰åŠ¹ã§ã™ã€‚'; testKeyResult.className = 'test-success'; } else { const errorData = await response.json(); testKeyResult.textContent = `âŒ ç„¡åŠ¹ãªAPIã‚­ãƒ¼ã§ã™: ${errorData.error.message}`; testKeyResult.className = 'test-failure'; } } catch (error) { console.error('APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error); testKeyResult.textContent = 'âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚'; testKeyResult.className = 'test-failure'; } }
    async function createChatSummary() { if (currentConversationHistory.length === 0) { alert('ä¿å­˜ã™ã‚‹ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; } let statusMessage = addMessage(`ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’åˆ†æã—ã¦ä¿å­˜ã—ã¦ã„ã¾ã™...`, 'bot'); try { const userName = userNameInput.value || 'ã‚ãªãŸ', aiName = aiNameInput.value || 'AI'; const conversationText = currentConversationHistory.filter(i => !i.image).map(i => `${i.role === 'user' ? userName : aiName}: ${i.content || ''}`).join('\n'); const today = new Date(), dateForSummaryData = today.toISOString(); const summaryPromptTemplate = summaryPromptTextarea.value.trim() || `...`; const summaryPrompt = summaryPromptTemplate.replace('{CONVERSATION_HISTORY}', conversationText); const summaryResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${currentApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: summaryPrompt }] }] }) }); if (!summaryResponse.ok) { const e = await summaryResponse.json(); throw new Error(`æ¦‚è¦ç”ŸæˆAPIã‚¨ãƒ©ãƒ¼: ${summaryResponse.status} - ${e.error?.message || JSON.stringify(e)}`); } const data = await summaryResponse.json(); let generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || ""; let title = 'ç„¡é¡Œã®ãƒãƒ£ãƒƒãƒˆ', summary = 'æ¦‚è¦ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚'; try { const clean = generatedText.replace(/```json\n?|\n?```/g, '').trim(); const parsed = JSON.parse(clean); if (parsed.title) title = parsed.title.trim(); if (parsed.summary) summary = parsed.summary.trim(); } catch (e) { console.warn("JSONè§£æå¤±æ•—:", e); title = generatedText.split('\n')[0] || title; summary = generatedText; } if (!currentChatUniqueId) currentChatUniqueId = crypto.randomUUID(); const safeTitle = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50); const downloadFilename = `${today.getFullYear()}${('0' + (today.getMonth() + 1)).slice(-2)}${('0' + today.getDate()).slice(-2)}_${safeTitle}.md`; const chatSummaryData = { chatId: currentChatUniqueId, title, summary, history: [...currentConversationHistory], date: dateForSummaryData, filename: downloadFilename }; downloadChatSummaryMarkdown(chatSummaryData, downloadFilename); if (statusMessage?.parentNode) statusMessage.remove(); saveChatSummaryToMemory(chatSummaryData); alert(`ãƒãƒ£ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${title}`); displayChatSummaryInChatBox(chatSummaryData); currentActiveSummaryData = chatSummaryData; printPdfButton.style.display = 'inline-flex'; } catch (error) { console.error('ãƒãƒ£ãƒƒãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error); if (statusMessage?.parentNode) { statusMessage.textContent = `ä¿å­˜ã«å¤±æ•—: ${error.message}`; statusMessage.className = 'message error-message'; } else addMessage(`ä¿å­˜ã«å¤±æ•—: ${error.message}`, 'bot', { isError: true }); } }
    function saveChatSummaryToMemory(d) { const i = allChatSummaries.findIndex(s => s.chatId === d.chatId); if (i > -1) allChatSummaries[i] = d; else allChatSummaries.push(d); }
    function displayChatSummaryInChatBox(d) { chatBox.innerHTML = ''; const f = document.createElement('div'); f.className = 'message summary-message'; f.innerHTML = `<h3>ãƒ•ã‚¡ã‚¤ãƒ«å: ${d.filename || 'ä¸æ˜'}</h3><p>ä¿å­˜æ—¥æ™‚: ${d.date ? formatTimestamp(new Date(d.date)) : 'ä¸æ˜'}</p>`; chatBox.appendChild(f); const s = document.createElement('div'); s.className = 'message summary-message'; s.innerHTML = `<h2>${d.title}</h2><p>${d.summary.replace(/\n/g, '<br>')}</p><hr><h3>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ (ä¿å­˜æ™‚)</h3>`; chatBox.appendChild(s); currentConversationHistory = d.history; d.history.forEach(i => addMessage(i.content, i.role === 'user' ? 'user' : 'bot', { timestamp: i.timestamp, image: i.image })); chatBox.scrollTop = chatBox.scrollHeight; updateDeleteButtonVisibility(); currentActiveSummaryData = d; printPdfButton.style.display = 'inline-flex'; }
    function displayChatHistoryList(term = '', sortBy = 'date', sortOrder = 'desc') { chatHistoryList.innerHTML = ''; const filtered = [...allChatSummaries].filter(s => (s.title || '').toLowerCase().includes(term.toLowerCase()) || (s.date ? formatTimestamp(new Date(s.date)) : '').toLowerCase().includes(term.toLowerCase()) || (s.chatId || '').toLowerCase().includes(term.toLowerCase())); filtered.sort((a, b) => { let compA, compB; if (sortBy === 'date') { compA = new Date(a.date); compB = new Date(b.date); } else { compA = a.title || ''; compB = b.title || ''; } let c = 0; if (compA > compB) c = 1; else if (compA < compB) c = -1; return sortOrder === 'asc' ? c : -c; }); if (filtered.length === 0) { chatHistoryList.innerHTML = `<li>ã€Œ${term}ã€ã«ä¸€è‡´ã™ã‚‹å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>`; return; } filtered.forEach(s => { const li = document.createElement('li'); if (!s.chatId) s.chatId = crypto.randomUUID(); li.innerHTML = `<input type="checkbox" class="history-item-checkbox" data-chatid="${s.chatId}"><div class="history-item-content"><div class="title">${s.title}</div><div class="date-time">${s.date ? formatTimestamp(new Date(s.date)) : 'ä¸æ˜'}</div></div>`; chatHistoryList.appendChild(li); }); }
    function loadChatFromSummary(d) { chatBox.innerHTML = ''; currentConversationHistory = d.history; displayChatSummaryInChatBox(d); updateDeleteButtonVisibility(); currentActiveSummaryData = d; currentChatUniqueId = d.chatId; printPdfButton.style.display = 'inline-flex'; }
    function downloadChatSummaryMarkdown(d, f) { let c = `# ${d.title}\n\n**ä¿å­˜æ—¥æ™‚:** ${formatTimestamp(new Date(d.date))}\n\n## æ¦‚è¦\n\n`; d.summary.replace(/<br>/g, '\n').split('\n').forEach(l => c += `> ${l}\n`); c += `\n---\n\n# ãƒãƒ£ãƒƒãƒˆå±¥æ­´\n\n`; const u = userNameInput.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', a = aiNameInput.value || 'AI'; d.history.forEach(i => { c += `**${i.role === 'user' ? u : a}** (${formatTimestamp(new Date(i.timestamp))}):\n`; if (i.image) c += `> (ç”»åƒæ·»ä»˜)\n`; if (i.content) i.content.split('\n').forEach(l => c += `> ${l}\n`); c += `\n`; }); downloadFile(c, f, 'text/markdown;charset=utf-8;'); }
    async function showPdfPreviewOfChatSummary() { if (!currentActiveSummaryData) return; const u = userNameInput.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', a = aiNameInput.value || 'AI'; let c = `<div style="font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; padding: 20px;"><h1 style="color: #2e8b57;">${currentActiveSummaryData.title}</h1><p><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${currentActiveSummaryData.filename}</p><p><strong>ä¿å­˜æ—¥æ™‚:</strong> ${formatTimestamp(new Date(currentActiveSummaryData.date))}</p><h2 style="color: #3cb371;">æ¦‚è¦</h2><p>${currentActiveSummaryData.summary.replace(/\n/g,'<br>')}</p><hr><h2 style="color: #3cb371;">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h2><div>`; currentActiveSummaryData.history.forEach(i => { c += `<div style="margin-bottom: 5px; padding: 8px 12px; border-radius: 8px; background-color: ${i.role === 'user' ? '#e0f0e0' : '#f0f0f0'};"><strong style="display: block;">${i.role === 'user' ? u : a}</strong>`; if (i.image?.base64) c += `<img src="data:${i.image.mimeType};base64,${i.image.base64}" alt="æ·»ä»˜ç”»åƒ" style="max-width: 80%; display: block; margin: 5px auto;"><br>`; else if (i.image) c += `<div>(ç”»åƒæ·»ä»˜)</div>`; if (i.content) c += `<div>${i.content.replace(/\n/g,'<br>')}</div>`; c += `<span style="font-size: 0.75em; color: #888;">(${formatTimestamp(new Date(i.timestamp))})</span></div>`; }); c += `</div></div>`; const o = { margin: 10, filename: `${currentActiveSummaryData.title}_${toDateString(new Date(currentActiveSummaryData.date))}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, dpi: 192, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; try { const e = document.createElement('div'); e.innerHTML = c; const w = html2pdf().from(e).set(o); const b = await w.toPdf().output('blob'); const url = URL.createObjectURL(b); pdfFrame.src = url; pdfViewerModal.style.display = 'block'; downloadPdfButton.onclick = () => { const l = document.createElement('a'); l.href = url; l.download = o.filename; document.body.appendChild(l); l.click(); document.body.removeChild(l); }; } catch (e) { console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e); alert(`PDFç”Ÿæˆã«å¤±æ•—: ${e.message}`); } }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let recognition, isRecording = false, finalTranscript = ''; if (SpeechRecognition) { recognition = new SpeechRecognition(); recognition.lang = 'ja-JP'; recognition.continuous = true; recognition.interimResults = false; recognition.onstart = () => { isRecording = true; finalTranscript = ''; micButton.classList.add('recording'); micButton.textContent = 'ğŸ™ï¸'; textInput.placeholder = 'éŒ²éŸ³ä¸­...'; }; recognition.onresult = (e) => { let t = ''; for (let i = e.results.length - 1; i >= 0; i--) if (e.results[i].isFinal) t += e.results[i][0].transcript; finalTranscript += t; }; recognition.onend = () => { isRecording = false; micButton.classList.remove('recording'); micButton.textContent = 'ğŸ¤'; textInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...'; if (finalTranscript.trim()) textInput.value += (textInput.value.length > 0 ? ' ' : '') + finalTranscript.trim(); textInput.focus(); }; recognition.onerror = (e) => { console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', e.error); if (isRecording) recognition.stop(); }; }
    function processImageFile(f) { if (!f.type.startsWith('image/')) { alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; } const r = new FileReader(); r.onload = (e) => { const d = e.target.result; imagePreview.src = d; imagePreviewContainer.style.display = 'block'; attachedImage = { base64: d.split(',')[1], mimeType: d.match(/:(.*?);/)[1] }; }; r.readAsDataURL(f); }
    function handlePaste(e) { const i = (e.clipboardData || window.clipboardData).items; for (const t of i) if (t.kind === 'file' && t.type.startsWith('image/')) { e.preventDefault(); processImageFile(t.getAsFile()); return; } }
    function handleFileSelect(e) { if (e.target.files?.[0]) processImageFile(e.target.files[0]); }
    function removeAttachedImage() { attachedImage = null; imagePreviewContainer.style.display = 'none'; imagePreview.src = ''; imageFileInput.value = ''; }
    function exportSettingsAsCsv() { const s = { persona: personaTextarea.value.trim(), summaryPrompt: summaryPromptTextarea.value.trim(), userName: userNameInput.value.trim(), aiName: aiNameInput.value.trim(), soundEnabled: soundOnOff.checked, soundType: soundTypeSelect.value, ttsEnabled: ttsOnOff.checked, ttsVoiceName: ttsVoiceSelect.value, ttsRate, ttsPitch, ttsVolume }; const r = ['"Key","Value"']; for (const k in s) { let v = s[k]; if (typeof v === 'string') v = v.replace(/\n/g, '\\n').replace(/"/g, '""'); r.push(`"${k}","${v}"`); } downloadFile(r.join('\n'), 'ai_settings_backup.csv', 'text/csv;charset=utf-8;'); alert('ç¾åœ¨ã®è¨­å®šã‚’CSVã§ä¿å­˜ã—ã¾ã—ãŸã€‚'); }
    function importSettingsFromCsv(e) { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (evt) => { try { const l = evt.target.result.split('\n'); if (l.length < 2) throw new Error("ä¸æ­£ãªCSVã§ã™ã€‚"); const s = {}; for (let i = 1; i < l.length; i++) { if (!l[i].trim()) continue; const p = l[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g); if (!p || p.length !== 2) continue; let k = p[0].replace(/^"|"$/g, '').replace(/""/g, '"'); let v = p[1].replace(/^"|"$/g, '').replace(/\\n/g, '\n').replace(/""/g, '"'); s[k] = v; } applySettingsToUI(s); alert('CSVã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nå¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); e.target.value = ''; } catch (err) { alert(`CSVèª­è¾¼å¤±æ•—: ${err.message}`); e.target.value = ''; } }; r.readAsText(f); }
    function exportAllChatSummaries() { if (allChatSummaries.length === 0) { alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; } const d = new Date(); downloadFile(JSON.stringify(allChatSummaries, null, 2), `my_chat_history_backup_${d.getFullYear()}${('0' + (d.getMonth() + 1)).slice(-2)}${('0' + d.getDate()).slice(-2)}.json`, 'application/json;charset=utf-8;'); alert('å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’JSONã§ä¿å­˜ã—ã¾ã—ãŸã€‚'); }
    function importAllChatSummaries(e) { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (evt) => { try { const imported = JSON.parse(evt.target.result); if (!Array.isArray(imported)) throw new Error("ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚"); if (confirm('æ—¢å­˜ã®å±¥æ­´ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå±¥æ­´ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ä¸Šæ›¸ãï¼‰')) { const merged = [...allChatSummaries]; imported.forEach(i => { if (!i.chatId) i.chatId = crypto.randomUUID(); const idx = merged.findIndex(s => s.chatId === i.chatId); if (idx > -1) merged[idx] = i; else merged.push(i); }); allChatSummaries = merged; alert('å±¥æ­´ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸã€‚'); } else { imported.forEach(s => { if (!s.chatId) s.chatId = crypto.randomUUID(); }); allChatSummaries = imported; alert('å±¥æ­´ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸã€‚'); } startNewChat(true); displayChatHistoryList('', currentSortBy, currentSortOrder); } catch (err) { alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ${err.message}`); } finally { e.target.value = ''; } }; r.readAsText(f); }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function importMarkdownFile(e) { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = async (evt) => { try { const p = parseMarkdownChatHistory(evt.target.result); if (p) { saveChatSummaryToMemory(p); displayChatHistoryList('', currentSortBy, currentSortOrder); alert(`ã€Œ${f.name}ã€ã‚’èª­ã¿è¾¼ã¿ã€å±¥æ­´ã«è¿½åŠ ã—ã¾ã—ãŸã€‚`); } else alert('Markdownã®è§£æã«å¤±æ•—ã€‚'); } catch (err) { alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${err.message}`); } finally { e.target.value = ''; } }; r.readAsText(f); }
    function parseMarkdownChatHistory(c) { let title = 'ç„¡é¡Œ', summary = '', dateIso = new Date().toISOString(), history = [], role = '', content = [], ts = '', hasImg = false; const u = userNameInput.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', a = aiNameInput.value || 'AI'; const l = c.split('\n'); let readSum = false, readHist = false; for (const line of l) { const t = line.trim(); if (t.startsWith('# ')) { if (t.startsWith('# ãƒãƒ£ãƒƒãƒˆå±¥æ­´')) { if (role && (content.length > 0 || hasImg)) history.push({ role, content: content.join('\n').trim(), timestamp: ts, image: hasImg ? { base64: null, mimeType: null } : null }); readSum = false; readHist = true; role = ''; content = []; ts = ''; hasImg = false; continue; } else if (!readHist && !readSum) { title = t.substring(2).trim(); continue; } } if (t.startsWith('**ä¿å­˜æ—¥æ™‚:** ')) { const m = t.substring(13).trim().match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/); if (m) dateIso = new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]), parseInt(m[4]), parseInt(m[5])).toISOString(); continue; } if (t.startsWith('## æ¦‚è¦')) { readSum = true; readHist = false; summary = ''; continue; } if (t === '---') { readSum = false; continue; } if (readSum && t.startsWith('> ')) { summary += t.substring(2) + '\n'; continue; } if (readHist) { const um = t.match(`^\\*\\*${escapeRegExp(u)}\\*\\* \\((\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2})\\):`); const am = t.match(`^\\*\\*${escapeRegExp(a)}\\*\\* \\((\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2})\\):`); if (um || am) { if (role && (content.length > 0 || hasImg)) history.push({ role, content: content.join('\n').trim(), timestamp: ts, image: hasImg ? { base64: null, mimeType: null } : null }); role = um ? 'user' : 'assistant'; const tsm = (um || am)[1].match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/); ts = tsm ? new Date(parseInt(tsm[1]), parseInt(tsm[2]) - 1, parseInt(tsm[3]), parseInt(tsm[4]), parseInt(tsm[5])).toISOString() : new Date().toISOString(); content = []; hasImg = false; } else if (t.startsWith('> ')) { const cp = t.substring(2); if (cp === '(ç”»åƒæ·»ä»˜)') hasImg = true; else content.push(cp); } } } if (role && (content.length > 0 || hasImg)) history.push({ role, content: content.join('\n').trim(), timestamp: ts, image: hasImg ? { base64: null, mimeType: null } : null }); summary = summary.trim() || 'æ¦‚è¦ãªã—'; const id = crypto.randomUUID(), safeT = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50); const d = new Date(dateIso); const fn = `${d.getFullYear()}${(d.getMonth() + 1).toString().padStart(2, '0')}${d.getDate().toString().padStart(2, '0')}_${safeT}.md`; return { chatId: id, title, summary, history, date: dateIso, filename: fn }; }
    function playNotificationSound(t = 'sine') { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(), o = ctx.createOscillator(), g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type = t; g.gain.setValueAtTime(0.1, ctx.currentTime); let f = 440; switch(t) { case 'square': f = 660; break; case 'sawtooth': f = 220; break; case 'triangle': f = 523; break; } o.frequency.setValueAtTime(f, ctx.currentTime); o.start(); o.stop(ctx.currentTime + 0.1); } catch (e) { console.error("ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿå¤±æ•—:", e); } }
    function updateCurrentDateTime() { const n = new Date(), y = n.getFullYear(), m = (n.getMonth() + 1).toString().padStart(2, '0'), d = n.getDate().toString().padStart(2, '0'), w = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][n.getDay()], h = n.getHours().toString().padStart(2, '0'), min = n.getMinutes().toString().padStart(2, '0'); datetimeDisplay.textContent = `${y}å¹´${m}æœˆ${d}æ—¥(${w}) ä»¤å’Œ${y-2018}å¹´ ${h}æ™‚${min}åˆ†`; } setInterval(updateCurrentDateTime, 60000); updateCurrentDateTime();
    function checkApiKey() { if (!currentApiKey) { alert('ã€ŒAPIè¨­å®šã€ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚'); settingsModal.style.display = 'block'; return false; } return true; }
    function downloadFile(c, f, t) { const b = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), c], { type: t }); const l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = f; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(l.href); }
    function toDateString(d) { return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`; }
    function formatTimestamp(d) { return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
    function showHelp() { const c = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>å–æ‰±èª¬æ˜æ›¸</title><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.7;margin:0;padding:25px;color:#333;background-color:#f9f9f9}.container{max-width:800px;margin:0 auto;background-color:#fff;padding:20px 30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative}h1{color:#2e8b57;border-bottom:3px solid #66cdaa;padding-bottom:10px}h2{color:#3cb371;border-bottom:2px solid #e0f2f1;padding-bottom:8px;margin-top:30px}ul{list-style:none;padding-left:0}li{margin-bottom:15px;padding-left:20px;position:relative}li::before{content:'âœ“';color:#3cb371;position:absolute;left:0;font-weight:bold}code{background-color:#eef;color:#d63384;padding:2px 6px;border-radius:4px}.important{background-color:#fffbe6;border:1px solid #ffeeba;border-left:5px solid #ffc107;padding:15px 20px;margin:20px 0;border-radius:5px}.close-help-button{position:absolute;top:15px;right:15px;background-color:#f44336;color:white;border:none;border-radius:50%;width:30px;height:30px;font-size:1.2em;cursor:pointer;display:flex;justify-content:center;align-items:center}</style></head><body><div class="container"><button class="close-help-button" onclick="window.close()">&times;</button><h1>å–æ‰±èª¬æ˜æ›¸</h1><p>AIã¨ã®å¯¾è©±ã‚’è¨˜éŒ²ãƒ»ç®¡ç†ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p><div class="important"><p><strong>ã€é‡è¦ã€‘</strong>ã€Œ<b>APIè¨­å®š</b>ã€ã‹ã‚‰ã”è‡ªèº«ã®Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p></div><div class="important"><p><strong>ã€é‡è¦ã€‘</strong>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚ã€Œ<b>å„ç¨®è¨­å®š</b>ã€ã‹ã‚‰JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ãƒ»èª­è¾¼ã—ã¦ãã ã•ã„ã€‚</p></div><h2>ä¸»ãªæ©Ÿèƒ½</h2><h3>1. AIã¨ã®ãƒãƒ£ãƒƒãƒˆ</h3><ul><li><b>ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åˆ‡æ›¿:</b> ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰è¨­å®š(ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«)ã‚’ç¬æ™‚ã«åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</li><li><b>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡:</b> <code>Enter</code>ã‚­ãƒ¼ã§é€ä¿¡ã€<code>Shift + Enter</code>ã§æ”¹è¡Œã€‚</li><li><b>ç”»åƒæ·»ä»˜:</b> ğŸ“ãƒœã‚¿ãƒ³ã‹ãƒšãƒ¼ã‚¹ãƒˆã§ç”»åƒã‚’æ·»ä»˜ã€‚</li></ul><h3>2. ä¿å­˜ã¨å±¥æ­´ç®¡ç†</h3><ul><li><b>ãƒãƒ£ãƒƒãƒˆä¿å­˜:</b> ç¾åœ¨ã®ä¼šè©±ã‚’åˆ†æã—ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</li><li><b>å±¥æ­´ä¸€è¦§:</b> éå»ã®ãƒãƒ£ãƒƒãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™(JSONã®èª­è¾¼ãŒå¿…è¦)ã€‚</li></ul><h3>3. å„ç¨®è¨­å®š</h3><ul><li>AIã®æ€§æ ¼ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç­‰ã‚’ã€Œãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€ã¨ã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã§ãã¾ã™ã€‚</li><li><b>ã€Œå…¨å±¥æ­´ã‚’JSONã§ä¿å­˜/èª­è¾¼ã€</b>ã§å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ãã¾ã™ã€‚</li></ul><h2>æ³¨æ„äº‹é …</h2><ul><li>ãƒãƒ£ãƒƒãƒˆå†…å®¹ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãªã„é™ã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã‚‹ã¨å¤±ã‚ã‚Œã¾ã™ã€‚</li><li>APIåˆ©ç”¨æ–™é‡‘ã¯ã”è‡ªèº«ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æº–ã˜ã¾ã™ã€‚</li></ul></div></body></html>`; const w = window.open('', '_blank'); w.document.write(c); w.document.close(); }
    function updateDeleteButtonVisibility() { const s = document.querySelectorAll('.message.selected'); deleteSelectedButton.style.display = s.length > 0 ? 'block' : 'none'; editSelectedButton.style.display = s.length === 1 ? 'block' : 'none'; playSelectedButton.style.display = s.length > 0 ? 'block' : 'none'; }
    function deleteSelectedMessages() { const s = document.querySelectorAll('.message.selected'); if (s.length === 0) return; if (confirm(`é¸æŠã—ãŸ ${s.length} ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { const ids = new Set(); s.forEach(m => { ids.add(m.dataset.id); m.remove(); }); currentConversationHistory = currentConversationHistory.filter(i => !ids.has(String(new Date(i.timestamp).getTime()))); updateDeleteButtonVisibility(); } }
    function openEditMessageModal() { const s = document.querySelector('.message.selected'); if (!s) return; editingMessageElement = s; editMessageTextarea.value = s.querySelector('.message-content-text')?.innerText || ''; editMessageModal.style.display = 'block'; }
    saveEditedMessageButton.addEventListener('click', () => { if (!editingMessageElement) return; const n = editMessageTextarea.value, id = editingMessageElement.dataset.id; const t = editingMessageElement.querySelector('.message-content-text'); if (t) t.innerHTML = n.replace(/\n/g, '<br>').replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>'); const idx = currentConversationHistory.findIndex(i => String(new Date(i.timestamp).getTime()) === id); if (idx !== -1) currentConversationHistory[idx].content = n; editingMessageElement.classList.remove('selected'); editingMessageElement = null; editMessageModal.style.display = 'none'; updateDeleteButtonVisibility(); });
    closeEditMessageModal.addEventListener('click', () => { editingMessageElement = null; editMessageModal.style.display = 'none'; });
    function playSelectedMessages() { if (!ttsEnabled || !window.speechSynthesis) return; window.speechSynthesis.cancel(); let text = Array.from(document.querySelectorAll('.message.selected')).sort((a, b) => parseInt(a.dataset.id) - parseInt(b.dataset.id)).map(m => m.querySelector('.message-content-text')?.textContent.trim() || (m.querySelector('.message-image') ? 'ï¼ˆç”»åƒï¼‰' : '')).filter(Boolean).join('ã€‚'); if (text) speakText(text); }
    function loadVoices() { if (!window.speechSynthesis) { ttsOnOff.disabled = true; return; } availableVoices = window.speechSynthesis.getVoices(); ttsVoiceSelect.innerHTML = ''; let defaultVoice = null; availableVoices.filter(v => v.lang.startsWith('ja')).forEach(v => { const o = document.createElement('option'); o.textContent = `${v.name} (${v.lang})`; o.value = v.name; ttsVoiceSelect.appendChild(o); if (v.default) defaultVoice = v.name; }); const d = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}'); const p = d.profiles ? d.profiles[d.activeProfile] : null; const vName = p ? p.ttsVoiceName : null; let sel = null; if (vName && availableVoices.some(v => v.name === vName)) sel = vName; else if (defaultVoice) sel = defaultVoice; if (sel) { ttsVoiceSelect.value = sel; selectedTtsVoice = availableVoices.find(v => v.name === sel); } }
    if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = loadVoices;
    function speakText(t) { if (!ttsEnabled || !window.speechSynthesis || !t.trim()) return; window.speechSynthesis.cancel(); let s = t.replace(/\p{Emoji}/gu, '').replace(/[*`]/g, ''); if (!s.trim()) return; const u = new SpeechSynthesisUtterance(s); u.lang = 'ja-JP'; if (selectedTtsVoice) u.voice = selectedTtsVoice; u.rate = ttsRate; u.pitch = ttsPitch; u.volume = ttsVolume; window.speechSynthesis.speak(u); updateSpeechControlButtonVisibility(); u.onend = () => updateSpeechControlButtonVisibility(); u.onerror = (e) => { console.error('TTSã‚¨ãƒ©ãƒ¼:', e.error); updateSpeechControlButtonVisibility(); }; }
    function updateSpeechControlButtonVisibility() { stopSpeechButton.style.display = window.speechSynthesis.speaking && ttsEnabled ? 'block' : 'none'; }
    function switchTab(e) { const t = e.target; if (!t.classList.contains('tab-button') || t.classList.contains('active')) return; document.querySelector('.tab-button.active')?.classList.remove('active'); document.querySelector('.tab-pane.active')?.classList.remove('active'); t.classList.add('active'); document.getElementById(t.dataset.tab)?.classList.add('active'); }
    tabNavigation.addEventListener('click', switchTab);
</script>

</body>
</html>
