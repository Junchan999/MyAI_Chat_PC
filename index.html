<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ＭｙAIChat_PC (プロファイル機能版)</title>
    <style>
        html {
            height: 100%;
        }
        body {
            height: 100vh;
            margin: 0;
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(to bottom, #e0fff0, #ffffff);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            flex-wrap: nowrap;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
            gap: 20px;
        }
        header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #2e8b57;
            font-weight: bold;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .header-profile-switcher {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            flex-grow: 1;
            min-width: 200px;
        }
        .header-profile-switcher label {
            font-size: 0.9em;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
        }
        .header-profile-switcher select {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 0.9em;
            max-width: 250px;
        }
        .header-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        .header-buttons {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
        }

        .header-buttons button,
        .modal-buttons button,
        .csv-buttons-container button,
        .csv-buttons-container label,
        .chat-history-list-footer button,
        .sort-controls button,
        #save-edited-message-button,
        #download-pdf-button,
        .tab-button {
            padding: 10px 18px;
            border: none;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            white-space: nowrap;
            min-width: 100px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }
        .header-buttons button:hover,
        .modal-buttons button:hover,
        .csv-buttons-container button:hover,
        .csv-buttons-container label:hover,
        .chat-history-list-footer button:hover,
        .sort-controls button:hover,
        #save-edited-message-button:hover,
        #download-pdf-button:hover,
        .tab-button:hover {
            opacity: 0.95;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        #persona-button,
        #load-chat-history-button,
        #new-chat-button,
        #settings-button,
        #help-button {
            background-color: #f0f0f0;
            color: #444;
            border: 1px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        #persona-button:hover,
        #load-chat-history-button:hover,
        #new-chat-button:hover,
        #settings-button:hover,
        #help-button:hover {
            background-color: #e0e0e0;
            color: #222;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        #delete-selected-button { background-color: #dc3545; }
        #edit-selected-button { background-color: #ffc107; color: #333; }
        #play-selected-button { background-color: #28a745; }
        #stop-speech-button { background-color: #6c757d; }
        #save-chat-summary-button { background-color: #007bff; }
        #print-pdf-button { background-color: #17a2b8; }


        .main-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 20px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            overflow: hidden;
        }

        #side-panel {
            width: 280px;
            min-width: 280px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #side-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            color: #2e8b57;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            flex-grow: 1;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #datetime-display {
            text-align: center;
            padding: 8px;
            background-color: rgba(240, 240, 240, 0.7);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 1.2em;
            color: #555;
            flex-shrink: 0;
        }
        .chat-box {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .message.selected { background-color: #ffebee; border: 1px solid #e57373; }
        .message img.message-image { max-width: 100%; border-radius: 10px; margin-bottom: 8px; }
        .user-message { background-color: #c8e6c9; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 5px; }
        .error-message { background-color: #f8d7da; color: #721c24; align-self: flex-start; }
        .summary-message { background-color: #fef9e7; align-self: center; width: 95%; max-width: 95%; border: 1px solid #fceecb; text-align: left; }
        .timestamp { font-size: 0.75em; color: #888; margin-top: 4px; }
        
        .input-area {
            display: flex;
            flex-direction: column;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            flex-grow: 1;
            min-height: 0;
        }
        #image-preview-container {
            position: relative;
            margin-bottom: 8px;
            display: none;
            width: fit-content;
        }
        #image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ddd; }
        #remove-image-button {
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            border-radius: 50%; border: none; background-color: rgba(0, 0, 0, 0.6);
            color: white; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center;
        }
        
        .input-controls { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .input-buttons-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 8px; 
            flex-wrap: wrap;
            align-items: flex-end;
        }
        #text-input {
            flex-grow: 1; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 12px; 
            padding: 10px 15px; 
            resize: vertical;
            font-family: inherit; 
            font-size: 1em;
            min-height: 120px;
        }
        #text-input:focus {
            outline: none; border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        #file-input-button, #mic-button, #send-button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 1.6em;
            line-height: 48px;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        #file-input-button:hover, #mic-button:hover, #send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #file-input-button { background-color: #4CAF50; }
        #mic-button { background-color: #007bff; }
        #mic-button.recording { background-color: #dc3545; }
        #send-button { background-color: #6f42c1; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content {
            background-color: #fefefe; margin: 2.5vh auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 800px;
            border-radius: 8px; display: flex; flex-direction: column;
            max-height: 95vh;
        }
        #settings-modal .modal-content { max-width: 500px; }
        #persona-modal .modal-content { max-width: 90vw; }
        .modal-body { overflow-y: auto; padding-right: 10px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content h2 { margin-top: 0; flex-shrink: 0; }
        .modal-content h3 { font-size: 1.1em; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .name-setting-container { display: flex; gap: 10px; align-items: center; }
        .name-setting-container label { flex-basis: 100px; }
        .name-setting-container input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        #persona-textarea, #summary-prompt-textarea, #api-key-input {
            width: 100%; margin-top: 10px; box-sizing: border-box; border-radius: 4px;
            border: 1px solid #ccc; padding: 8px; font-family: inherit;
        }
        #persona-textarea { height: 250px; resize: vertical; }
        #summary-prompt-textarea { height: 200px; resize: vertical; }
        #api-key-input { height: auto; }

        .examples-container { margin-top: 10px; }
        .examples-container button { margin-right: 5px; margin-bottom: 5px; }
        .modal-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 20px; flex-shrink: 0; }
        .settings-columns { display: flex; gap: 30px; flex-wrap: wrap; justify-content: space-between; }
        .settings-column { flex: 1; min-width: 320px; }
        .sound-settings div { margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .sound-settings label { min-width: 80px; white-space: nowrap; }
        .sound-settings input[type="range"] { flex-grow: 1; width: auto; }
        .sound-settings span { min-width: 30px; text-align: right; }
        #chat-history-list-modal .modal-content { max-width: 900px; }
        #chat-history-search-input { width: calc(100% - 20px); padding: 10px; margin: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        #chat-history-list { list-style: none; padding: 0; margin: 0 10px; border: 1px solid #eee; border-radius: 5px; overflow-y: auto; max-height: 60vh; margin-bottom: 10px; }
        #chat-history-list li { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s ease; display: flex; align-items: center; }
        #chat-history-list li:last-child { border-bottom: none; }
        #chat-history-list li:hover { background-color: #e8f5e9; }
        #chat-history-list li .history-item-content { flex-grow: 1; margin-left: 10px; }
        #chat-history-list li .title { font-weight: bold; color: #333; }
        #chat-history-list li .date-time { font-size: 0.8em; color: #666; margin-top: 4px; }
        .chat-history-list-footer { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-top: 1px solid #eee; flex-wrap: wrap; gap: 10px; }
        .chat-history-list-footer .left-buttons, .chat-history-list-footer .right-buttons { display: flex; gap: 10px; flex-wrap: nowrap; }
        .sort-controls { display: flex; align-items: center; gap: 5px; flex-wrap: nowrap; }
        .sort-controls label { white-space: nowrap; margin-right: 5px; }
        .sort-controls select { padding: 6px 8px; border-radius: 5px; border: 1px solid #ccc; background-color: #fff; font-size: 0.9em; }
        #save-settings-button, #test-key-button, #save-key-button { background-color: #28a745; min-width: 100px; }
        #delete-key-button { background-color: #dc3545; min-width: 100px; }
        .modal-buttons .right-buttons button { background-color: #28a745; }
        #test-key-button { background-color: #17a2b8; }
        .csv-buttons-container button, .csv-buttons-container label { background-color: #6f42c1; min-width: 150px; }
        #export-all-history-button { background-color: #20c997; }
        #import-csv-input, #import-all-history-input, #import-md-input { display: none; }
        .chat-history-list-footer .left-buttons, .chat-history-list-footer .right-buttons { display: flex; gap: 10px; flex-wrap: nowrap; }
        .chat-history-list-footer button { min-width: 120px; }
        #select-all-history-button { background-color: #007bff; }
        #deselect-all-history-button { background-color: #6c757d; }
        #load-selected-history-button { background-color: #28a745; }
        #delete-selected-history-button { background-color: #dc3545; }
        .sort-controls button { background-color: #6c757d; min-width: unset; padding: 8px 12px; border-radius: 20px; }
        .sort-controls button:hover { background-color: #5a6268; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #download-pdf-button { background-color: #007bff; }
        .sort-order-icon { font-size: 1.1em; vertical-align: middle; }
        .tab-navigation { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; flex-wrap: wrap; gap: 5px; }
        .tab-button { padding: 10px 15px; border: none; background-color: #f0f0f0; color: #555; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; transition: background-color 0.3s ease, color 0.3s ease; border: 1px solid #ddd; border-bottom: none; box-shadow: none; margin-right: -1px; min-width: unset; }
        .tab-button:hover { background-color: #e0e0e0; color: #333; transform: none; box-shadow: none; z-index: 1; }
        .tab-button.active { background-color: #fff; color: #2e8b57; border-color: #2e8b57; border-bottom-color: #fff; position: relative; z-index: 2; }
        .tab-body { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .tab-pane { display: none; padding: 10px 0; }
        .tab-pane.active { display: block; }

        @media (max-width: 1250px) { .main-container { flex-direction: column; align-items: center; gap: 10px; padding: 10px; overflow-y: auto; } #side-panel { order: -2; width: 100%; max-width: 600px; margin-bottom: 10px; } header { flex-wrap: wrap; } .header-profile-switcher { margin-left: 0; width: 100%; order: 3; } .header-controls { justify-content: flex-end; } header h1 { font-size: 1.2em; } }
        @media (max-width: 768px) { body { font-size: 0.9em; } header { padding: 8px 10px; flex-direction: column; align-items: flex-start; gap: 5px; } header h1 { font-size: 1.3em; margin-bottom: 5px; } .header-profile-switcher { width: 100%; justify-content: space-between; margin-bottom: 10px; } .header-profile-switcher select { flex-grow: 1; } .header-controls { width: 100%; justify-content: center; } .header-buttons { flex-wrap: wrap; justify-content: center; gap: 8px; } .header-buttons button { padding: 8px 15px; font-size: 0.9em; min-width: unset; border-radius: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); } .main-container { gap: 15px; padding: 10px; } #side-panel { width: 100%; max-width: 95%; padding: 15px; } .chat-container { width: 100%; max-width: 95%; } .message { max-width: 90%; padding: 8px 12px; font-size: 0.95em; } .timestamp { font-size: 0.7em; } #text-input { min-height: 100px; } .modal-content { width: calc(100% - 20px); margin: 10px auto; padding: 15px; max-height: 98vh; } #settings-modal .modal-content, #persona-modal .modal-content, #chat-history-list-modal .modal-content, #pdf-viewer-modal .modal-content { max-width: 95vw; } .modal-body { padding-right: 0; } .tab-navigation { flex-direction: column; align-items: stretch; } .tab-button { border-radius: 8px; margin-right: 0; margin-bottom: 5px; border-bottom: 1px solid #ddd; } .tab-button.active { border-bottom: 1px solid #2e8b57; } .settings-columns { flex-direction: column; gap: 15px; } .name-setting-container { flex-direction: column; align-items: flex-start; } .name-setting-container label { flex-basis: 100%; width: 100%; margin-bottom: 5px; } .csv-buttons-container { flex-direction: column; gap: 10px; align-items: stretch; } .csv-buttons-container button, .csv-buttons-container label { width: 100%; box-sizing: border-box; min-width: unset; } .sound-settings div { flex-wrap: wrap; } .sound-settings label { flex-basis: 100%; } #chat-history-search-input { width: calc(100% - 20px); margin: 10px 0; } #chat-history-list { max-height: 50vh; } .chat-history-list-footer { flex-direction: column; align-items: stretch; gap: 10px; } .chat-history-list-footer .left-buttons, .chat-history-list-footer .right-buttons, .sort-controls { width: 100%; justify-content: space-between; flex-wrap: wrap; gap: 5px; } .chat-history-list-footer button, .sort-controls select, .sort-controls button { flex-grow: 1; flex-basis: calc(50% - 5px); box-sizing: border-box; min-width: unset; text-align: center; } .sort-controls label { flex-basis: 100%; text-align: left; } .sort-controls select, .sort-controls button { flex-basis: calc(50% - 5px); } }
        @media (max-width: 480px) { header h1 { font-size: 1.1em; } .header-buttons button { font-size: 0.85em; padding: 6px 12px; } .main-container { padding: 5px; } #side-panel, .chat-container { padding: 10px; } .message { max-width: 95%; } #file-input-button, #mic-button, #send-button { width: 40px; height: 40px; font-size: 1.2em; line-height: 40px; } .modal-content { width: calc(100% - 10px); margin: 5px auto; padding: 10px; } .chat-history-list-footer .left-buttons button, .chat-history-list-footer .right-buttons button, .sort-controls select, .sort-controls button { flex-basis: 100%; } }
        @media print { body { margin: 0; padding: 0; } header, #side-panel, .input-area, .modal, .chat-history-list-footer { display: none !important; } .main-container { display: block; padding: 0; margin: 0; } .chat-container { border: none; box-shadow: none; max-width: none; width: 100%; background-color: #fff; backdrop-filter: none; overflow: visible; } #datetime-display { display: none; } .chat-box { overflow: visible; padding: 10px; } .message, .chat-log .message { box-shadow: none; border: 1px solid #eee; margin-bottom: 5px; padding: 8px 12px; border-radius: 8px; max-width: 100%; word-wrap: break-word; page-break-inside: avoid; } .user-message { background-color: #e0f0e0; text-align: left; margin-left: 0; border-bottom-right-radius: 8px; border-bottom-left-radius: 5px;} .bot-message { background-color: #f0f0f0; text-align: left; border-bottom-left-radius: 5px;} .chat-log .speaker { font-weight: bold; margin-bottom: 0px; display: block; } .chat-log .timestamp { font-size: 0.75em; color: #666; margin-top: 2px; display: block; text-align: right;} .message-content { margin-top: 2px; } .summary-message { background-color: #fff8e6; border: 1px solid #ffeeba; text-align: left; margin: 10px 0; } .summary-message h3 { font-size: 1.1em; margin-top: 0; margin-bottom: 5px; border-bottom: none; } .summary-message h2 { font-size: 1.4em; margin-top: 10px; margin-bottom: 5px; border-bottom: none; } .summary-message p { margin-top: 5px; margin-bottom: 0; } h1, h2, h3 { color: #2e8b57; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; } hr { border: 0; border-top: 1px dashed #ccc; margin: 15px 0; } .message-image { max-width: 80%; height: auto; border-radius: 5px; margin-top: 5px; display: block; margin-left: auto; margin-right: auto; } .chat-log { padding: 10px 0; } }
    </style>
</head>
<body>

<header>
    <h1>MyAI Chat History Ver2.60</h1>
    <div class="header-profile-switcher">
        <label for="header-profile-select">プロファイル:</label>
        <select id="header-profile-select"></select>
    </div>
    <div class="header-controls">
        <div class="header-buttons">
            <button id="persona-button">各種設定</button>
            <button id="delete-selected-button" style="display: none;">選択を削除</button>
            <button id="edit-selected-button" style="display: none;">選択を編集</button>
            <button id="play-selected-button" style="display: none;">選択を再生</button>
            <button id="stop-speech-button" style="display: none;">音声停止</button>
            <button id="save-chat-summary-button">チャット保存</button>
            <button id="load-chat-history-button">履歴一覧</button>
            <button id="print-pdf-button" style="display: none;">PDFプレビュー</button>
            <button id="new-chat-button">新しいチャット</button>
            <button id="settings-button">API設定</button>
            <button id="help-button">取扱説明書</button>
        </div>
    </div>
</header>

<input type="file" id="image-file-input" style="display: none;" accept="image/*">
<input type="file" id="import-csv-input" style="display: none;" accept=".csv">
<input type="file" id="import-all-history-input" style="display: none;" accept=".json">
<input type="file" id="import-md-input" style="display: none;" accept=".md">


<div class="main-container">
    <div class="chat-container">
        <div id="datetime-display"></div>
        <div class="chat-box" id="chat-box"></div>
    </div>
    
    <div id="side-panel">
        <div class="input-area">
            <div id="image-preview-container">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-button">&times;</button>
            </div>
            <div class="input-controls">
                <div class="input-buttons-container">
                    <button id="file-input-button" title="画像を選択">📎</button>
                    <button id="mic-button" title="音声入力">🎤</button>
                    <button id="send-button" title="メッセージを送信">✈️</button>
                </div>
                <textarea id="text-input" placeholder="メッセージを入力または画像をペースト... (Shift+Enterで改行)"></textarea>
            </div>
        </div>
        <p style="font-size: 0.8em; color: #777; margin-top: 10px; text-align: center;">※ チャット履歴と設定はPCファイルで保存・読込されます。</p>
        <p style="font-size: 0.8em; color: #777; margin-top: 5px; text-align: center;">※ APIキーはセッションごとに入力が必要です。</p>
    </div>
</div>

<!-- 各種設定モーダル -->
<div id="persona-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-persona-modal">&times;</span>
        <h2>各種設定</h2>

        <div id="profile-manager" style="background-color: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #d1eaff;">
            <h3 style="margin-top:0; color:#005a9c;">設定プロファイル</h3>
            <p style="font-size: 0.9em; color: #666; margin-top: 0; margin-bottom: 10px;">
                設定の組み合わせを「プロファイル」として保存し、切り替えることができます。設定の保存はここで行います。
            </p>
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <label for="profile-select" style="font-weight: bold;">現在のプロファイル:</label>
                <select id="profile-select" style="padding: 8px; border-radius: 4px; border: 1px solid #ccc; flex-grow: 1; min-width: 150px;"></select>
                <button id="save-profile-button" class="modal-profile-button" style="background-color: #28a745;" title="現在の設定を、選択中のプロファイルに上書き保存します。">💾 現設定を保存</button>
                <button id="save-as-new-profile-button" class="modal-profile-button" style="background-color: #007bff;" title="現在の設定を、新しい名前のプロファイルとして保存します。">➕ 新規保存</button>
                <button id="delete-profile-button" class="modal-profile-button" style="background-color: #dc3545;" title="選択中のプロファイルを削除します。">🗑️ 削除</button>
            </div>
        </div>
        <style>
            .modal-profile-button {
                padding: 8px 15px; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; transition: opacity 0.2s;
            }
            .modal-profile-button:hover { opacity: 0.85; }
        </style>

        <div class="tab-navigation">
            <button class="tab-button active" data-tab="history-file-management">履歴ファイル管理</button>
            <button class="tab-button" data-tab="ai-response-settings">AI応答設定</button>
            <button class="tab-button" data-tab="app-behavior-settings">アプリ動作設定</button>
        </div>

        <div class="modal-body tab-body">
            <div id="history-file-management" class="tab-pane active">
                <h3>全チャット履歴のエクスポート/インポート</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    「全履歴をJSONで保存」で全てのチャット履歴をファイルに保存し、「全履歴をJSONから読込」で保存したファイルを読み込みます。<br>
                    これにより、アプリ起動時に履歴が表示されるようになります。
                </p>
                <div class="csv-buttons-container">
                    <button id="export-all-history-button" style="background-color: #20c997;">全履歴をJSONで保存</button>
                    <label for="import-all-history-input" style="background-color: #6f42c1;">全履歴をJSONから読込</label>
                </div>
                <hr style="margin-top:20px; border-top:1px dashed #eee;">
                <h3>MDファイルからのチャット履歴インポート</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    「チャット保存」で作成したMarkdown (.md) ファイルを読み込み、履歴リストに追加します。
                </p>
                <div class="csv-buttons-container">
                    <label for="import-md-input" id="import-md-button" style="background-color: #6f42c1;">MDファイルを読込</label>
                </div>
            </div>

            <div id="ai-response-settings" class="tab-pane">
                <div class="settings-columns">
                    <div class="settings-column">
                        <h3>AIの性格（ペルソナ_メタプロンプト）</h3>
                        <p>AIの振る舞いを指定する指示を入力してください。</p>
                        <textarea id="persona-textarea" placeholder="例：あなたは親切でフレンドリーなアシスタントです。絵文字をたくさん使って、ユーザーを励ましてください。"></textarea>
                        <div class="examples-container">
                            <p>設定例:</p>
                            <button class="persona-example-btn" data-persona="あなたはユーザーをサポートする、親切で優しいアシスタントです。常に丁寧な言葉遣いを心がけてください。">優しいアシスタント</button>
                            <button class="persona-example-btn" data-persona="あなたは特定の分野の専門家です。質問に対して、専門用語を交えつつ、常に簡潔かつ正確に答えてください。">簡潔な専門家</button>
                            <button class="persona-example-btn" data-persona="あんたは関西弁を話す、気さくな友達やで。タメ口で、たまに冗談を交えながら返事してな。">関西弁の友達</button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h3>チャット概要生成プロンプト</h3>
                        <p>チャット保存時の概要生成AIへの指示です。<br><code>{CONVERSATION_HISTORY}</code>に会話履歴が挿入されます。</p>
                        <textarea id="summary-prompt-textarea" placeholder="例：以下の会話履歴を基に、簡潔なタイトル（30文字程度）と、会話の要約を箇条書きにして作成し、JSON形式で出力してください。\n\n出力は以下のJSONフォーマットに従ってください。\n{\n  &quot;title&quot;: &quot;ここにタイトルを記述 (15文字程度)&quot;,\n  &quot;summary&quot;: &quot;ここに会話の要約を記述 (第三者の視点から自然な文章で)&quot;\n}\n\n---\n[会話履歴]\n{CONVERSATION_HISTORY}\n---"></textarea>
                        <button id="reset-summary-prompt-button" style="margin-top: 10px; background-color: #6c757d; color: white; padding: 10px 18px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.15); white-space: nowrap;">デフォルトに戻す</button>
                        <h3>会話履歴の名前設定</h3>
                        <div class="name-setting-container" style="margin-bottom: 10px;"><label for="user-name-input">あなたの名前:</label><input type="text" id="user-name-input" placeholder="ユーザー"></div>
                        <div class="name-setting-container"><label for="ai-name-input">AIの名前:</label><input type="text" id="ai-name-input" placeholder="AI"></div>
                    </div>
                </div>
            </div>

            <div id="app-behavior-settings" class="tab-pane">
                <div class="settings-columns">
                    <div class="settings-column">
                        <h3>サウンド設定</h3>
                        <div class="sound-settings">
                            <div><input type="checkbox" id="sound-on-off" checked><label for="sound-on-off">AI応答時にサウンドを鳴らす</label></div>
                            <div><label for="sound-type-select">サウンドの種類:</label><select id="sound-type-select"><option value="sine">サイン波 (標準)</option><option value="square">矩形波 (ピコピコ)</option><option value="sawtooth">のこぎり波 (ブザー)</option><option value="triangle">三角波 (マイルド)</option></select></div>
                        </div>
                    </div>
                    <div class="settings-column">
                        <div class="sound-settings" style="margin-top: 0;">
                            <div><input type="checkbox" id="tts-on-off" checked><label for="tts-on-off">AI応答を音声で読み上げる</label></div>
                            <div><label for="tts-voice-select">音声の種類:</label><select id="tts-voice-select"></select></div>
                            <div><label for="tts-rate-input">速度:</label><input type="range" id="tts-rate-input" min="0.1" max="2" step="0.1" value="1"><span id="tts-rate-value">1.0</span></div>
                            <div><label for="tts-pitch-input">ピッチ:</label><input type="range" id="tts-pitch-input" min="0" max="2" step="0.1" value="1"><span id="tts-pitch-value">1.0</span></div>
                            <div><label for="tts-volume-input">音量:</label><input type="range" id="tts-volume-input" min="0" max="1" step="0.1" value="1"><span id="tts-volume-value">1.0</span></div>
                        </div>
                    </div>
                </div>
                <hr style="margin-top:20px; border-top:1px dashed #eee;">
                <p style="font-size: 0.9em; color: #666; margin-top: 20px; margin-bottom: 10px;">
                    現在アクティブなプロファイルの設定をCSVファイルとして保存/読込します。<br>
                    プロファイル全体のバックアップには向きません。
                </p>
                <div class="csv-buttons-container">
                    <button id="export-csv-button" style="background-color: #6f42c1;">現設定をCSVで保存</button>
                    <label for="import-csv-input" id="import-csv-button" style="background-color: #6f42c1;">設定をCSVから読込</label>
                </div>
            </div>
        </div>

        <div class="modal-buttons">
            <div></div>
            <div class="right-buttons"><button id="save-settings-button">閉じる</button></div>
        </div>
    </div>
</div>

<!-- APIキー設定モーダル -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-settings-modal">&times;</span>
        <h2>Gemini APIキー設定</h2>
        <div class="modal-body">
            <p>ここに取得したGemini APIキーを入力してください。</p>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                ※ APIキーはブラウザに保存されます。共用のPCなどではご注意ください。ブラウザのキャッシュをクリアすると削除される場合があります。
            </p>
            <input type="password" id="api-key-input" placeholder="APIキーを入力...">
            <div id="test-key-result"></div>
        </div>
        <div class="modal-buttons">
            <button id="delete-key-button">キーをクリア</button>
            <div class="right-buttons"><button id="test-key-button">APIキーをテスト</button><button id="save-key-button">設定</button></div>
        </div>
    </div>
</div>

<!-- メッセージ編集モーダル -->
<div id="edit-message-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-edit-message-modal">&times;</span>
        <h2>メッセージの編集</h2>
        <div class="modal-body">
            <textarea id="edit-message-textarea" style="width: 100%; height: 150px; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
            <button id="save-edited-message-button">保存</button>
        </div>
    </div>
</div>

<!-- チャット履歴リストモーダル -->
<div id="chat-history-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-chat-history-list-modal">&times;</span>
        <h2>チャット履歴一覧</h2>
        <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
            このリストはアプリ起動時に自動で読み込まれません。「各種設定」からJSONファイルを読み込んでください。<br>
            ここでの変更（読み込み、削除）は、再度JSONファイルにエクスポートしないと保存されません。
        </p>
        <input type="text" id="chat-history-search-input" placeholder="タイトルや日付で検索...">
        <ul id="chat-history-list"></ul>
        <div class="chat-history-list-footer">
            <div class="left-buttons"><button id="select-all-history-button">全選択</button><button id="deselect-all-history-button">全解除</button><button id="load-selected-history-button">選択を読込</button></div>
            <div class="sort-controls"><label for="sort-by-select">並べ替え:</label><select id="sort-by-select"><option value="date">日付</option><option value="title">タイトル</option></select><button id="sort-order-button"><span id="sort-order-icon" class="sort-order-icon">↓</span></button></div>
            <div class="right-buttons"><button id="delete-selected-history-button">選択を削除</button></div>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdf-viewer-modal" class="modal">
    <div class="modal-content" style="max-width: 90%; height: 90vh;">
        <span class="close-button" id="close-pdf-viewer-modal">&times;</span>
        <h2>PDFプレビュー</h2>
        <div class="modal-body" style="flex-grow: 1; display: flex; flex-direction: column;">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                <strong>💡ご注意:</strong> 正しいファイル名でダウンロードするには、下の「PDFをダウンロード」ボタンを使用してください。<br>
                ブラウザのPDFビューアが提供するダウンロードボタンでは、ファイル名が意図しないものになる場合があります。
            </p>
            <iframe id="pdf-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="modal-buttons"><button id="download-pdf-button">PDFをダウンロード</button></div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // DOM要素の取得
    const chatBox = document.getElementById('chat-box'), textInput = document.getElementById('text-input'), sendButton = document.getElementById('send-button'), micButton = document.getElementById('mic-button'), saveChatSummaryButton = document.getElementById('save-chat-summary-button'), loadChatHistoryButton = document.getElementById('load-chat-history-button'), printPdfButton = document.getElementById('print-pdf-button'), newChatButton = document.getElementById('new-chat-button'), helpButton = document.getElementById('help-button'), datetimeDisplay = document.getElementById('datetime-display'), imageFileInput = document.getElementById('image-file-input'), fileInputButton = document.getElementById('file-input-button'), imagePreviewContainer = document.getElementById('image-preview-container'), imagePreview = document.getElementById('image-preview'), removeImageButton = document.getElementById('remove-image-button'), userNameInput = document.getElementById('user-name-input'), aiNameInput = document.getElementById('ai-name-input'), deleteSelectedButton = document.getElementById('delete-selected-button'), editSelectedButton = document.getElementById('edit-selected-button'), playSelectedButton = document.getElementById('play-selected-button'), stopSpeechButton = document.getElementById('stop-speech-button');
    const personaButton = document.getElementById('persona-button'), personaModal = document.getElementById('persona-modal'), closePersonaModal = document.getElementById('close-persona-modal'), personaTextarea = document.getElementById('persona-textarea'), saveSettingsButton = document.getElementById('save-settings-button'), personaExampleBtns = document.querySelectorAll('.persona-example-btn'), settingsButton = document.getElementById('settings-button'), settingsModal = document.getElementById('settings-modal'), closeSettingsModal = document.getElementById('close-settings-modal'), apiKeyInput = document.getElementById('api-key-input'), saveKeyButton = document.getElementById('save-key-button'), soundOnOff = document.getElementById('sound-on-off'), soundTypeSelect = document.getElementById('sound-type-select'), testKeyButton = document.getElementById('test-key-button'), deleteKeyButton = document.getElementById('delete-key-button'), testKeyResult = document.getElementById('test-key-result'), summaryPromptTextarea = document.getElementById('summary-prompt-textarea'), resetSummaryPromptButton = document.getElementById('reset-summary-prompt-button');
    const importCsvInput = document.getElementById('import-csv-input'), exportCsvButton = document.getElementById('export-csv-button'), exportAllHistoryButton = document.getElementById('export-all-history-button'), importAllHistoryInput = document.getElementById('import-all-history-input'), importMdInput = document.getElementById('import-md-input');
    const editMessageModal = document.getElementById('edit-message-modal'), closeEditMessageModal = document.getElementById('close-edit-message-modal'), editMessageTextarea = document.getElementById('edit-message-textarea'), saveEditedMessageButton = document.getElementById('save-edited-message-button');
    const chatHistoryListModal = document.getElementById('chat-history-list-modal'), closeChatHistoryListModal = document.getElementById('close-chat-history-list-modal'), chatHistoryList = document.getElementById('chat-history-list'), chatHistorySearchInput = document.getElementById('chat-history-search-input'), selectAllHistoryButton = document.getElementById('select-all-history-button'), deselectAllHistoryButton = document.getElementById('deselect-all-history-button'), deleteSelectedHistoryButton = document.getElementById('delete-selected-history-button'), loadSelectedHistoryButton = document.getElementById('load-selected-history-button');
    const sortBySelect = document.getElementById('sort-by-select'), sortOrderButton = document.getElementById('sort-order-button'), sortOrderIcon = document.getElementById('sort-order-icon');
    const pdfViewerModal = document.getElementById('pdf-viewer-modal'), closePdfViewerModal = document.getElementById('close-pdf-viewer-modal'), pdfFrame = document.getElementById('pdf-frame'), downloadPdfButton = document.getElementById('download-pdf-button');
    const ttsOnOff = document.getElementById('tts-on-off'), ttsVoiceSelect = document.getElementById('tts-voice-select'), ttsRateInput = document.getElementById('tts-rate-input'), ttsRateValue = document.getElementById('tts-rate-value'), ttsPitchInput = document.getElementById('tts-pitch-input'), ttsPitchValue = document.getElementById('tts-pitch-value'), ttsVolumeInput = document.getElementById('tts-volume-input'), ttsVolumeValue = document.getElementById('tts-volume-value');
    const tabNavigation = document.querySelector('.tab-navigation'), tabButtons = document.querySelectorAll('.tab-button'), tabPanes = document.querySelectorAll('.tab-pane');
    const headerProfileSelect = document.getElementById('header-profile-select'), profileSelect = document.getElementById('profile-select'), saveProfileButton = document.getElementById('save-profile-button'), saveAsNewProfileButton = document.getElementById('save-as-new-profile-button'), deleteProfileButton = document.getElementById('delete-profile-button');

    // グローバル変数
    let currentApiKey = '', currentConversationHistory = [], allChatSummaries = [], attachedImage = null, editingMessageElement = null, currentActiveSummaryData = null, currentChatUniqueId = null, currentSortBy = 'date', currentSortOrder = 'desc', ttsEnabled = true, selectedTtsVoice = null, availableVoices = [], ttsRate = 1.0, ttsPitch = 1.0, ttsVolume = 1.0;
    const PROFILES_KEY = 'myAIProfiles';

    // --- 設定保存/読込関数 (プロファイル対応) ---
    function saveCurrentProfileSettings() {
        const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}');
        const activeProfileName = profileSelect.value;
        if (!activeProfileName) return;
        const settings = { persona: personaTextarea.value.trim(), summaryPrompt: summaryPromptTextarea.value.trim(), userName: userNameInput.value.trim(), aiName: aiNameInput.value.trim(), soundEnabled: soundOnOff.checked, soundType: soundTypeSelect.value, ttsEnabled: ttsOnOff.checked, ttsVoiceName: ttsVoiceSelect.value, ttsRate: parseFloat(ttsRateInput.value), ttsPitch: parseFloat(ttsPitchInput.value), ttsVolume: parseFloat(ttsVolumeInput.value), chatHistorySortBy: currentSortBy, chatHistorySortOrder: currentSortOrder };
        if (!profilesData.profiles) profilesData.profiles = {};
        profilesData.profiles[activeProfileName] = settings;
        profilesData.activeProfile = activeProfileName;
        profilesData.apiKey = apiKeyInput.value.trim();
        try {
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
            console.log(`プロファイル「${activeProfileName}」に設定を保存しました。`);
        } catch (e) { console.error('プロファイルの保存中にエラー:', e); }
    }

    function loadAllSettingsFromLocalStorage() {
        try {
            const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}');
            currentApiKey = profilesData.apiKey || '';
            apiKeyInput.value = currentApiKey;
            updateProfileSelector(profilesData.profiles || {}, profilesData.activeProfile);
            const activeProfileName = profilesData.activeProfile || profileSelect.value;
            const settings = profilesData.profiles ? profilesData.profiles[activeProfileName] : null;
            if (settings) {
                applySettingsToUI(settings);
                console.log(`プロファイル「${activeProfileName}」を読み込みました。`);
                return true;
            }
        } catch (e) { console.error('設定の読み込み中にエラー:', e); }
        initializeDefaultProfile();
        return false;
    }
    
    function applySettingsToUI(settings) {
        personaTextarea.value = settings.persona || '';
        summaryPromptTextarea.value = settings.summaryPrompt || '';
        userNameInput.value = settings.userName || 'ユーザー';
        aiNameInput.value = settings.aiName || 'AI';
        soundOnOff.checked = typeof settings.soundEnabled === 'boolean' ? settings.soundEnabled : true;
        soundTypeSelect.value = settings.soundType || 'sine';
        ttsOnOff.checked = typeof settings.ttsEnabled === 'boolean' ? settings.ttsEnabled : true;
        ttsEnabled = ttsOnOff.checked;
        if (settings.ttsVoiceName) ttsVoiceSelect.value = settings.ttsVoiceName;
        ttsRate = settings.ttsRate !== undefined ? parseFloat(settings.ttsRate) : 1.0;
        ttsPitch = settings.ttsPitch !== undefined ? parseFloat(settings.ttsPitch) : 1.0;
        ttsVolume = settings.ttsVolume !== undefined ? parseFloat(settings.ttsVolume) : 1.0;
        ttsRateInput.value = ttsRate;
        ttsRateValue.textContent = ttsRate.toFixed(1);
        ttsPitchInput.value = ttsPitch;
        ttsPitchValue.textContent = ttsPitch.toFixed(1);
        ttsVolumeInput.value = ttsVolume;
        ttsVolumeValue.textContent = ttsVolume.toFixed(1);
        currentSortBy = settings.chatHistorySortBy || 'date';
        currentSortOrder = settings.chatHistorySortOrder || 'desc';
        sortBySelect.value = currentSortBy;
        sortOrderIcon.textContent = (currentSortOrder === 'asc' ? '↑' : '↓');
        loadVoices();
    }

    function updateProfileSelector(profiles, activeProfileName) {
        [profileSelect, headerProfileSelect].forEach(selector => {
            selector.innerHTML = '';
            const profileNames = Object.keys(profiles);
            if (profileNames.length === 0) {
                selector.innerHTML = '<option value="">プロファイルなし</option>';
                return;
            }
            profileNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                if (name === activeProfileName) option.selected = true;
                selector.appendChild(option);
            });
        });
    }

    function initializeDefaultProfile() {
        const defaultSettings = { persona: '', summaryPrompt: `以下の会話履歴を基に、簡潔なタイトル（30文字程度）と、会話の要約を箇条書きにして作成し、JSON形式で出力してください。\n\n出力は以下のJSONフォーマットに従ってください。\n{\n  "title": "ここにタイトルを記述 (15文字程度)",\n  "summary": "ここに会話の要約を記述 (第三者の視点から自然な文章で)"\n}\n\n---\n[会話履歴]\n{CONVERSATION_HISTORY}\n---`, userName: 'ユーザー', aiName: 'AI', soundEnabled: true, soundType: 'sine', ttsEnabled: true, ttsVoiceName: '', ttsRate: 1.0, ttsPitch: 1.0, ttsVolume: 1.0, chatHistorySortBy: 'date', chatHistorySortOrder: 'desc' };
        const profilesData = { activeProfile: 'デフォルト', profiles: { 'デフォルト': defaultSettings }, apiKey: '' };
        localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
        updateProfileSelector(profilesData.profiles, 'デフォルト');
        applySettingsToUI(defaultSettings);
    }
    
    function switchActiveProfile(profileName) {
        const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY));
        profilesData.activeProfile = profileName;
        localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
        applySettingsToUI(profilesData.profiles[profileName]);
        profileSelect.value = profileName;
        headerProfileSelect.value = profileName;
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        loadAllSettingsFromLocalStorage();
        updateSpeechControlButtonVisibility();
        startNewChat(true); 
        tabPanes.forEach((pane, index) => pane.classList.toggle('active', index === 0));
        tabButtons.forEach((button, index) => button.classList.toggle('active', index === 0));
    });

    // --- イベントリスナー設定 ---
    newChatButton.addEventListener('click', () => startNewChat(false));
    saveChatSummaryButton.addEventListener('click', () => { if (checkApiKey()) createChatSummary(); });
    loadChatHistoryButton.addEventListener('click', () => { displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); chatHistoryListModal.style.display = 'block'; });
    printPdfButton.addEventListener('click', () => { if (currentActiveSummaryData) showPdfPreviewOfChatSummary(); else alert("プレビューするチャット履歴がありません。"); });
    helpButton.addEventListener('click', showHelp);
    
    function sendMessage() { if (textInput.value.trim() !== '' || attachedImage) { if (!checkApiKey()) return; handleUserInput(textInput.value); textInput.value = ''; } }
    sendButton.addEventListener('click', sendMessage);
    textInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } });

    textInput.addEventListener('paste', handlePaste);
    fileInputButton.addEventListener('click', () => imageFileInput.click());
    imageFileInput.addEventListener('change', handleFileSelect);
    removeImageButton.addEventListener('click', removeAttachedImage);
    
    settingsButton.addEventListener('click', () => { testKeyResult.textContent = ''; testKeyResult.className = ''; settingsModal.style.display = 'block'; });
    closeSettingsModal.addEventListener('click', () => settingsModal.style.display = 'none');
    saveKeyButton.addEventListener('click', () => { currentApiKey = apiKeyInput.value.trim(); saveCurrentProfileSettings(); settingsModal.style.display = 'none'; alert('APIキーを設定しました。'); });
    testKeyButton.addEventListener('click', testApiKey);
    deleteKeyButton.addEventListener('click', () => { if (confirm('現在のAPIキー設定をクリアしますか？')) { currentApiKey = ''; apiKeyInput.value = ''; saveCurrentProfileSettings(); alert('APIキー設定をクリアしました。'); testKeyResult.textContent = ''; testKeyResult.className = ''; } });

    personaButton.addEventListener('click', () => { personaModal.style.display = 'block'; loadVoices(); });
    closePersonaModal.addEventListener('click', () => personaModal.style.display = 'none');
    saveSettingsButton.addEventListener('click', () => personaModal.style.display = 'none');
    personaExampleBtns.forEach(btn => btn.addEventListener('click', () => { personaTextarea.value = btn.dataset.persona; }));
    
    saveProfileButton.addEventListener('click', () => { saveCurrentProfileSettings(); alert(`プロファイル「${profileSelect.value}」を現在の設定で上書き保存しました。`); });
    saveAsNewProfileButton.addEventListener('click', () => {
        const newProfileName = prompt('新しいプロファイル名を入力してください:', '新しいプロファイル');
        if (newProfileName && newProfileName.trim() !== '') {
            saveCurrentProfileSettings();
            const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY));
            const currentSettings = profilesData.profiles[profilesData.activeProfile];
            profilesData.profiles[newProfileName.trim()] = { ...currentSettings };
            profilesData.activeProfile = newProfileName.trim();
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
            updateProfileSelector(profilesData.profiles, profilesData.activeProfile);
            alert(`新しいプロファイル「${newProfileName}」を作成し、現在の設定を保存しました。`);
        }
    });
    deleteProfileButton.addEventListener('click', () => {
        const profileNameToDelete = profileSelect.value;
        if (!profileNameToDelete) return;
        const profilesData = JSON.parse(localStorage.getItem(PROFILES_KEY));
        if (Object.keys(profilesData.profiles).length <= 1) { alert('最後のプロファイルは削除できません。'); return; }
        if (confirm(`プロファイル「${profileNameToDelete}」を削除しますか？`)) {
            delete profilesData.profiles[profileNameToDelete];
            profilesData.activeProfile = Object.keys(profilesData.profiles)[0];
            localStorage.setItem(PROFILES_KEY, JSON.stringify(profilesData));
            loadAllSettingsFromLocalStorage();
            alert(`プロファイル「${profileNameToDelete}」を削除しました。`);
        }
    });
    
    function handleProfileSwitch() { switchActiveProfile(this.value); alert(`プロファイルを「${this.value}」に切り替えました。`); }
    profileSelect.addEventListener('change', handleProfileSwitch);
    headerProfileSelect.addEventListener('change', handleProfileSwitch);

    resetSummaryPromptButton.addEventListener('click', () => { summaryPromptTextarea.value = `以下の会話履歴を基に、簡潔なタイトル（30文字程度）と、会話の要約を箇条書きにして作成し、JSON形式で出力してください。\n\n出力は以下のJSONフォーマットに従ってください。\n{\n  "title": "ここにタイトルを記述 (15文字程度)",\n  "summary": "ここに会話の要約を記述 (第三者の視点から自然な文章で)"\n}\n\n---\n[会話履歴]\n{CONVERSATION_HISTORY}\n---`; alert('プロンプトをデフォルトに戻しました。\n変更を保存するにはプロファイル保存ボタンを押してください。'); });

    exportCsvButton.addEventListener('click', exportSettingsAsCsv);
    importCsvInput.addEventListener('change', importSettingsFromCsv);
    exportAllHistoryButton.addEventListener('click', exportAllChatSummaries);
    importAllHistoryInput.addEventListener('change', importAllChatSummaries);
    importMdInput.addEventListener('change', importMarkdownFile);
    deleteSelectedButton.addEventListener('click', deleteSelectedMessages);
    editSelectedButton.addEventListener('click', openEditMessageModal);
    playSelectedButton.addEventListener('click', playSelectedMessages);
    stopSpeechButton.addEventListener('click', () => { window.speechSynthesis.cancel(); updateSpeechControlButtonVisibility(); });
    micButton.addEventListener('click', () => { if (!checkApiKey()) return; if (isRecording) recognition.stop(); else recognition.start(); });

    window.addEventListener('click', (event) => { if (event.target == personaModal) personaModal.style.display = 'none'; if (event.target == settingsModal) settingsModal.style.display = 'none'; if (event.target == editMessageModal) editMessageModal.style.display = 'none'; if (event.target == pdfViewerModal) { pdfViewerModal.style.display = 'none'; pdfFrame.src = ''; } });
    
    closeChatHistoryListModal.addEventListener('click', () => chatHistoryListModal.style.display = 'none');
    chatHistorySearchInput.addEventListener('input', () => displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder));
    sortBySelect.addEventListener('change', (event) => { currentSortBy = event.target.value; displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); });
    sortOrderButton.addEventListener('click', () => { currentSortOrder = (currentSortOrder === 'asc' ? 'desc' : 'asc'); sortOrderIcon.textContent = (currentSortOrder === 'asc' ? '↑' : '↓'); displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); });
    selectAllHistoryButton.addEventListener('click', () => document.querySelectorAll('.history-item-checkbox').forEach(c => c.checked = true));
    deselectAllHistoryButton.addEventListener('click', () => document.querySelectorAll('.history-item-checkbox').forEach(c => c.checked = false));
    deleteSelectedHistoryButton.addEventListener('click', () => { const checked = document.querySelectorAll('.history-item-checkbox:checked'); if (checked.length === 0) { alert('削除する項目を選択してください。'); return; } if (confirm(`${checked.length}件の履歴を削除しますか？`)) { const idsToDelete = Array.from(checked).map(c => c.dataset.chatid); allChatSummaries = allChatSummaries.filter(s => !idsToDelete.includes(s.chatId)); displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder); alert(`${checked.length}件の履歴を削除しました。`); } });
    loadSelectedHistoryButton.addEventListener('click', () => { const checked = document.querySelectorAll('.history-item-checkbox:checked'); if (checked.length === 0) { alert('読み込む項目を選択してください。'); return; } let selected = []; checked.forEach(c => { const summary = allChatSummaries.find(s => s.chatId === c.dataset.chatid); if (summary) selected.push(summary); }); if (selected.length > 0) { selected.sort((a, b) => new Date(b.date) - new Date(a.date)); loadChatFromSummary(selected[0]); chatHistoryListModal.style.display = 'none'; alert(`「${selected[0].title}」を読み込みました。`); } });
    closePdfViewerModal.addEventListener('click', () => { pdfViewerModal.style.display = 'none'; pdfFrame.src = ''; });
    
    // --- チャット関連の関数 ---
    function startNewChat(isInitial) { if (!isInitial && currentConversationHistory.length > 0) { if (!confirm("現在のチャット内容を破棄しますか？")) return; } chatBox.innerHTML = ''; currentConversationHistory = []; saveChatSummaryButton.style.display = 'inline-flex'; loadChatHistoryButton.style.display = 'inline-flex'; printPdfButton.style.display = 'none'; newChatButton.style.display = 'inline-flex'; deleteSelectedButton.style.display = 'none'; editSelectedButton.style.display = 'none'; playSelectedButton.style.display = 'none'; stopSpeechButton.style.display = 'none'; currentActiveSummaryData = null; currentChatUniqueId = crypto.randomUUID(); removeAttachedImage(); if (isInitial && !currentApiKey) { addMessage("こんにちは！「API設定」ボタンからAPIキーを設定してください。", 'bot'); speakText("こんにちは！API設定ボタンからAPIキーを設定してください。"); } else { const userName = userNameInput.value || 'あなた'; const aiName = aiNameInput.value || 'AI'; const greetingMessage = `こんにちは、${userName}さん！${aiName}です。何でも話しかけてください。`; addMessage(greetingMessage, 'bot'); speakText(greetingMessage); } textInput.focus(); updateDeleteButtonVisibility(); }
    function handleUserInput(message) { if (!message.trim() && !attachedImage) return; addMessage(message, 'user', { image: attachedImage }); currentConversationHistory.push({ role: 'user', content: message, image: attachedImage, timestamp: new Date().toISOString() }); getAIResponse(); removeAttachedImage(); }
    async function getAIResponse() { if (!checkApiKey()) return; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${currentApiKey}`; const thinkingMessage = addMessage('考え中...', 'bot'); let contents = currentConversationHistory.map(item => { const parts = []; if (item.content && item.content.trim() !== '') parts.push({ text: item.content }); if (item.role === 'user' && item.image) parts.push({ inlineData: { mimeType: item.image.mimeType, data: item.image.base64 } }); return { role: item.role === 'user' ? 'user' : 'model', parts: parts.length > 0 ? parts : [{ text: '' }] }; }); const requestBody = { contents }; const persona = personaTextarea.value.trim(); if (persona) requestBody.systemInstruction = { parts: [{ text: persona }] }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) }); if (thinkingMessage && thinkingMessage.parentNode) chatBox.removeChild(thinkingMessage); if (!response.ok) { const errorData = await response.json(); throw new Error(`APIエラー: ${response.status} - ${errorData.error?.message || JSON.stringify(errorData)}`); } const data = await response.json(); if (data.candidates?.[0]?.content?.parts?.[0]?.text) { const aiResponse = data.candidates[0].content.parts[0].text; addMessage(aiResponse, 'bot'); if (soundOnOff.checked) playNotificationSound(soundTypeSelect.value || 'sine'); speakText(aiResponse); currentConversationHistory.push({ role: 'assistant', content: aiResponse, timestamp: new Date().toISOString() }); } else { throw new Error("APIから有効な応答が返されませんでした。"); } } catch (error) { console.error('Fetchエラー:', error); if (thinkingMessage && thinkingMessage.parentNode) chatBox.removeChild(thinkingMessage); let errorMessage = `エラーが発生しました: ${error.message}`; if (String(error.message).includes('429')) errorMessage = 'APIのリクエスト上限に達しました。'; addMessage(errorMessage, 'bot', { isError: true }); speakText(errorMessage); } }
    function addMessage(text, sender, options = {}) { const { isError = false, isSummary = false, timestamp = null, image = null } = options; const messageElement = document.createElement('div'); let messageClass = sender === 'user' ? 'user-message' : (isError ? 'error-message' : (isSummary ? 'summary-message' : 'bot-message')); messageElement.classList.add('message', messageClass); const messageTimestamp = timestamp ? new Date(timestamp) : new Date(); messageElement.dataset.id = messageTimestamp.getTime(); if (!isSummary) messageElement.addEventListener('click', () => { messageElement.classList.toggle('selected'); updateDeleteButtonVisibility(); }); if (image) { const imgElement = document.createElement('img'); if (image.base64 && image.mimeType) imgElement.src = `data:${image.mimeType};base64,${image.base64}`; else imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjBGMDg4Ii8+PHRleHQgeD0iMyIgeT0iMzgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiPuaOpeS4gTwvdGV4dD48L3RleHQ+PC9zdmc+'; imgElement.classList.add('message-image'); messageElement.appendChild(imgElement); } const textElement = document.createElement('div'); textElement.classList.add('message-content-text'); const urlRegex = /(?:^|(?<=\s))\[?(https?:\/\/[^\s]+?)(?:\]|\)|\.)?(?=\s|$)/g; let processedText = (text || '').replace(/\n/g, '<br>').replace(urlRegex, (match, url) => `<a href="${url.replace(/^[.,!?:;\]\)]+|[.,!?:;\]\)]+$/g, '')}" target="_blank">${url}</a>`); textElement.innerHTML = processedText; if(text || (!text && !image)) messageElement.appendChild(textElement); const timestampElement = document.createElement('div'); timestampElement.classList.add('timestamp'); timestampElement.textContent = formatTimestamp(messageTimestamp); messageElement.appendChild(timestampElement); chatBox.appendChild(messageElement); chatBox.scrollTop = chatBox.scrollHeight; return messageElement; }
    async function testApiKey() { const keyToTest = apiKeyInput.value.trim(); if (!keyToTest) { alert('テストするAPIキーを入力してください。'); return; } testKeyResult.textContent = 'テスト中...'; testKeyResult.className = ''; try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${keyToTest}`); if (response.ok) { testKeyResult.textContent = '✅ APIキーは有効です。'; testKeyResult.className = 'test-success'; } else { const errorData = await response.json(); testKeyResult.textContent = `❌ 無効なAPIキーです: ${errorData.error.message}`; testKeyResult.className = 'test-failure'; } } catch (error) { console.error('APIキーテストエラー:', error); testKeyResult.textContent = '❌ テストに失敗しました。'; testKeyResult.className = 'test-failure'; } }
    async function createChatSummary() { if (currentConversationHistory.length === 0) { alert('保存するチャットがありません。'); return; } let statusMessage = addMessage(`チャット内容を分析して保存しています...`, 'bot'); try { const userName = userNameInput.value || 'あなた', aiName = aiNameInput.value || 'AI'; const conversationText = currentConversationHistory.filter(i => !i.image).map(i => `${i.role === 'user' ? userName : aiName}: ${i.content || ''}`).join('\n'); const today = new Date(), dateForSummaryData = today.toISOString(); const summaryPromptTemplate = summaryPromptTextarea.value.trim() || `...`; const summaryPrompt = summaryPromptTemplate.replace('{CONVERSATION_HISTORY}', conversationText); const summaryResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${currentApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: summaryPrompt }] }] }) }); if (!summaryResponse.ok) { const e = await summaryResponse.json(); throw new Error(`概要生成APIエラー: ${summaryResponse.status} - ${e.error?.message || JSON.stringify(e)}`); } const data = await summaryResponse.json(); let generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || ""; let title = '無題のチャット', summary = '概要が生成されませんでした。'; try { const clean = generatedText.replace(/```json\n?|\n?```/g, '').trim(); const parsed = JSON.parse(clean); if (parsed.title) title = parsed.title.trim(); if (parsed.summary) summary = parsed.summary.trim(); } catch (e) { console.warn("JSON解析失敗:", e); title = generatedText.split('\n')[0] || title; summary = generatedText; } if (!currentChatUniqueId) currentChatUniqueId = crypto.randomUUID(); const safeTitle = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50); const downloadFilename = `${today.getFullYear()}${('0' + (today.getMonth() + 1)).slice(-2)}${('0' + today.getDate()).slice(-2)}_${safeTitle}.md`; const chatSummaryData = { chatId: currentChatUniqueId, title, summary, history: [...currentConversationHistory], date: dateForSummaryData, filename: downloadFilename }; downloadChatSummaryMarkdown(chatSummaryData, downloadFilename); if (statusMessage?.parentNode) statusMessage.remove(); saveChatSummaryToMemory(chatSummaryData); alert(`チャットを保存しました: ${title}`); displayChatSummaryInChatBox(chatSummaryData); currentActiveSummaryData = chatSummaryData; printPdfButton.style.display = 'inline-flex'; } catch (error) { console.error('チャット保存エラー:', error); if (statusMessage?.parentNode) { statusMessage.textContent = `保存に失敗: ${error.message}`; statusMessage.className = 'message error-message'; } else addMessage(`保存に失敗: ${error.message}`, 'bot', { isError: true }); } }
    function saveChatSummaryToMemory(d) { const i = allChatSummaries.findIndex(s => s.chatId === d.chatId); if (i > -1) allChatSummaries[i] = d; else allChatSummaries.push(d); }
    function displayChatSummaryInChatBox(d) { chatBox.innerHTML = ''; const f = document.createElement('div'); f.className = 'message summary-message'; f.innerHTML = `<h3>ファイル名: ${d.filename || '不明'}</h3><p>保存日時: ${d.date ? formatTimestamp(new Date(d.date)) : '不明'}</p>`; chatBox.appendChild(f); const s = document.createElement('div'); s.className = 'message summary-message'; s.innerHTML = `<h2>${d.title}</h2><p>${d.summary.replace(/\n/g, '<br>')}</p><hr><h3>チャット履歴 (保存時)</h3>`; chatBox.appendChild(s); currentConversationHistory = d.history; d.history.forEach(i => addMessage(i.content, i.role === 'user' ? 'user' : 'bot', { timestamp: i.timestamp, image: i.image })); chatBox.scrollTop = chatBox.scrollHeight; updateDeleteButtonVisibility(); currentActiveSummaryData = d; printPdfButton.style.display = 'inline-flex'; }
    function displayChatHistoryList(term = '', sortBy = 'date', sortOrder = 'desc') { chatHistoryList.innerHTML = ''; const filtered = [...allChatSummaries].filter(s => (s.title || '').toLowerCase().includes(term.toLowerCase()) || (s.date ? formatTimestamp(new Date(s.date)) : '').toLowerCase().includes(term.toLowerCase()) || (s.chatId || '').toLowerCase().includes(term.toLowerCase())); filtered.sort((a, b) => { let compA, compB; if (sortBy === 'date') { compA = new Date(a.date); compB = new Date(b.date); } else { compA = a.title || ''; compB = b.title || ''; } let c = 0; if (compA > compB) c = 1; else if (compA < compB) c = -1; return sortOrder === 'asc' ? c : -c; }); if (filtered.length === 0) { chatHistoryList.innerHTML = `<li>「${term}」に一致する履歴はありません。</li>`; return; } filtered.forEach(s => { const li = document.createElement('li'); if (!s.chatId) s.chatId = crypto.randomUUID(); li.innerHTML = `<input type="checkbox" class="history-item-checkbox" data-chatid="${s.chatId}"><div class="history-item-content"><div class="title">${s.title}</div><div class="date-time">${s.date ? formatTimestamp(new Date(s.date)) : '不明'}</div></div>`; chatHistoryList.appendChild(li); }); }
    function loadChatFromSummary(d) { chatBox.innerHTML = ''; currentConversationHistory = d.history; displayChatSummaryInChatBox(d); updateDeleteButtonVisibility(); currentActiveSummaryData = d; currentChatUniqueId = d.chatId; printPdfButton.style.display = 'inline-flex'; }
    function downloadChatSummaryMarkdown(d, f) { let c = `# ${d.title}\n\n**保存日時:** ${formatTimestamp(new Date(d.date))}\n\n## 概要\n\n`; d.summary.replace(/<br>/g, '\n').split('\n').forEach(l => c += `> ${l}\n`); c += `\n---\n\n# チャット履歴\n\n`; const u = userNameInput.value || 'ユーザー', a = aiNameInput.value || 'AI'; d.history.forEach(i => { c += `**${i.role === 'user' ? u : a}** (${formatTimestamp(new Date(i.timestamp))}):\n`; if (i.image) c += `> (画像添付)\n`; if (i.content) i.content.split('\n').forEach(l => c += `> ${l}\n`); c += `\n`; }); downloadFile(c, f, 'text/markdown;charset=utf-8;'); }
    async function showPdfPreviewOfChatSummary() { if (!currentActiveSummaryData) return; const u = userNameInput.value || 'ユーザー', a = aiNameInput.value || 'AI'; let c = `<div style="font-family: 'Helvetica Neue', Arial, sans-serif; line-height: 1.6; padding: 20px;"><h1 style="color: #2e8b57;">${currentActiveSummaryData.title}</h1><p><strong>ファイル名:</strong> ${currentActiveSummaryData.filename}</p><p><strong>保存日時:</strong> ${formatTimestamp(new Date(currentActiveSummaryData.date))}</p><h2 style="color: #3cb371;">概要</h2><p>${currentActiveSummaryData.summary.replace(/\n/g,'<br>')}</p><hr><h2 style="color: #3cb371;">チャット履歴</h2><div>`; currentActiveSummaryData.history.forEach(i => { c += `<div style="margin-bottom: 5px; padding: 8px 12px; border-radius: 8px; background-color: ${i.role === 'user' ? '#e0f0e0' : '#f0f0f0'};"><strong style="display: block;">${i.role === 'user' ? u : a}</strong>`; if (i.image?.base64) c += `<img src="data:${i.image.mimeType};base64,${i.image.base64}" alt="添付画像" style="max-width: 80%; display: block; margin: 5px auto;"><br>`; else if (i.image) c += `<div>(画像添付)</div>`; if (i.content) c += `<div>${i.content.replace(/\n/g,'<br>')}</div>`; c += `<span style="font-size: 0.75em; color: #888;">(${formatTimestamp(new Date(i.timestamp))})</span></div>`; }); c += `</div></div>`; const o = { margin: 10, filename: `${currentActiveSummaryData.title}_${toDateString(new Date(currentActiveSummaryData.date))}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, dpi: 192, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; try { const e = document.createElement('div'); e.innerHTML = c; const w = html2pdf().from(e).set(o); const b = await w.toPdf().output('blob'); const url = URL.createObjectURL(b); pdfFrame.src = url; pdfViewerModal.style.display = 'block'; downloadPdfButton.onclick = () => { const l = document.createElement('a'); l.href = url; l.download = o.filename; document.body.appendChild(l); l.click(); document.body.removeChild(l); }; } catch (e) { console.error('PDF生成エラー:', e); alert(`PDF生成に失敗: ${e.message}`); } }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; let recognition, isRecording = false, finalTranscript = ''; if (SpeechRecognition) { recognition = new SpeechRecognition(); recognition.lang = 'ja-JP'; recognition.continuous = true; recognition.interimResults = false; recognition.onstart = () => { isRecording = true; finalTranscript = ''; micButton.classList.add('recording'); micButton.textContent = '🎙️'; textInput.placeholder = '録音中...'; }; recognition.onresult = (e) => { let t = ''; for (let i = e.results.length - 1; i >= 0; i--) if (e.results[i].isFinal) t += e.results[i][0].transcript; finalTranscript += t; }; recognition.onend = () => { isRecording = false; micButton.classList.remove('recording'); micButton.textContent = '🎤'; textInput.placeholder = 'メッセージを入力...'; if (finalTranscript.trim()) textInput.value += (textInput.value.length > 0 ? ' ' : '') + finalTranscript.trim(); textInput.focus(); }; recognition.onerror = (e) => { console.error('音声認識エラー:', e.error); if (isRecording) recognition.stop(); }; }
    function processImageFile(f) { if (!f.type.startsWith('image/')) { alert('画像ファイルを選択してください。'); return; } const r = new FileReader(); r.onload = (e) => { const d = e.target.result; imagePreview.src = d; imagePreviewContainer.style.display = 'block'; attachedImage = { base64: d.split(',')[1], mimeType: d.match(/:(.*?);/)[1] }; }; r.readAsDataURL(f); }
    function handlePaste(e) { const i = (e.clipboardData || window.clipboardData).items; for (const t of i) if (t.kind === 'file' && t.type.startsWith('image/')) { e.preventDefault(); processImageFile(t.getAsFile()); return; } }
    function handleFileSelect(e) { if (e.target.files?.[0]) processImageFile(e.target.files[0]); }
    function removeAttachedImage() { attachedImage = null; imagePreviewContainer.style.display = 'none'; imagePreview.src = ''; imageFileInput.value = ''; }
    function exportSettingsAsCsv() { const s = { persona: personaTextarea.value.trim(), summaryPrompt: summaryPromptTextarea.value.trim(), userName: userNameInput.value.trim(), aiName: aiNameInput.value.trim(), soundEnabled: soundOnOff.checked, soundType: soundTypeSelect.value, ttsEnabled: ttsOnOff.checked, ttsVoiceName: ttsVoiceSelect.value, ttsRate, ttsPitch, ttsVolume }; const r = ['"Key","Value"']; for (const k in s) { let v = s[k]; if (typeof v === 'string') v = v.replace(/\n/g, '\\n').replace(/"/g, '""'); r.push(`"${k}","${v}"`); } downloadFile(r.join('\n'), 'ai_settings_backup.csv', 'text/csv;charset=utf-8;'); alert('現在の設定をCSVで保存しました。'); }
    function importSettingsFromCsv(e) { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (evt) => { try { const l = evt.target.result.split('\n'); if (l.length < 2) throw new Error("不正なCSVです。"); const s = {}; for (let i = 1; i < l.length; i++) { if (!l[i].trim()) continue; const p = l[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g); if (!p || p.length !== 2) continue; let k = p[0].replace(/^"|"$/g, '').replace(/""/g, '"'); let v = p[1].replace(/^"|"$/g, '').replace(/\\n/g, '\n').replace(/""/g, '"'); s[k] = v; } applySettingsToUI(s); alert('CSVから設定を読み込みました。\n変更を保存するにはプロファイル保存ボタンを押してください。'); e.target.value = ''; } catch (err) { alert(`CSV読込失敗: ${err.message}`); e.target.value = ''; } }; r.readAsText(f); }
    function exportAllChatSummaries() { if (allChatSummaries.length === 0) { alert('エクスポートする履歴がありません。'); return; } const d = new Date(); downloadFile(JSON.stringify(allChatSummaries, null, 2), `my_chat_history_backup_${d.getFullYear()}${('0' + (d.getMonth() + 1)).slice(-2)}${('0' + d.getDate()).slice(-2)}.json`, 'application/json;charset=utf-8;'); alert('全チャット履歴をJSONで保存しました。'); }
    function importAllChatSummaries(e) { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = (evt) => { try { const imported = JSON.parse(evt.target.result); if (!Array.isArray(imported)) throw new Error("不正なファイル形式です。"); if (confirm('既存の履歴にインポートした履歴を追加しますか？\n（「キャンセル」で上書き）')) { const merged = [...allChatSummaries]; imported.forEach(i => { if (!i.chatId) i.chatId = crypto.randomUUID(); const idx = merged.findIndex(s => s.chatId === i.chatId); if (idx > -1) merged[idx] = i; else merged.push(i); }); allChatSummaries = merged; alert('履歴をマージしました。'); } else { imported.forEach(s => { if (!s.chatId) s.chatId = crypto.randomUUID(); }); allChatSummaries = imported; alert('履歴を上書きしました。'); } startNewChat(true); displayChatHistoryList('', currentSortBy, currentSortOrder); } catch (err) { alert(`インポート失敗: ${err.message}`); } finally { e.target.value = ''; } }; r.readAsText(f); }
    function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function importMarkdownFile(e) { const f = e.target.files?.[0]; if (!f) return; const r = new FileReader(); r.onload = async (evt) => { try { const p = parseMarkdownChatHistory(evt.target.result); if (p) { saveChatSummaryToMemory(p); displayChatHistoryList('', currentSortBy, currentSortOrder); alert(`「${f.name}」を読み込み、履歴に追加しました。`); } else alert('Markdownの解析に失敗。'); } catch (err) { alert(`インポートエラー: ${err.message}`); } finally { e.target.value = ''; } }; r.readAsText(f); }
    function parseMarkdownChatHistory(c) { let title = '無題', summary = '', dateIso = new Date().toISOString(), history = [], role = '', content = [], ts = '', hasImg = false; const u = userNameInput.value || 'ユーザー', a = aiNameInput.value || 'AI'; const l = c.split('\n'); let readSum = false, readHist = false; for (const line of l) { const t = line.trim(); if (t.startsWith('# ')) { if (t.startsWith('# チャット履歴')) { if (role && (content.length > 0 || hasImg)) history.push({ role, content: content.join('\n').trim(), timestamp: ts, image: hasImg ? { base64: null, mimeType: null } : null }); readSum = false; readHist = true; role = ''; content = []; ts = ''; hasImg = false; continue; } else if (!readHist && !readSum) { title = t.substring(2).trim(); continue; } } if (t.startsWith('**保存日時:** ')) { const m = t.substring(13).trim().match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/); if (m) dateIso = new Date(parseInt(m[1]), parseInt(m[2]) - 1, parseInt(m[3]), parseInt(m[4]), parseInt(m[5])).toISOString(); continue; } if (t.startsWith('## 概要')) { readSum = true; readHist = false; summary = ''; continue; } if (t === '---') { readSum = false; continue; } if (readSum && t.startsWith('> ')) { summary += t.substring(2) + '\n'; continue; } if (readHist) { const um = t.match(`^\\*\\*${escapeRegExp(u)}\\*\\* \\((\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2})\\):`); const am = t.match(`^\\*\\*${escapeRegExp(a)}\\*\\* \\((\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2})\\):`); if (um || am) { if (role && (content.length > 0 || hasImg)) history.push({ role, content: content.join('\n').trim(), timestamp: ts, image: hasImg ? { base64: null, mimeType: null } : null }); role = um ? 'user' : 'assistant'; const tsm = (um || am)[1].match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/); ts = tsm ? new Date(parseInt(tsm[1]), parseInt(tsm[2]) - 1, parseInt(tsm[3]), parseInt(tsm[4]), parseInt(tsm[5])).toISOString() : new Date().toISOString(); content = []; hasImg = false; } else if (t.startsWith('> ')) { const cp = t.substring(2); if (cp === '(画像添付)') hasImg = true; else content.push(cp); } } } if (role && (content.length > 0 || hasImg)) history.push({ role, content: content.join('\n').trim(), timestamp: ts, image: hasImg ? { base64: null, mimeType: null } : null }); summary = summary.trim() || '概要なし'; const id = crypto.randomUUID(), safeT = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50); const d = new Date(dateIso); const fn = `${d.getFullYear()}${(d.getMonth() + 1).toString().padStart(2, '0')}${d.getDate().toString().padStart(2, '0')}_${safeT}.md`; return { chatId: id, title, summary, history, date: dateIso, filename: fn }; }
    function playNotificationSound(t = 'sine') { try { const ctx = new (window.AudioContext || window.webkitAudioContext)(), o = ctx.createOscillator(), g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type = t; g.gain.setValueAtTime(0.1, ctx.currentTime); let f = 440; switch(t) { case 'square': f = 660; break; case 'sawtooth': f = 220; break; case 'triangle': f = 523; break; } o.frequency.setValueAtTime(f, ctx.currentTime); o.start(); o.stop(ctx.currentTime + 0.1); } catch (e) { console.error("サウンド再生失敗:", e); } }
    function updateCurrentDateTime() { const n = new Date(), y = n.getFullYear(), m = (n.getMonth() + 1).toString().padStart(2, '0'), d = n.getDate().toString().padStart(2, '0'), w = ['日','月','火','水','木','金','土'][n.getDay()], h = n.getHours().toString().padStart(2, '0'), min = n.getMinutes().toString().padStart(2, '0'); datetimeDisplay.textContent = `${y}年${m}月${d}日(${w}) 令和${y-2018}年 ${h}時${min}分`; } setInterval(updateCurrentDateTime, 60000); updateCurrentDateTime();
    function checkApiKey() { if (!currentApiKey) { alert('「API設定」からAPIキーを設定してください。'); settingsModal.style.display = 'block'; return false; } return true; }
    function downloadFile(c, f, t) { const b = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), c], { type: t }); const l = document.createElement('a'); l.href = URL.createObjectURL(b); l.download = f; document.body.appendChild(l); l.click(); document.body.removeChild(l); URL.revokeObjectURL(l.href); }
    function toDateString(d) { return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`; }
    function formatTimestamp(d) { return `${d.getFullYear()}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`; }
    function showHelp() { const c = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>取扱説明書</title><style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.7;margin:0;padding:25px;color:#333;background-color:#f9f9f9}.container{max-width:800px;margin:0 auto;background-color:#fff;padding:20px 30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative}h1{color:#2e8b57;border-bottom:3px solid #66cdaa;padding-bottom:10px}h2{color:#3cb371;border-bottom:2px solid #e0f2f1;padding-bottom:8px;margin-top:30px}ul{list-style:none;padding-left:0}li{margin-bottom:15px;padding-left:20px;position:relative}li::before{content:'✓';color:#3cb371;position:absolute;left:0;font-weight:bold}code{background-color:#eef;color:#d63384;padding:2px 6px;border-radius:4px}.important{background-color:#fffbe6;border:1px solid #ffeeba;border-left:5px solid #ffc107;padding:15px 20px;margin:20px 0;border-radius:5px}.close-help-button{position:absolute;top:15px;right:15px;background-color:#f44336;color:white;border:none;border-radius:50%;width:30px;height:30px;font-size:1.2em;cursor:pointer;display:flex;justify-content:center;align-items:center}</style></head><body><div class="container"><button class="close-help-button" onclick="window.close()">&times;</button><h1>取扱説明書</h1><p>AIとの対話を記録・管理するツールです。</p><div class="important"><p><strong>【重要】</strong>「<b>API設定</b>」からご自身のGemini APIキーを設定してください。</p></div><div class="important"><p><strong>【重要】</strong>チャット履歴は自動保存されません。「<b>各種設定</b>」からJSONファイルを保存・読込してください。</p></div><h2>主な機能</h2><h3>1. AIとのチャット</h3><ul><li><b>プロファイル切替:</b> ヘッダーから設定(プロファイル)を瞬時に切り替えられます。</li><li><b>メッセージ送信:</b> <code>Enter</code>キーで送信、<code>Shift + Enter</code>で改行。</li><li><b>画像添付:</b> 📎ボタンかペーストで画像を添付。</li></ul><h3>2. 保存と履歴管理</h3><ul><li><b>チャット保存:</b> 現在の会話を分析し、マークダウン形式でダウンロードします。</li><li><b>履歴一覧:</b> 過去のチャットを呼び出します(JSONの読込が必要)。</li></ul><h3>3. 各種設定</h3><ul><li>AIの性格、プロンプト等を「プロファイル」としてブラウザに保存できます。</li><li><b>「全履歴をJSONで保存/読込」</b>で全チャット履歴をバックアップできます。</li></ul><h2>注意事項</h2><ul><li>チャット内容はファイルとしてエクスポートしない限り、ブラウザを閉じると失われます。</li><li>API利用料金はご自身のGoogleアカウントに準じます。</li></ul></div></body></html>`; const w = window.open('', '_blank'); w.document.write(c); w.document.close(); }
    function updateDeleteButtonVisibility() { const s = document.querySelectorAll('.message.selected'); deleteSelectedButton.style.display = s.length > 0 ? 'block' : 'none'; editSelectedButton.style.display = s.length === 1 ? 'block' : 'none'; playSelectedButton.style.display = s.length > 0 ? 'block' : 'none'; }
    function deleteSelectedMessages() { const s = document.querySelectorAll('.message.selected'); if (s.length === 0) return; if (confirm(`選択した ${s.length} 件を削除しますか？`)) { const ids = new Set(); s.forEach(m => { ids.add(m.dataset.id); m.remove(); }); currentConversationHistory = currentConversationHistory.filter(i => !ids.has(String(new Date(i.timestamp).getTime()))); updateDeleteButtonVisibility(); } }
    function openEditMessageModal() { const s = document.querySelector('.message.selected'); if (!s) return; editingMessageElement = s; editMessageTextarea.value = s.querySelector('.message-content-text')?.innerText || ''; editMessageModal.style.display = 'block'; }
    saveEditedMessageButton.addEventListener('click', () => { if (!editingMessageElement) return; const n = editMessageTextarea.value, id = editingMessageElement.dataset.id; const t = editingMessageElement.querySelector('.message-content-text'); if (t) t.innerHTML = n.replace(/\n/g, '<br>').replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>'); const idx = currentConversationHistory.findIndex(i => String(new Date(i.timestamp).getTime()) === id); if (idx !== -1) currentConversationHistory[idx].content = n; editingMessageElement.classList.remove('selected'); editingMessageElement = null; editMessageModal.style.display = 'none'; updateDeleteButtonVisibility(); });
    closeEditMessageModal.addEventListener('click', () => { editingMessageElement = null; editMessageModal.style.display = 'none'; });
    function playSelectedMessages() { if (!ttsEnabled || !window.speechSynthesis) return; window.speechSynthesis.cancel(); let text = Array.from(document.querySelectorAll('.message.selected')).sort((a, b) => parseInt(a.dataset.id) - parseInt(b.dataset.id)).map(m => m.querySelector('.message-content-text')?.textContent.trim() || (m.querySelector('.message-image') ? '（画像）' : '')).filter(Boolean).join('。'); if (text) speakText(text); }
    function loadVoices() { if (!window.speechSynthesis) { ttsOnOff.disabled = true; return; } availableVoices = window.speechSynthesis.getVoices(); ttsVoiceSelect.innerHTML = ''; let defaultVoice = null; availableVoices.filter(v => v.lang.startsWith('ja')).forEach(v => { const o = document.createElement('option'); o.textContent = `${v.name} (${v.lang})`; o.value = v.name; ttsVoiceSelect.appendChild(o); if (v.default) defaultVoice = v.name; }); const d = JSON.parse(localStorage.getItem(PROFILES_KEY) || '{}'); const p = d.profiles ? d.profiles[d.activeProfile] : null; const vName = p ? p.ttsVoiceName : null; let sel = null; if (vName && availableVoices.some(v => v.name === vName)) sel = vName; else if (defaultVoice) sel = defaultVoice; if (sel) { ttsVoiceSelect.value = sel; selectedTtsVoice = availableVoices.find(v => v.name === sel); } }
    if (window.speechSynthesis) window.speechSynthesis.onvoiceschanged = loadVoices;
    function speakText(t) { if (!ttsEnabled || !window.speechSynthesis || !t.trim()) return; window.speechSynthesis.cancel(); let s = t.replace(/\p{Emoji}/gu, '').replace(/[*`]/g, ''); if (!s.trim()) return; const u = new SpeechSynthesisUtterance(s); u.lang = 'ja-JP'; if (selectedTtsVoice) u.voice = selectedTtsVoice; u.rate = ttsRate; u.pitch = ttsPitch; u.volume = ttsVolume; window.speechSynthesis.speak(u); updateSpeechControlButtonVisibility(); u.onend = () => updateSpeechControlButtonVisibility(); u.onerror = (e) => { console.error('TTSエラー:', e.error); updateSpeechControlButtonVisibility(); }; }
    function updateSpeechControlButtonVisibility() { stopSpeechButton.style.display = window.speechSynthesis.speaking && ttsEnabled ? 'block' : 'none'; }
    function switchTab(e) { const t = e.target; if (!t.classList.contains('tab-button') || t.classList.contains('active')) return; document.querySelector('.tab-button.active')?.classList.remove('active'); document.querySelector('.tab-pane.active')?.classList.remove('active'); t.classList.add('active'); document.getElementById(t.dataset.tab)?.classList.add('active'); }
    tabNavigation.addEventListener('click', switchTab);
</script>

</body>
</html>
