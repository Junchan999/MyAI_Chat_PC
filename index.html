<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ï¼­ï½™AIChat_PC</title>
    <style>
        html {
            height: 100%;
        }
        body {
            height: 100vh;
            margin: 0;
            font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif;
            background: linear-gradient(to bottom, #e0fff0, #ffffff);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            flex-wrap: nowrap;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            flex-shrink: 0;
        }
        header h1 {
            margin: 0;
            font-size: 1.5em;
            color: #2e8b57;
            font-weight: bold;
            white-space: nowrap;
        }
        .header-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }
        .header-buttons {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            gap: 10px;
        }

        /* Base Button Styles for a Modern Look */
        .header-buttons button,
        .modal-buttons button,
        .csv-buttons-container button,
        .csv-buttons-container label,
        .chat-history-list-footer button,
        .sort-controls button,
        #save-edited-message-button,
        #download-pdf-button,
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… */
        .tab-button { /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚‚åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ */
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */
            padding: 10px 18px; /* Slightly more padding */
            border: none;
            color: white;
            border-radius: 25px; /* More rounded */
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15); /* Stronger, more modern shadow */
            white-space: nowrap;
            min-width: 100px; /* Give them a minimum width for consistency */
            display: inline-flex; /* For better centering of text/icon if any */
            justify-content: center;
            align-items: center;
            gap: 5px; /* Space between text and icon if any */
        }
        .header-buttons button:hover,
        .modal-buttons button:hover,
        .csv-buttons-container button:hover,
        .csv-buttons-container label:hover,
        .chat-history-list-footer button:hover,
        .sort-controls button:hover,
        #save-edited-message-button:hover,
        #download-pdf-button:hover,
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… */
        .tab-button:hover { /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚‚ãƒ›ãƒãƒ¼åŠ¹æœé©ç”¨ */
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */
            opacity: 0.95;
            transform: translateY(-3px); /* Slightly more lift */
            box-shadow: 0 6px 12px rgba(0,0,0,0.2); /* Deeper shadow on hover */
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰² */
        #persona-button,
        #load-chat-history-button,
        #new-chat-button,
        #settings-button,
        #help-button {
            background-color: #f0f0f0; /* Lighter background */
            color: #444; /* Darker text */
            border: 1px solid #ccc; /* Softer border */
            box-shadow: 0 2px 5px rgba(0,0,0,0.08); /* Lighter shadow */
        }
        #persona-button:hover,
        #load-chat-history-button:hover,
        #new-chat-button:hover,
        #settings-button:hover,
        #help-button:hover {
            background-color: #e0e0e0; /* Darker on hover */
            color: #222;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }

        /* å„ãƒ˜ãƒƒãƒ€ãƒ¼ãƒœã‚¿ãƒ³ã®å€‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
        #delete-selected-button { background-color: #dc3545; } /* Bootstrap danger red */
        #edit-selected-button { background-color: #ffc107; color: #333; } /* Bootstrap warning yellow */
        #play-selected-button { background-color: #28a745; } /* Bootstrap success green */
        #stop-speech-button { background-color: #6c757d; } /* Bootstrap secondary grey */
        #save-chat-summary-button { background-color: #007bff; } /* Bootstrap primary blue */
        #print-pdf-button { background-color: #17a2b8; } /* Bootstrap info teal */


        .main-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 20px;
            width: 100%;
            padding: 20px;
            box-sizing: border-box;
            flex-grow: 1;
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ«ï¼ˆå…¥åŠ›æ¬„ï¼‰ */
        #side-panel {
            width: 280px;
            min-width: 280px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #side-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            color: #2e8b57;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            flex-grow: 1;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(5px);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        #datetime-display {
            text-align: center;
            padding: 8px;
            background-color: rgba(240, 240, 240, 0.7);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            font-size: 1.2em;
            color: #555;
            flex-shrink: 0;
        }
        .chat-box {
            flex-grow: 1;
            padding: 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 12px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .message.selected { background-color: #ffebee; border: 1px solid #e57373; }
        .message img.message-image { max-width: 100%; border-radius: 10px; margin-bottom: 8px; }
        .user-message { background-color: #c8e6c9; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #ffffff; align-self: flex-start; border-bottom-left-radius: 5px; }
        .error-message { background-color: #f8d7da; color: #721c24; align-self: flex-start; }
        .summary-message { background-color: #fef9e7; align-self: center; width: 95%; max-width: 95%; border: 1px solid #fceecb; text-align: left; }
        .timestamp { font-size: 0.75em; color: #888; margin-top: 4px; }
        
        .input-area {
            display: flex;
            flex-direction: column;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            flex-grow: 1;
            min-height: 0;
        }
        #image-preview-container {
            position: relative;
            margin-bottom: 8px;
            display: none;
            width: fit-content;
        }
        #image-preview { max-width: 100px; max-height: 100px; border-radius: 8px; border: 1px solid #ddd; }
        #remove-image-button {
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px;
            border-radius: 50%; border: none; background-color: rgba(0, 0, 0, 0.6);
            color: white; cursor: pointer; font-size: 14px; line-height: 20px; text-align: center;
        }
        
        .input-controls { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        .input-buttons-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 8px; 
            flex-wrap: wrap;
            align-items: flex-end; /* ãƒœã‚¿ãƒ³ã‚’ä¸‹æƒãˆã« */
        }
        #text-input {
            flex-grow: 1; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 12px; 
            padding: 10px 15px; 
            resize: vertical;
            font-family: inherit; 
            font-size: 1em;
            min-height: 120px; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å¤§ããã™ã‚‹ */
        }
        #text-input:focus {
            outline: none; border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        /* å…¥åŠ›æ¬„ã®ã‚¢ã‚¤ã‚³ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« (å††å½¢) */
        #file-input-button, #mic-button, #send-button {
            width: 48px; /* Slightly larger */
            height: 48px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 1.6em; /* Larger icon */
            line-height: 48px; /* Center content vertically */
            text-align: center;
            display: flex; /* Use flex for perfect centering */
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15); /* Shadow for lift */
        }
        #file-input-button:hover, #mic-button:hover, #send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #file-input-button { background-color: #4CAF50; } /* Consistent green */
        #mic-button { background-color: #007bff; } /* Primary blue for mic */
        #mic-button.recording { background-color: #dc3545; } /* Danger red when recording */
        #send-button { background-color: #6f42c1; } /* Purple for send */

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content {
            background-color: #fefefe; margin: 2.5vh auto; padding: 20px; border: 1px solid #888;
            width: 90%; max-width: 800px;
            border-radius: 8px; display: flex; flex-direction: column;
            max-height: 95vh;
        }
        #settings-modal .modal-content { max-width: 500px; }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… */
        #persona-modal .modal-content {
            max-width: 90vw; /* PCç”»é¢å¹…ã®90%ã«æ‹¡å¤§ */
        }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */

        .modal-body { overflow-y: auto; padding-right: 10px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-content h2 { margin-top: 0; flex-shrink: 0; }
        .modal-content h3 { font-size: 1.1em; margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .name-setting-container { display: flex; gap: 10px; align-items: center; }
        .name-setting-container label { flex-basis: 100px; }
        .name-setting-container input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        #persona-textarea, #summary-prompt-textarea, #api-key-input {
            width: 100%; margin-top: 10px; box-sizing: border-box; border-radius: 4px;
            border: 1px solid #ccc; padding: 8px; font-family: inherit;
        }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé«˜ã•ã‚’èª¿æ•´ */
        #persona-textarea { height: 250px; resize: vertical; }
        #summary-prompt-textarea { height: 200px; resize: vertical; }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */
        #api-key-input { height: auto; }

        .examples-container { margin-top: 10px; }
        .examples-container button { margin-right: 5px; margin-bottom: 5px; }
        .modal-buttons { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 20px; flex-shrink: 0; }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ã‚«ãƒ©ãƒ é–“ã®é–“éš”ã‚’èª¿æ•´ */
        .settings-columns { 
            display: flex; 
            gap: 30px; /* é–“éš”ã‚’åºƒã’ã‚‹ */
            flex-wrap: wrap; /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
            justify-content: space-between; /* ä¸¡ç«¯æƒãˆ */
        }
        .settings-column { 
            flex: 1; 
            min-width: 320px; /* ã‚ã‚‹ç¨‹åº¦ã®æœ€å°å¹…ã‚’ç¢ºä¿ */
        }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */

        .sound-settings div {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sound-settings label {
            min-width: 80px; /* Adjust as needed */
            white-space: nowrap;
        }
        .sound-settings input[type="range"] {
            flex-grow: 1;
            width: auto;
        }
        .sound-settings span {
            min-width: 30px;
            text-align: right;
        }

        /* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒªã‚¹ãƒˆè¡¨ç¤ºç”¨ */
        #chat-history-list-modal .modal-content { max-width: 900px; }
        #chat-history-search-input {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
        }
        #chat-history-list {
            list-style: none;
            padding: 0;
            margin: 0 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            overflow-y: auto;
            max-height: 60vh;
            margin-bottom: 10px;
        }
        #chat-history-list li {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
        }
        #chat-history-list li:last-child { border-bottom: none; }
        #chat-history-list li:hover { background-color: #e8f5e9; }
        #chat-history-list li .history-item-content {
            flex-grow: 1;
            margin-left: 10px;
        }
        #chat-history-list li .title { font-weight: bold; color: #333; }
        #chat-history-list li .date-time { font-size: 0.8em; color: #666; margin-top: 4px; }


        .chat-history-list-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
            gap: 10px;
        }
        .chat-history-list-footer .left-buttons,
        .chat-history-list-footer .right-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
        }

        /* ä¸¦ã¹æ›¿ãˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
        }
        .sort-controls label {
            white-space: nowrap;
            margin-right: 5px;
        }
        .sort-controls select {
            padding: 6px 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 0.9em;
        }
        /* Override specific modal buttons to fit new base style */
        #save-settings-button, #test-key-button, #save-key-button {
             background-color: #28a745; /* Green for saving/positive actions */
             min-width: 100px;
        }
        #delete-key-button {
            background-color: #dc3545; /* Red for deletion */
            min-width: 100px;
        }
        .modal-buttons .right-buttons button {
            background-color: #28a745; /* Consistent green for primary modal actions */
        }
        #test-key-button {
            background-color: #17a2b8; /* Info teal for testing */
        }

        /* CSV buttons */
        .csv-buttons-container button, .csv-buttons-container label {
            background-color: #6f42c1; /* A distinct purple for CSV actions */
            min-width: 150px;
        }
        #export-all-history-button {
            background-color: #20c997; /* A vibrant green-teal for global export */
        }
        #import-csv-input, #import-all-history-input, #import-md-input {
            display: none;
        }

        /* Chat history list footer buttons */
        .chat-history-list-footer .left-buttons,
        .chat-history-list-footer .right-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: nowrap;
        }
        .chat-history-list-footer button {
            min-width: 120px; /* Slightly larger min-width */
        }
        #select-all-history-button { background-color: #007bff; }
        #deselect-all-history-button { background-color: #6c757d; }
        #load-selected-history-button { background-color: #28a745; }
        #delete-selected-history-button { background-color: #dc3545; }
        .sort-controls button {
            background-color: #6c757d;
            min-width: unset; /* Don't force min-width here */
            padding: 8px 12px; /* Adjust padding for smaller button */
            border-radius: 20px;
        }
        .sort-controls button:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #download-pdf-button {
             background-color: #007bff;
        }

        .sort-order-icon {
            font-size: 1.1em;
            vertical-align: middle;
        }

        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-navigation {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
            flex-wrap: wrap; /* å°ã•ã„ç”»é¢ã§ã‚¿ãƒ–ã‚’æŠ˜ã‚Šè¿”ã™ */
            gap: 5px;
        }

        .tab-button {
            padding: 10px 15px;
            border: none;
            background-color: #f0f0f0;
            color: #555;
            cursor: pointer;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 1px solid #ddd;
            border-bottom: none;
            box-shadow: none; /* å…¨ä½“ãƒœã‚¿ãƒ³ã®å½±ã‚’ä¸Šæ›¸ã */
            margin-right: -1px; /* ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å°‘ã—é‡ã­ã‚‹ */
            min-width: unset; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®min-widthã‚’ãƒªã‚»ãƒƒãƒˆ */
        }

        .tab-button:hover {
            background-color: #e0e0e0;
            color: #333;
            transform: none; /* ãƒ›ãƒãƒ¼æ™‚ã®æµ®ãä¸ŠãŒã‚ŠåŠ¹æœã‚’å‰Šé™¤ */
            box-shadow: none;
            z-index: 1; /* ãƒ›ãƒãƒ¼ã—ãŸã‚¿ãƒ–ãŒæ‰‹å‰ã«æ¥ã‚‹ã‚ˆã†ã« */
        }

        .tab-button.active {
            background-color: #fff;
            color: #2e8b57;
            border-color: #2e8b57;
            border-bottom-color: #fff; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ä¸‹ç·šã‚’è¦‹ãˆãªãã™ã‚‹ */
            position: relative;
            z-index: 2; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã‚’å¸¸ã«æ‰‹å‰ã« */
        }

        /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-body {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ãŸã‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        }

        .tab-pane {
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯éè¡¨ç¤º */
            padding: 10px 0; /* ãƒšã‚¤ãƒ³å†…ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãŸã‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
        }

        .tab-pane.active {
            display: block; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒšã‚¤ãƒ³ã‚’è¡¨ç¤º */
        }
        /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */


        /* æ—¢å­˜ã®ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã¯ç¶­æŒã—ã¤ã¤ã€ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã«å¼·åŒ– */
        @media (max-width: 1250px) {
            .main-container {
                flex-direction: column;
                align-items: center;
                gap: 10px;
                padding: 10px;
                overflow-y: auto;
            }
            #side-panel {
                order: -2;
                width: 100%;
                max-width: 600px;
                margin-bottom: 10px;
            }
            .header-controls { justify-content: flex-end; }
            header h1 { font-size: 1.2em; }
        }

        /* æºå¸¯é›»è©±ï¼ˆç¸¦è¡¨ç¤ºï¼‰å‘ã‘ã®èª¿æ•´ */
        @media (max-width: 768px) {
            body {
                font-size: 0.9em;
            }
            header {
                padding: 8px 10px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            header h1 {
                font-size: 1.3em;
                margin-bottom: 5px;
            }
            .header-controls {
                width: 100%;
                justify-content: center;
            }
            .header-buttons {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            .header-buttons button {
                padding: 8px 15px; /* Adjust padding for smaller screens */
                font-size: 0.9em;
                min-width: unset; /* Allow buttons to shrink more */
                border-radius: 20px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .main-container {
                gap: 15px;
                padding: 10px;
            }

            #side-panel {
                width: 100%;
                max-width: 95%;
                padding: 15px;
            }
            .chat-container {
                width: 100%;
                max-width: 95%;
            }
            .message {
                max-width: 90%;
                padding: 8px 12px;
                font-size: 0.95em;
            }
            .timestamp {
                font-size: 0.7em;
            }

            /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®èª¿æ•´ */
            #text-input {
                min-height: 100px; /* ãƒ¢ãƒã‚¤ãƒ«ã§å…¥åŠ›æ¬„ã‚’å¤§ãã */
            }

            /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®èª¿æ•´ */
            .modal-content {
                width: calc(100% - 20px);
                margin: 10px auto;
                padding: 15px;
                max-height: 98vh;
            }
            #settings-modal .modal-content,
            #persona-modal .modal-content,
            #chat-history-list-modal .modal-content,
            #pdf-viewer-modal .modal-content {
                max-width: 95vw;
            }
            .modal-body {
                padding-right: 0;
            }
            /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ãƒ¢ãƒã‚¤ãƒ«æ™‚ã®ã‚¿ãƒ–è¡¨ç¤ºèª¿æ•´ */
            .tab-navigation {
                flex-direction: column; /* ã‚¿ãƒ–ã‚’ç¸¦ã«ç©ã‚€ */
                align-items: stretch;
            }
            .tab-button {
                border-radius: 8px; /* ç©ã¾ã‚ŒãŸã‚¿ãƒ–ã¯è§’ä¸¸ã‚’ä¿æŒ */
                margin-right: 0;
                margin-bottom: 5px;
                border-bottom: 1px solid #ddd; /* ä¸‹ç·šã‚‚è¡¨ç¤º */
            }
            .tab-button.active {
                border-bottom: 1px solid #2e8b57; /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã¯ä¸‹ç·šã‚’å¼·èª¿ */
            }
            /* â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… */

            .settings-columns {
                flex-direction: column;
                gap: 15px;
            }
            .name-setting-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .name-setting-container label {
                flex-basis: 100%;
                width: 100%;
                margin-bottom: 5px;
            }
            .csv-buttons-container {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            .csv-buttons-container button, .csv-buttons-container label {
                width: 100%;
                box-sizing: border-box;
                min-width: unset;
            }
            .sound-settings div {
                flex-wrap: wrap;
            }
            .sound-settings label {
                flex-basis: 100%;
            }

            #chat-history-search-input {
                width: calc(100% - 20px);
                margin: 10px 0;
            }
            #chat-history-list {
                max-height: 50vh;
            }
            .chat-history-list-footer {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .chat-history-list-footer .left-buttons,
            .chat-history-list-footer .right-buttons,
            .sort-controls {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 5px;
            }
            .chat-history-list-footer button,
            .sort-controls select, .sort-controls button {
                flex-grow: 1;
                flex-basis: calc(50% - 5px);
                box-sizing: border-box;
                min-width: unset;
                text-align: center;
            }
            .sort-controls label {
                flex-basis: 100%;
                text-align: left;
            }
            .sort-controls select, .sort-controls button {
                flex-basis: calc(50% - 5px);
            }
        }

        /* éå¸¸ã«å°ã•ã„æºå¸¯é›»è©±ï¼ˆä¾‹: iPhone SEãªã©ï¼‰å‘ã‘ã®è¿½åŠ èª¿æ•´ */
        @media (max-width: 480px) {
            header h1 {
                font-size: 1.1em;
            }
            .header-buttons button {
                font-size: 0.85em;
                padding: 6px 12px;
            }
            .main-container {
                padding: 5px;
            }
            #side-panel, .chat-container {
                padding: 10px;
            }
            .message {
                max-width: 95%;
            }
            #file-input-button, #mic-button, #send-button {
                width: 40px;
                height: 40px;
                font-size: 1.2em;
                line-height: 40px;
            }
            .modal-content {
                width: calc(100% - 10px);
                margin: 5px auto;
                padding: 10px;
            }
            /* ãƒ•ãƒƒã‚¿ãƒ¼ã®ãƒœã‚¿ãƒ³ã¯å…¨ã¦ç¸¦ã«ç©ã‚€ */
            .chat-history-list-footer .left-buttons button,
            .chat-history-list-footer .right-buttons button,
            .sort-controls select, .sort-controls button {
                flex-basis: 100%;
            }
        }


        /* å°åˆ·æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body { margin: 0; padding: 0; }
            header, #side-panel, .input-area, .modal, .chat-history-list-footer { display: none !important; }
            .main-container {
                display: block;
                padding: 0;
                margin: 0;
            }
            .chat-container { 
                border: none; 
                box-shadow: none; 
                max-width: none; 
                width: 100%; 
                background-color: #fff;
                backdrop-filter: none;
                overflow: visible;
            }
            #datetime-display { display: none; }
            .chat-box { 
                overflow: visible;
                padding: 10px;
            }
            /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€”ä¸­ã§æ”¹ãƒšãƒ¼ã‚¸ã—ãªã„è¨­å®š */
            .message, .chat-log .message { 
                box-shadow: none; 
                border: 1px solid #eee;
                margin-bottom: 5px;
                padding: 8px 12px; 
                border-radius: 8px; 
                max-width: 100%; 
                word-wrap: break-word; 
                page-break-inside: avoid;
            }
            .user-message { background-color: #e0f0e0; text-align: left; margin-left: 0; border-bottom-right-radius: 8px; border-bottom-left-radius: 5px;} /* ä¿®æ­£ç®‡æ‰€ */
            .bot-message { background-color: #f0f0f0; text-align: left; border-bottom-left-radius: 5px;}
            .chat-log .speaker { font-weight: bold; margin-bottom: 0px; display: block; }
            .chat-log .timestamp { font-size: 0.75em; color: #666; margin-top: 2px; display: block; text-align: right;}
            .message-content { margin-top: 2px; }
            
            .summary-message { background-color: #fff8e6; border: 1px solid #ffeeba; text-align: left; margin: 10px 0; }
            .summary-message h3 { font-size: 1.1em; margin-top: 0; margin-bottom: 5px; border-bottom: none; }
            .summary-message h2 { font-size: 1.4em; margin-top: 10px; margin-bottom: 5px; border-bottom: none; }
            .summary-message p { margin-top: 5px; margin-bottom: 0; }
            
            h1, h2, h3 { color: #2e8b57; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 15px; margin-bottom: 10px; }
            hr { border: 0; border-top: 1px dashed #ccc; margin: 15px 0; }
            .message-image { max-width: 80%; height: auto; border-radius: 5px; margin-top: 5px; display: block; margin-left: auto; margin-right: auto; }
            .chat-log { padding: 10px 0; }
        }
    </style>
</head>
<body>

<header>
    <h1>MyAI Chat History Ver2.10(ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ç‰ˆ)</h1> <!-- ã‚¿ã‚¤ãƒˆãƒ«ã«è¿½è¨˜ -->
    <div class="header-controls">
        <div class="header-buttons">
            <button id="persona-button">å„ç¨®è¨­å®š</button>
            <button id="delete-selected-button" style="display: none;">é¸æŠã‚’å‰Šé™¤</button>
            <button id="edit-selected-button" style="display: none;">é¸æŠã‚’ç·¨é›†</button>
            <button id="play-selected-button" style="display: none;">é¸æŠã‚’å†ç”Ÿ</button>
            <button id="stop-speech-button" style="display: none;">éŸ³å£°åœæ­¢</button>
            <button id="save-chat-summary-button">ãƒãƒ£ãƒƒãƒˆä¿å­˜</button>
            <button id="load-chat-history-button">å±¥æ­´ä¸€è¦§</button>
            <button id="print-pdf-button" style="display: none;">PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
            <button id="new-chat-button">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ</button>
            <button id="settings-button">APIè¨­å®š</button>
            <button id="help-button">å–æ‰±èª¬æ˜æ›¸</button>
        </div>
    </div>
</header>

<input type="file" id="image-file-input" style="display: none;" accept="image/*">
<input type="file" id="import-csv-input" style="display: none;" accept=".csv">
<input type="file" id="import-all-history-input" style="display: none;" accept=".json">
<input type="file" id="import-md-input" style="display: none;" accept=".md">


<div class="main-container">
    <div class="chat-container">
        <div id="datetime-display"></div>
        <div class="chat-box" id="chat-box"></div>
    </div>
    
    <div id="side-panel">
        <div class="input-area">
            <div id="image-preview-container">
                <img id="image-preview" src="" alt="Image Preview">
                <button id="remove-image-button">&times;</button>
            </div>
            <div class="input-controls">
                <div class="input-buttons-container">
                    <button id="file-input-button" title="ç”»åƒã‚’é¸æŠ">ğŸ“</button>
                    <button id="mic-button" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
                    <button id="send-button" title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡">âœˆï¸</button>
                </div>
                <textarea id="text-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã¾ãŸã¯ç”»åƒã‚’ãƒšãƒ¼ã‚¹ãƒˆ... (Shift+Enterã§æ”¹è¡Œ)"></textarea>
            </div>
        </div>
        <p style="font-size: 0.8em; color: #777; margin-top: 10px; text-align: center;">â€» ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¨è¨­å®šã¯PCãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜ãƒ»èª­è¾¼ã•ã‚Œã¾ã™ã€‚</p>
        <p style="font-size: 0.8em; color: #777; margin-top: 5px; text-align: center;">â€» APIã‚­ãƒ¼ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã”ã¨ã«å…¥åŠ›ãŒå¿…è¦ã§ã™ã€‚</p>
    </div>
</div>

<!-- å„ç¨®è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="persona-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-persona-modal">&times;</span>
        <h2>å„ç¨®è¨­å®š</h2>

        <!-- â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="history-file-management">å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</button>
            <button class="tab-button" data-tab="ai-response-settings">AIå¿œç­”è¨­å®š</button>
            <button class="tab-button" data-tab="app-behavior-settings">ã‚¢ãƒ—ãƒªå‹•ä½œè¨­å®š</button>
        </div>

        <div class="modal-body tab-body">
            <!-- å±¥æ­´ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç† Pane -->
            <div id="history-file-management" class="tab-pane active">
                <h3>å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    ã€Œå…¨å±¥æ­´ã‚’JSONã§ä¿å­˜ã€ã§å…¨ã¦ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã€ã€Œå…¨å±¥æ­´ã‚’JSONã‹ã‚‰èª­è¾¼ã€ã§ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
                    ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                </p>
                <div class="csv-buttons-container">
                    <button id="export-all-history-button" style="background-color: #20c997;">å…¨å±¥æ­´ã‚’JSONã§ä¿å­˜</button>
                    <label for="import-all-history-input" style="background-color: #6f42c1;">å…¨å±¥æ­´ã‚’JSONã‹ã‚‰èª­è¾¼</label>
                </div>
                <hr style="margin-top:20px; border-top:1px dashed #eee;">

                <h3>MDãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                    ã€Œãƒãƒ£ãƒƒãƒˆä¿å­˜ã€ã§ä½œæˆã—ãŸMarkdown (.md) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å±¥æ­´ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã™ã€‚
                </p>
                <div class="csv-buttons-container">
                    <label for="import-md-input" id="import-md-button" style="background-color: #6f42c1;">MDãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼</label>
                </div>
            </div>

            <!-- AIå¿œç­”è¨­å®š Pane -->
            <div id="ai-response-settings" class="tab-pane">
                <div class="settings-columns">
                    <div class="settings-column">
                        <h3>AIã®æ€§æ ¼ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰</h3>
                        <p>AIã®æŒ¯ã‚‹èˆã„ã‚’æŒ‡å®šã™ã‚‹æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
                        <textarea id="persona-textarea" placeholder="ä¾‹ï¼šã‚ãªãŸã¯è¦ªåˆ‡ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚çµµæ–‡å­—ã‚’ãŸãã•ã‚“ä½¿ã£ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åŠ±ã¾ã—ã¦ãã ã•ã„ã€‚"></textarea>
                        <div class="examples-container">
                            <p>è¨­å®šä¾‹:</p>
                            <button class="persona-example-btn" data-persona="ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ã€è¦ªåˆ‡ã§å„ªã—ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚å¸¸ã«ä¸å¯§ãªè¨€è‘‰é£ã„ã‚’å¿ƒãŒã‘ã¦ãã ã•ã„ã€‚">å„ªã—ã„ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</button>
                            <button class="persona-example-btn" data-persona="ã‚ãªãŸã¯ç‰¹å®šã®åˆ†é‡ã®å°‚é–€å®¶ã§ã™ã€‚è³ªå•ã«å¯¾ã—ã¦ã€å°‚é–€ç”¨èªã‚’äº¤ãˆã¤ã¤ã€å¸¸ã«ç°¡æ½”ã‹ã¤æ­£ç¢ºã«ç­”ãˆã¦ãã ã•ã„ã€‚">ç°¡æ½”ãªå°‚é–€å®¶</button>
                            <button class="persona-example-btn" data-persona="ã‚ã‚“ãŸã¯é–¢è¥¿å¼ã‚’è©±ã™ã€æ°—ã•ããªå‹é”ã‚„ã§ã€‚ã‚¿ãƒ¡å£ã§ã€ãŸã¾ã«å†—è«‡ã‚’äº¤ãˆãªãŒã‚‰è¿”äº‹ã—ã¦ãªã€‚">é–¢è¥¿å¼ã®å‹é”</button>
                        </div>
                    </div>
                    <div class="settings-column">
                        <h3>ãƒãƒ£ãƒƒãƒˆæ¦‚è¦ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</h3>
                        <p>ãƒãƒ£ãƒƒãƒˆä¿å­˜æ™‚ã®æ¦‚è¦ç”ŸæˆAIã¸ã®æŒ‡ç¤ºã§ã™ã€‚<br><code>{CONVERSATION_HISTORY}</code>ã«ä¼šè©±å±¥æ­´ãŒæŒ¿å…¥ã•ã‚Œã¾ã™ã€‚</p>
                        <textarea id="summary-prompt-textarea" placeholder="ä¾‹ï¼šä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  &quot;title&quot;: &quot;ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)&quot;,\n  &quot;summary&quot;: &quot;ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)&quot;\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---"></textarea>
                        <button id="reset-summary-prompt-button" style="margin-top: 10px; background-color: #6c757d; color: white; padding: 10px 18px; border: none; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(0,0,0,0.15); white-space: nowrap;">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>

                        <h3>ä¼šè©±å±¥æ­´ã®åå‰è¨­å®š</h3>
                        <div class="name-setting-container" style="margin-bottom: 10px;">
                            <label for="user-name-input">ã‚ãªãŸã®åå‰:</label>
                            <input type="text" id="user-name-input" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼">
                        </div>
                        <div class="name-setting-container">
                            <label for="ai-name-input">AIã®åå‰:</label>
                            <input type="text" id="ai-name-input" placeholder="AI">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚¢ãƒ—ãƒªå‹•ä½œè¨­å®š Pane -->
            <div id="app-behavior-settings" class="tab-pane">
                <div class="settings-columns">
                    <div class="settings-column">
                        <h3>ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h3>
                        <div class="sound-settings">
                            <div>
                                <input type="checkbox" id="sound-on-off" checked>
                                <label for="sound-on-off">AIå¿œç­”æ™‚ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’é³´ã‚‰ã™</label>
                            </div>
                            <div>
                                <label for="sound-type-select">ã‚µã‚¦ãƒ³ãƒ‰ã®ç¨®é¡:</label>
                                <select id="sound-type-select">
                                    <option value="sine">ã‚µã‚¤ãƒ³æ³¢ (æ¨™æº–)</option>
                                    <option value="square">çŸ©å½¢æ³¢ (ãƒ”ã‚³ãƒ”ã‚³)</option>
                                    <option value="sawtooth">ã®ã“ãã‚Šæ³¢ (ãƒ–ã‚¶ãƒ¼)</option>
                                    <option value="triangle">ä¸‰è§’æ³¢ (ãƒã‚¤ãƒ«ãƒ‰)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="settings-column">
                        <div class="sound-settings" style="margin-top: 0;">
                            <div>
                                <input type="checkbox" id="tts-on-off" checked>
                                <label for="tts-on-off">AIå¿œç­”ã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã‚‹</label>
                            </div>
                            <div>
                                <label for="tts-voice-select">éŸ³å£°ã®ç¨®é¡:</label>
                                <select id="tts-voice-select"></select>
                            </div>
                            <div>
                                <label for="tts-rate-input">é€Ÿåº¦:</label>
                                <input type="range" id="tts-rate-input" min="0.1" max="2" step="0.1" value="1">
                                <span id="tts-rate-value">1.0</span>
                            </div>
                            <div>
                                <label for="tts-pitch-input">ãƒ”ãƒƒãƒ:</label>
                                <input type="range" id="tts-pitch-input" min="0" max="2" step="0.1" value="1">
                                <span id="tts-pitch-value">1.0</span>
                            </div>
                            <div>
                                <label for="tts-volume-input">éŸ³é‡:</label>
                                <input type="range" id="tts-volume-input" min="0" max="1" step="0.1" value="1">
                                <span id="tts-volume-value">1.0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <hr style="margin-top:20px; border-top:1px dashed #eee;">
                <p style="font-size: 0.9em; color: #666; margin-top: 20px; margin-bottom: 10px;">
                    ã€Œè¨­å®šã‚’CSVã§ä¿å­˜ã€ã§ä¸Šè¨˜è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã€ã€Œè¨­å®šã‚’CSVã‹ã‚‰èª­è¾¼ã€ã§ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
                    ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è¨­å®šãŒåæ˜ ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
                </p>
                <div class="csv-buttons-container">
                    <button id="export-csv-button" style="background-color: #6f42c1;">è¨­å®šã‚’CSVã§ä¿å­˜</button>
                    <label for="import-csv-input" id="import-csv-button" style="background-color: #6f42c1;">è¨­å®šã‚’CSVã‹ã‚‰èª­è¾¼</label>
                </div>
            </div>
        </div>
        <!-- â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜… -->

        <div class="modal-buttons">
            <div></div>
            <div class="right-buttons">
                 <button id="save-settings-button">é–‰ã˜ã‚‹</button> <!-- ã€Œä¿å­˜ã€ã§ã¯ãªãã€Œé–‰ã˜ã‚‹ã€ã«å¤‰æ›´ -->
            </div>
        </div>
    </div>
</div>

<!-- APIã‚­ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-settings-modal">&times;</span>
        <h2>Gemini APIã‚­ãƒ¼è¨­å®š</h2>
        <div class="modal-body">
            <p>ã“ã“ã«å–å¾—ã—ãŸGemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                â€» APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã§ãã¾ã™ãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã«æ‰‹å‹•å…¥åŠ›ã¾ãŸã¯CSVã§ã®è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚ä¿å­˜ã—ãŸå ´åˆã§ã‚‚ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
            </p>
            <input type="password" id="api-key-input" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›...">
            <div id="test-key-result"></div>
        </div>
        <div class="modal-buttons">
            <button id="delete-key-button">ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button> <!-- ã€Œå‰Šé™¤ã€ã‹ã‚‰ã€Œã‚¯ãƒªã‚¢ã€ã«å¤‰æ›´ -->
            <div class="right-buttons">
                <button id="test-key-button">APIã‚­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ</button>
                <button id="save-key-button">è¨­å®š</button> <!-- ã€Œä¿å­˜ã€ã‹ã‚‰ã€Œè¨­å®šã€ã«å¤‰æ›´ -->
            </div>
        </div>
    </div>
</div>

<!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-message-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-edit-message-modal">&times;</span>
        <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç·¨é›†</h2>
        <div class="modal-body">
            <textarea id="edit-message-textarea" style="width: 100%; height: 150px; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;"></textarea>
            <button id="save-edited-message-button" style="background-color: #28a745; color: white; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="chat-history-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="close-chat-history-list-modal">&times;</span>
        <h2>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ä¸€è¦§</h2>
        <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
            ã“ã®ãƒªã‚¹ãƒˆã¯ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã€‚ã€Œå„ç¨®è¨­å®šã€ã‹ã‚‰JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚<br>
            ã“ã“ã§ã®å¤‰æ›´ï¼ˆèª­ã¿è¾¼ã¿ã€å‰Šé™¤ï¼‰ã¯ã€å†åº¦JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãªã„ã¨ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚
        </p>
        <input type="text" id="chat-history-search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚„æ—¥ä»˜ã§æ¤œç´¢...">
        <ul id="chat-history-list">
            <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </ul>
        <div class="chat-history-list-footer">
            <div class="left-buttons">
                <button id="select-all-history-button">å…¨é¸æŠ</button>
                <button id="deselect-all-history-button">å…¨è§£é™¤</button>
                <button id="load-selected-history-button">é¸æŠã‚’èª­è¾¼</button>
            </div>
            <div class="sort-controls">
                <label for="sort-by-select">ä¸¦ã¹æ›¿ãˆ:</label>
                <select id="sort-by-select">
                    <option value="date">æ—¥ä»˜</option>
                    <option value="title">ã‚¿ã‚¤ãƒˆãƒ«</option>
                </select>
                <button id="sort-order-button">
                    <span id="sort-order-icon" class="sort-order-icon">â†“</span>
                </button>
            </div>
            <div class="right-buttons">
                <button id="delete-selected-history-button">é¸æŠã‚’å‰Šé™¤</button>
            </div>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div id="pdf-viewer-modal" class="modal">
    <div class="modal-content" style="max-width: 90%; height: 90vh;">
        <span class="close-button" id="close-pdf-viewer-modal">&times;</span>
        <h2>PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
        <div class="modal-body" style="flex-grow: 1; display: flex; flex-direction: column;">
            <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">
                <strong>ğŸ’¡ã”æ³¨æ„:</strong> æ­£ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã«ã¯ã€ä¸‹ã®ã€ŒPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
                ãƒ–ãƒ©ã‚¦ã‚¶ã®PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãŒæä¾›ã™ã‚‹ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã§ã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åãŒæ„å›³ã—ãªã„ã‚‚ã®ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
            </p>
            <iframe id="pdf-frame" style="width: 100%; height: 100%; border: none;"></iframe>
        </div>
        <div class="modal-buttons">
            <button id="download-pdf-button" style="background-color: #007bff; color: white; padding: 8px 15px; border: none; border-radius: 44px; cursor: pointer; font-weight: bold;">PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    // DOMè¦ç´ ã®å–å¾—
    const chatBox = document.getElementById('chat-box');
    const textInput = document.getElementById('text-input');
    const sendButton = document.getElementById('send-button');
    const micButton = document.getElementById('mic-button');
    const saveChatSummaryButton = document.getElementById('save-chat-summary-button');
    const loadChatHistoryButton = document.getElementById('load-chat-history-button');
    const printPdfButton = document.getElementById('print-pdf-button');
    const newChatButton = document.getElementById('new-chat-button');
    const helpButton = document.getElementById('help-button');
    const datetimeDisplay = document.getElementById('datetime-display');
    const imageFileInput = document.getElementById('image-file-input');
    const fileInputButton = document.getElementById('file-input-button');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeImageButton = document.getElementById('remove-image-button');
    const userNameInput = document.getElementById('user-name-input');
    const aiNameInput = document.getElementById('ai-name-input'); 
    const deleteSelectedButton = document.getElementById('delete-selected-button');
    const editSelectedButton = document.getElementById('edit-selected-button');
    const playSelectedButton = document.getElementById('play-selected-button');
    const stopSpeechButton = document.getElementById('stop-speech-button');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®DOMè¦ç´ 
    const personaButton = document.getElementById('persona-button');
    const personaModal = document.getElementById('persona-modal');
    const closePersonaModal = document.getElementById('close-persona-modal');
    const personaTextarea = document.getElementById('persona-textarea');
    const saveSettingsButton = document.getElementById('save-settings-button');
    const personaExampleBtns = document.querySelectorAll('.persona-example-btn');
    const settingsButton = document.getElementById('settings-button');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsModal = document.getElementById('close-settings-modal');
    const apiKeyInput = document.getElementById('api-key-input');
    const saveKeyButton = document.getElementById('save-key-button');
    const soundOnOff = document.getElementById('sound-on-off');
    const soundTypeSelect = document.getElementById('sound-type-select');
    const testKeyButton = document.getElementById('test-key-button');
    const deleteKeyButton = document.getElementById('delete-key-button');
    const testKeyResult = document.getElementById('test-key-result');
    const summaryPromptTextarea = document.getElementById('summary-prompt-textarea');
    const resetSummaryPromptButton = document.getElementById('reset-summary-prompt-button'); // â˜…è¿½åŠ 

    // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£
    const importCsvInput = document.getElementById('import-csv-input');
    const exportCsvButton = document.getElementById('export-csv-button');

    // å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£
    const exportAllHistoryButton = document.getElementById('export-all-history-button');
    const importAllHistoryInput = document.getElementById('import-all-history-input');
    
    // MDãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£
    const importMdInput = document.getElementById('import-md-input');
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const editMessageModal = document.getElementById('edit-message-modal');
    const closeEditMessageModal = document.getElementById('close-edit-message-modal');
    const editMessageTextarea = document.getElementById('edit-message-textarea');
    const saveEditedMessageButton = document.getElementById('save-edited-message-button');
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒªã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const chatHistoryListModal = document.getElementById('chat-history-list-modal');
    const closeChatHistoryListModal = document.getElementById('close-chat-history-list-modal');
    const chatHistoryList = document.getElementById('chat-history-list');
    const chatHistorySearchInput = document.getElementById('chat-history-search-input');
    const selectAllHistoryButton = document.getElementById('select-all-history-button');
    const deselectAllHistoryButton = document.getElementById('deselect-all-history-button');
    const deleteSelectedHistoryButton = document.getElementById('delete-selected-history-button');
    const loadSelectedHistoryButton = document.getElementById('load-selected-history-button');
    
    // ä¸¦ã¹æ›¿ãˆé–¢é€£ã®DOMè¦ç´ 
    const sortBySelect = document.getElementById('sort-by-select');
    const sortOrderButton = document.getElementById('sort-order-button');
    const sortOrderIcon = document.getElementById('sort-order-icon');

    // PDF Viewer Modalé–¢é€£
    const pdfViewerModal = document.getElementById('pdf-viewer-modal');
    const closePdfViewerModal = document.getElementById('close-pdf-viewer-modal');
    const pdfFrame = document.getElementById('pdf-frame');
    const downloadPdfButton = document.getElementById('download-pdf-button');

    // TTSé–¢é€£ã®DOMè¦ç´ 
    const ttsOnOff = document.getElementById('tts-on-off');
    const ttsVoiceSelect = document.getElementById('tts-voice-select');
    const ttsRateInput = document.getElementById('tts-rate-input');
    const ttsRateValue = document.getElementById('tts-rate-value');
    const ttsPitchInput = document.getElementById('tts-pitch-input');
    const ttsPitchValue = document.getElementById('tts-pitch-value');
    const ttsVolumeInput = document.getElementById('tts-volume-input');
    const ttsVolumeValue = document.getElementById('tts-volume-value');

    // â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ã‚¿ãƒ–é–¢é€£ã®DOMè¦ç´ 
    const tabNavigation = document.querySelector('.tab-navigation');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabPanes = document.querySelectorAll('.tab-pane');
    // â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜…

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentApiKey = ''; // APIã‚­ãƒ¼ã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿ä¿æŒ
    let currentConversationHistory = []; // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼‰
    let allChatSummaries = []; // èª­ã¿è¾¼ã¾ã‚ŒãŸå…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®æ¦‚è¦ãƒªã‚¹ãƒˆï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼‰
    let attachedImage = null;
    let editingMessageElement = null;
    let currentActiveSummaryData = null; // ç¾åœ¨è¡¨ç¤ºä¸­ã®æ¦‚è¦ãƒ‡ãƒ¼ã‚¿
    let currentChatUniqueId = null; // â˜…è¿½åŠ ï¼šç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
    let currentSortBy = 'date'; // å±¥æ­´ãƒªã‚¹ãƒˆã®ä¸¦ã¹æ›¿ãˆåŸºæº–
    let currentSortOrder = 'desc'; // å±¥æ­´ãƒªã‚¹ãƒˆã®ä¸¦ã¹æ›¿ãˆé †
    let ttsEnabled = true;
    let selectedTtsVoice = null;
    let availableVoices = [];
    let ttsRate = 1.0;
    let ttsPitch = 1.0;
    let ttsVolume = 1.0;

    // localStorageã®ã‚­ãƒ¼
    const SETTINGS_KEY = 'myAISettings';

    // --- localStorageã¸ã®è¨­å®šä¿å­˜é–¢æ•° ---
    function saveAllSettingsToLocalStorage() {
        const settings = {
            apiKey: currentApiKey,
            persona: personaTextarea.value.trim(),
            summaryPrompt: summaryPromptTextarea.value.trim(),
            userName: userNameInput.value.trim(),
            aiName: aiNameInput.value.trim(),
            soundEnabled: soundOnOff.checked,
            soundType: soundTypeSelect.value,
            ttsEnabled: ttsOnOff.checked,
            ttsVoiceName: ttsVoiceSelect.value,
            ttsRate: parseFloat(ttsRateInput.value),
            ttsPitch: parseFloat(ttsPitchInput.value),
            ttsVolume: parseFloat(ttsVolumeInput.value),
            chatHistorySortBy: currentSortBy,
            chatHistorySortOrder: currentSortOrder
        };
        try {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
            console.log('è¨­å®šã‚’localStorageã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
        } catch (e) {
            console.error('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
            // alert('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®¹é‡ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); // alertã¯é »ç¹ã«å‡ºã•ãªã„
        }
    }

    // --- localStorageã‹ã‚‰ã®è¨­å®šèª­ã¿è¾¼ã¿é–¢æ•° ---
    function loadAllSettingsFromLocalStorage() {
        try {
            const storedSettings = localStorage.getItem(SETTINGS_KEY);
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);

                currentApiKey = settings.apiKey || '';
                apiKeyInput.value = currentApiKey;

                personaTextarea.value = settings.persona || '';
                summaryPromptTextarea.value = settings.summaryPrompt || '';

                userNameInput.value = settings.userName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                aiNameInput.value = settings.aiName || 'AI';

                soundOnOff.checked = typeof settings.soundEnabled === 'boolean' ? settings.soundEnabled : true;
                soundTypeSelect.value = settings.soundType || 'sine';

                ttsOnOff.checked = typeof settings.ttsEnabled === 'boolean' ? settings.ttsEnabled : true;
                ttsEnabled = ttsOnOff.checked;

                // ttsVoiceSelect.value ã¯ loadVoices() ã§è¨­å®šã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯æ–‡å­—åˆ—ã‚’ä¿æŒã™ã‚‹ã ã‘
                ttsVoiceSelect.value = settings.ttsVoiceName || '';
                
                ttsRate = settings.ttsRate !== undefined ? parseFloat(settings.ttsRate) : 1.0;
                ttsPitch = settings.ttsPitch !== undefined ? parseFloat(settings.ttsPitch) : 1.0;
                ttsVolume = settings.ttsVolume !== undefined ? parseFloat(settings.ttsVolume) : 1.0;
                
                ttsRateInput.value = ttsRate;
                ttsRateValue.textContent = ttsRate.toFixed(1);
                ttsPitchInput.value = ttsPitch;
                ttsPitchValue.textContent = ttsPitch.toFixed(1);
                ttsVolumeInput.value = ttsVolume;
                ttsVolumeValue.textContent = ttsVolume.toFixed(1);

                currentSortBy = settings.chatHistorySortBy || 'date';
                currentSortOrder = settings.chatHistorySortOrder || 'desc';
                
                // UIè¦ç´ ã«åæ˜ 
                sortBySelect.value = currentSortBy;
                sortOrderIcon.textContent = (currentSortOrder === 'asc' ? 'â†‘' : 'â†“');

                console.log('è¨­å®šã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                return true; // è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚ŒãŸ
            }
        } catch (e) {
            console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', e);
            // Fallback to default if loading fails
        }
        return false; // è¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œãªã‹ã£ãŸã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ
    }

    // --- åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        const settingsLoaded = loadAllSettingsFromLocalStorage(); // localStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€

        if (!settingsLoaded) { // èª­ã¿è¾¼ã¾ã‚Œãªã‹ã£ãŸå ´åˆã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨
            loadSettingsFromMemoryOrDefault(); // æ—¢å­˜ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤é©ç”¨ãƒ­ã‚¸ãƒƒã‚¯
        }

        loadVoices(); // éŸ³å£°ãƒªã‚¹ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰
        updateSpeechControlButtonVisibility();

        // åˆæœŸãƒãƒ£ãƒƒãƒˆè¡¨ç¤º (APIã‚­ãƒ¼ãŒãªã‘ã‚Œã°è¨­å®šã‚’ä¿ƒã™)
        startNewChat(true); 

        // â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ã‚¿ãƒ–ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
        tabPanes.forEach((pane, index) => {
            if (index === 0) {
                pane.classList.add('active');
            } else {
                pane.classList.remove('active');
            }
        });
        tabButtons.forEach((button, index) => {
            if (index === 0) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }
        });
        // â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜…
    });

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---

    newChatButton.addEventListener('click', () => startNewChat(false));
    saveChatSummaryButton.addEventListener('click', () => { if (checkApiKey()) createChatSummary(); });
    loadChatHistoryButton.addEventListener('click', () => { 
        displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);
        chatHistoryListModal.style.display = 'block'; 
    });
    
    printPdfButton.addEventListener('click', () => {
        if (!currentActiveSummaryData) {
            alert("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ£ãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹ã‹ã€å±¥æ­´ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚");
            return;
        }
        showPdfPreviewOfChatSummary();
    });
    
    helpButton.addEventListener('click', showHelp);
    
    function sendMessage() {
        if (textInput.value.trim() !== '' || attachedImage) {
            if (!checkApiKey()) return;
            handleUserInput(textInput.value);
            textInput.value = '';
        }
    }
    
    sendButton.addEventListener('click', sendMessage);
    textInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    textInput.addEventListener('paste', handlePaste);
    fileInputButton.addEventListener('click', () => imageFileInput.click());
    imageFileInput.addEventListener('change', handleFileSelect);
    removeImageButton.addEventListener('click', removeAttachedImage);
    
    settingsButton.addEventListener('click', () => {
        testKeyResult.textContent = '';
        testKeyResult.className = '';
        settingsModal.style.display = 'block';
    });
    closeSettingsModal.addEventListener('click', () => {
        settingsModal.style.display = 'none';
        saveAllSettingsToLocalStorage(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã¨ãã«è¨­å®šã‚’ä¿å­˜
    });
    saveKeyButton.addEventListener('click', () => {
        const newKey = apiKeyInput.value.trim();
        if (newKey) {
            currentApiKey = newKey; // APIã‚­ãƒ¼ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
            saveAllSettingsToLocalStorage(); // è¨­å®šã‚’localStorageã«ä¿å­˜
            settingsModal.style.display = 'none';
            alert('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã—ã¾ã—ãŸã€‚');
        } else {
            alert('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
    });
    testKeyButton.addEventListener('click', testApiKey);
    deleteKeyButton.addEventListener('click', () => {
        if (confirm('ç¾åœ¨ã®APIã‚­ãƒ¼è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            currentApiKey = ''; 
            apiKeyInput.value = ''; 
            saveAllSettingsToLocalStorage(); // APIã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¦localStorageã«ä¿å­˜
            alert('APIã‚­ãƒ¼è¨­å®šã‚’ã‚¯ãƒªã‚¢ã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            testKeyResult.textContent = ''; 
            testKeyResult.className = '';
        }
    });

    personaButton.addEventListener('click', () => {
        personaModal.style.display = 'block';
        loadVoices(); // éŸ³å£°ãƒªã‚¹ãƒˆã‚’å†ãƒ­ãƒ¼ãƒ‰ã—ã¦UIã«è¡¨ç¤º
    });

    closePersonaModal.addEventListener('click', () => { 
        personaModal.style.display = 'none'; 
        saveAllSettingsToLocalStorage(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã¨ãã«è¨­å®šã‚’ä¿å­˜
    });
    // ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã€Œé–‰ã˜ã‚‹ã€ã«å¤‰æ›´ã€‚è¨­å®šã¯UIã«ç›´æ¥åæ˜ ã•ã‚Œã‚‹
    saveSettingsButton.addEventListener('click', () => {
        // UIè¦ç´ ã®å€¤ã‚’ç›´æ¥ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°/UIã«åæ˜ ã•ã›ã‚‹ (ã“ã‚Œã¯æ—¢ã«DOMã«ãƒã‚¤ãƒ³ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã®ã§å®Ÿè³ªä¸è¦ã ãŒã€æ˜ç¤ºçš„ã«)
        // ã“ã“ã§ã®è¨­å®šå€¤ã®èª­ã¿è¾¼ã¿ã¯ã€ä¸»ã« saveAllSettingsToLocalStorage ã§è¡Œã‚ã‚Œã‚‹
        ttsEnabled = ttsOnOff.checked; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
        selectedTtsVoice = availableVoices.find(voice => voice.name === ttsVoiceSelect.value) || null; // é¸æŠã•ã‚ŒãŸéŸ³å£°ã‚’æ›´æ–°
        ttsRate = parseFloat(ttsRateInput.value);
        ttsPitch = parseFloat(ttsPitchInput.value);
        ttsVolume = parseFloat(ttsVolumeInput.value);

        saveAllSettingsToLocalStorage(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã¨ãã«è¨­å®šã‚’ä¿å­˜
        personaModal.style.display = 'none';
        alert('è¨­å®šã‚’é–‰ã˜ã¾ã—ãŸã€‚å¤‰æ›´ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
    });
    personaExampleBtns.forEach(btn => {
        btn.addEventListener('click', () => { 
            personaTextarea.value = btn.dataset.persona; 
            saveAllSettingsToLocalStorage(); // ä¾‹æ–‡é©ç”¨æ™‚ã«è¨­å®šã‚’ä¿å­˜
        });
    });

    // å„è¨­å®šè¦ç´ ã®å¤‰æ›´æ™‚ã«localStorageã«ä¿å­˜
    personaTextarea.addEventListener('change', saveAllSettingsToLocalStorage);
    summaryPromptTextarea.addEventListener('change', saveAllSettingsToLocalStorage);
    userNameInput.addEventListener('change', saveAllSettingsToLocalStorage);
    aiNameInput.addEventListener('change', saveAllSettingsToLocalStorage);
    soundOnOff.addEventListener('change', saveAllSettingsToLocalStorage);
    soundTypeSelect.addEventListener('change', saveAllSettingsToLocalStorage);
    ttsOnOff.addEventListener('change', () => {
        ttsEnabled = ttsOnOff.checked;
        saveAllSettingsToLocalStorage();
        if (!ttsEnabled) {
            window.speechSynthesis.cancel();
        }
        updateSpeechControlButtonVisibility();
    });
    ttsVoiceSelect.addEventListener('change', () => {
        const selectedName = ttsVoiceSelect.value;
        selectedTtsVoice = availableVoices.find(voice => voice.name === selectedName) || null;
        saveAllSettingsToLocalStorage();
    });
    ttsRateInput.addEventListener('input', () => { // inputã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        ttsRate = parseFloat(ttsRateInput.value);
        ttsRateValue.textContent = ttsRate.toFixed(1);
        saveAllSettingsToLocalStorage(); // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚ã«è¨­å®šã‚’ä¿å­˜
    });
    ttsPitchInput.addEventListener('input', () => { // inputã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        ttsPitch = parseFloat(ttsPitchInput.value);
        ttsPitchValue.textContent = ttsPitch.toFixed(1);
        saveAllSettingsToLocalStorage(); // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚ã«è¨­å®šã‚’ä¿å­˜
    });
    ttsVolumeInput.addEventListener('input', () => { // inputã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
        ttsVolume = parseFloat(ttsVolumeInput.value);
        ttsVolumeValue.textContent = ttsVolume.toFixed(1);
        saveAllSettingsToLocalStorage(); // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œæ™‚ã«è¨­å®šã‚’ä¿å­˜
    });

    // â˜…è¿½åŠ : ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    resetSummaryPromptButton.addEventListener('click', () => {
        const defaultSummaryPrompt = `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  "title": "ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)",\n  "summary": "ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)"\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---`;
        summaryPromptTextarea.value = defaultSummaryPrompt;
        saveAllSettingsToLocalStorage(); // ãƒªã‚»ãƒƒãƒˆã—ãŸå€¤ã‚’localStorageã«ä¿å­˜
        alert('ãƒãƒ£ãƒƒãƒˆæ¦‚è¦ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚');
    });


    exportCsvButton.addEventListener('click', exportSettingsAsCsv);
    importCsvInput.addEventListener('change', importSettingsFromCsv);

    exportAllHistoryButton.addEventListener('click', exportAllChatSummaries);
    importAllHistoryInput.addEventListener('change', importAllChatSummaries);

    // MDãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    importMdInput.addEventListener('change', importMarkdownFile);

    deleteSelectedButton.addEventListener('click', deleteSelectedMessages);
    editSelectedButton.addEventListener('click', openEditMessageModal);
    playSelectedButton.addEventListener('click', playSelectedMessages);
    stopSpeechButton.addEventListener('click', () => {
        window.speechSynthesis.cancel();
        updateSpeechControlButtonVisibility();
    });

    micButton.addEventListener('click', () => {
        if (!checkApiKey()) return;
        if (isRecording) {
            recognition.stop();
        } else {
            recognition.start();
        }
    });

    window.addEventListener('click', (event) => {
        if (event.target == personaModal) { 
            personaModal.style.display = 'none';
            saveAllSettingsToLocalStorage(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã¨ãã«è¨­å®šã‚’ä¿å­˜
        }
        if (event.target == settingsModal) {
            settingsModal.style.display = 'none';
            saveAllSettingsToLocalStorage(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ã¨ãã«è¨­å®šã‚’ä¿å­˜
        }
        if (event.target == editMessageModal) editMessageModal.style.display = 'none';
        if (event.target == pdfViewerModal) {
            pdfViewerModal.style.display = 'none';
            pdfFrame.src = '';
        }
    });
    
    closeChatHistoryListModal.addEventListener('click', () => { chatHistoryListModal.style.display = 'none'; });
    chatHistorySearchInput.addEventListener('input', () => displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder));
    
    sortBySelect.addEventListener('change', (event) => {
        currentSortBy = event.target.value;
        saveAllSettingsToLocalStorage(); // ä¸¦ã¹æ›¿ãˆè¨­å®šã‚’localStorageã«ä¿å­˜
        displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);
    });

    sortOrderButton.addEventListener('click', () => {
        currentSortOrder = (currentSortOrder === 'asc' ? 'desc' : 'asc');
        saveAllSettingsToLocalStorage(); // ä¸¦ã¹æ›¿ãˆè¨­å®šã‚’localStorageã«ä¿å­˜
        sortOrderIcon.textContent = (currentSortOrder === 'asc' ? 'â†‘' : 'â†“');
        displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);
    });

    selectAllHistoryButton.addEventListener('click', () => {
        document.querySelectorAll('.history-item-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    });
    deselectAllHistoryButton.addEventListener('click', () => {
        document.querySelectorAll('.history-item-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    });
    deleteSelectedHistoryButton.addEventListener('click', () => {
        const checkedCheckboxes = document.querySelectorAll('.history-item-checkbox:checked');
        if (checkedCheckboxes.length === 0) {
            alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        if (confirm(`${checkedCheckboxes.length}ä»¶ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®å¤‰æ›´ã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã¾ã§æ°¸ç¶šåŒ–ã•ã‚Œã¾ã›ã‚“ã€‚`)) {
            // data-filename ã‹ã‚‰ data-chatid ã‚’å–å¾—
            const chatIdsToDelete = Array.from(checkedCheckboxes).map(checkbox => checkbox.dataset.chatid);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ chatId ã‚’ä½¿ã£ã¦å‰Šé™¤
            allChatSummaries = allChatSummaries.filter(summary => !chatIdsToDelete.includes(summary.chatId)); 
            
            displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);
            alert(`${checkedCheckboxes.length}ä»¶ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Œå…¨å±¥æ­´ã‚’JSONã§ä¿å­˜ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`);
        }
    });
    loadSelectedHistoryButton.addEventListener('click', () => {
        const checkedCheckboxes = document.querySelectorAll('.history-item-checkbox:checked');
        if (checkedCheckboxes.length === 0) {
            alert('èª­ã¿è¾¼ã‚€é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        let selectedSummaries = [];
        checkedCheckboxes.forEach(checkbox => {
            // data-filename ã‹ã‚‰ data-chatid ã‚’å–å¾—
            const chatIdToLoad = checkbox.dataset.chatid;
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ chatId ã‚’ä½¿ã£ã¦æ¤œç´¢
            const summary = allChatSummaries.find(s => s.chatId === chatIdToLoad); 
            if (summary) {
                selectedSummaries.push(summary);
            }
        });

        if (selectedSummaries.length > 0) {
            selectedSummaries.sort((a, b) => new Date(b.date) - new Date(a.date));
            loadChatFromSummary(selectedSummaries[0]);
            chatHistoryListModal.style.display = 'none';
            alert(`ã€Œ${selectedSummaries[0].title}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
        } else {
            alert('æœ‰åŠ¹ãªå±¥æ­´ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
        }
    });

    closePdfViewerModal.addEventListener('click', () => {
        pdfViewerModal.style.display = 'none';
        pdfFrame.src = '';
    });

    // TTSé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ä¸Šã§çµ±åˆæ¸ˆã¿

    // --- ãƒãƒ£ãƒƒãƒˆé–¢é€£ã®é–¢æ•° ---

    function startNewChat(isInitial) {
        if (!isInitial && currentConversationHistory.length > 0) {
            if (!confirm("ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆä¿å­˜ã—ã¦ã„ãªã„å ´åˆã¯å¤±ã‚ã‚Œã¾ã™ï¼‰")) {
                return;
            }
        }
        chatBox.innerHTML = '';
        currentConversationHistory = []; // ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
        
        saveChatSummaryButton.style.display = 'inline-flex';
        loadChatHistoryButton.style.display = 'inline-flex';
        printPdfButton.style.display = 'none';
        newChatButton.style.display = 'inline-flex';
        
        deleteSelectedButton.style.display = 'none';
        editSelectedButton.style.display = 'none';
        playSelectedButton.style.display = 'none';
        stopSpeechButton.style.display = 'none';

        currentActiveSummaryData = null;
        // â˜…è¿½åŠ ï¼šæ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯IDã‚’ç”Ÿæˆ
        currentChatUniqueId = crypto.randomUUID(); 
        removeAttachedImage();

        if (isInitial && !currentApiKey) {
            addMessage("ã“ã‚“ã«ã¡ã¯ï¼ã€ŒAPIè¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚", 'bot');
            speakText("ã“ã‚“ã«ã¡ã¯ï¼APIè¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
        } else {
            const userName = userNameInput.value || 'ã‚ãªãŸ'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
            const aiName = aiNameInput.value || 'AI'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
            const greetingMessage = `ã“ã‚“ã«ã¡ã¯ã€${userName}ã•ã‚“ï¼${aiName}ã§ã™ã€‚ä½•ã§ã‚‚è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚`;
            addMessage(greetingMessage, 'bot');
            speakText(greetingMessage);
        }
        textInput.focus();
        updateDeleteButtonVisibility();
    }

    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒ­ãƒ¼ãƒ‰ã¯ã€å±¥æ­´ãƒªã‚¹ãƒˆã‹ã‚‰ã®é¸æŠã«ä¸€æœ¬åŒ–
    function loadChatHistory() {
        // ä½•ã‚‚ã›ãšã€displayChatHistoryListãŒå‘¼ã°ã‚Œã‚‹ã®ã‚’å¾…ã¤
        // startNewChat(true); // ã“ã‚Œã¯åˆå›èµ·å‹•æ™‚ã«å‘¼ã°ã‚Œã‚‹
        updateDeleteButtonVisibility();
    }

    // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è‡ªå‹•ä¿å­˜ã‚’å‰Šé™¤
    function saveChatHistory() {
        // ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¯ã€Œãƒãƒ£ãƒƒãƒˆä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ã®ã¿ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã•ã‚Œã‚‹
        // è‡ªå‹•ä¿å­˜ã¯è¡Œã‚ãªã„
    }

    function handleUserInput(message) {
        if (!message.trim() && !attachedImage) return;
        addMessage(message, 'user', { image: attachedImage });
        currentConversationHistory.push({ // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ãƒ—ãƒƒã‚·ãƒ¥
            role: 'user', content: message, image: attachedImage,
            timestamp: new Date().toISOString()
        });
        getAIResponse();
        removeAttachedImage();
    }

    async function getAIResponse() {
        if (!checkApiKey()) return;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${currentApiKey}`; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
        const thinkingMessage = addMessage('è€ƒãˆä¸­...', 'bot');

        let contents = currentConversationHistory.map(item => { // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
            const parts = [];
            if (item.content && item.content.trim() !== '') parts.push({ text: item.content });
            if (item.role === 'user' && item.image) {
                parts.push({ inlineData: { mimeType: item.image.mimeType, data: item.image.base64 } });
            }
            return { role: item.role === 'user' ? 'user' : 'model', parts: parts.length > 0 ? parts : [{ text: '' }] };
        });

        const requestBody = { contents };
        const persona = personaTextarea.value.trim(); // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
        if (persona) requestBody.systemInstruction = { parts: [{ text: persona }] };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
            if (thinkingMessage && thinkingMessage.parentNode) chatBox.removeChild(thinkingMessage);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status} - ${errorData.error?.message || JSON.stringify(errorData)}`);
            }
            const data = await response.json();
            if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                const aiResponse = data.candidates[0].content.parts[0].text;
                addMessage(aiResponse, 'bot');
                if (soundOnOff.checked) { // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
                    playNotificationSound(soundTypeSelect.value || 'sine'); // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
                }
                speakText(aiResponse);
                currentConversationHistory.push({ role: 'assistant', content: aiResponse, timestamp: new Date().toISOString() }); // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ãƒ—ãƒƒã‚·ãƒ¥
            } else {
                 throw new Error("APIã‹ã‚‰æœ‰åŠ¹ãªå¿œç­”ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
            }
        } catch (error) {
            console.error('Fetchã‚¨ãƒ©ãƒ¼:', error);
            if (thinkingMessage && thinkingMessage.parentNode) chatBox.removeChild(thinkingMessage);
            let errorMessage = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
            if (String(error.message).includes('429')) {
                errorMessage = 'APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
            }
            addMessage(errorMessage, 'bot', { isError: true });
            speakText(errorMessage);
        }
    }

    function addMessage(text, sender, options = {}) {
        const { isError = false, isSummary = false, timestamp = null, image = null } = options;
        const messageElement = document.createElement('div');
        let messageClass = sender === 'user' ? 'user-message' : (isError ? 'error-message' : (isSummary ? 'summary-message' : 'bot-message'));
        messageElement.classList.add('message', messageClass);
        const messageTimestamp = timestamp ? new Date(timestamp) : new Date();
        messageElement.dataset.id = messageTimestamp.getTime();
        if (!isSummary) {
            messageElement.addEventListener('click', () => {
                messageElement.classList.toggle('selected');
                updateDeleteButtonVisibility();
            });
        }
        if (image) {
            const imgElement = document.createElement('img');
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒnullã®å ´åˆã€è¡¨ç¤ºã—ãªã„ï¼ˆMDã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ãªã©ï¼‰
            if (image.base64 && image.mimeType) {
                imgElement.src = `data:${image.mimeType};base64,${image.base64}`;
            } else {
                imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjRjBGMDg4Ii8+PHRleHQgeD0iMyIgeT0iMzgiIGZvbnQtZmFtaWx5PSJIZWx2ZXRpY2EiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2NjYiPuaOpeS4gTwvdGV4dD48L3RleHQ+PC9zdmc+'; // Placeholder SVG for missing image
            }
            imgElement.classList.add('message-image');
            messageElement.appendChild(imgElement);
        }
        const textElement = document.createElement('div');
        textElement.classList.add('message-content-text');

        const urlRegex = /(?:^|(?<=\s))\[?(https?:\/\/[^\s]+?)(?:\]|\)|\.)?(?=\s|$)/g;
        let processedText = (text || '').replace(/\n/g, '<br>');
        processedText = processedText.replace(urlRegex, (match, url) => {
            let cleanUrl = url.replace(/^[.,!?:;\]\)]+|[.,!?:;\]\)]+$/g, '');
            return `<a href="${cleanUrl}" target="_blank">${cleanUrl}</a>`;
        });

        textElement.innerHTML = processedText;

        if(text || (!text && !image)) messageElement.appendChild(textElement);
        const timestampElement = document.createElement('div');
        timestampElement.classList.add('timestamp');
        timestampElement.textContent = formatTimestamp(messageTimestamp);
        messageElement.appendChild(timestampElement);
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
        return messageElement;
    }
    
    async function testApiKey() {
        const keyToTest = apiKeyInput.value.trim();
        if (!keyToTest) { alert('ãƒ†ã‚¹ãƒˆã™ã‚‹APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
        testKeyResult.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
        testKeyResult.className = '';
        const testApiUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${keyToTest}`;
        try {
            const response = await fetch(testApiUrl);
            if (response.ok) {
                testKeyResult.textContent = 'âœ… APIã‚­ãƒ¼ã¯æœ‰åŠ¹ã§ã™ã€‚';
                testKeyResult.className = 'test-success';
            } else {
                const errorData = await response.json();
                testKeyResult.textContent = `âŒ ç„¡åŠ¹ãªAPIã‚­ãƒ¼ã§ã™: ${errorData.error.message}`;
                testKeyResult.className = 'test-failure';
            }
        } catch (error) {
            console.error('APIã‚­ãƒ¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            testKeyResult.textContent = 'âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
            testKeyResult.className = 'test-failure';
        }
    }

    // --- ãƒãƒ£ãƒƒãƒˆä¿å­˜ãƒ»å±¥æ­´è¡¨ç¤ºé–¢é€£ã®é–¢æ•° ---
    async function createChatSummary() {
        if (currentConversationHistory.length === 0) { alert('ä¿å­˜ã™ã‚‹ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚'); return; }
        let statusMessage;
        try {
            statusMessage = addMessage(`ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’åˆ†æã—ã¦ä¿å­˜ã—ã¦ã„ã¾ã™...`, 'bot');
            const userName = userNameInput.value || 'ã‚ãªãŸ'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
            const aiName = aiNameInput.value || 'AI'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—

            const conversationText = currentConversationHistory // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
                .filter(item => !item.image) // ç”»åƒã¯ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã—ãªã„
                .map(item => `${item.role === 'user' ? userName : aiName}: ${item.content || ''}`)
                .join('\n');
            
            const today = new Date();
            const formattedDateForDownload = `${today.getFullYear()}${('0' + (today.getMonth() + 1)).slice(-2)}${('0' + today.getDate()).slice(-2)}`;
            const dateForSummaryData = today.toISOString();

            const defaultSummaryPrompt = `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  "title": "ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)",\n  "summary": "ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)"\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---`;
            let summaryPromptTemplate = summaryPromptTextarea.value.trim() || defaultSummaryPrompt; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
            
            const summaryPrompt = summaryPromptTemplate.replace('{CONVERSATION_HISTORY}', conversationText);
            console.log("Summary Prompt sent to AI:", summaryPrompt); // â˜…è¿½åŠ : é€ä¿¡ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒ­ã‚°å‡ºåŠ›

            const summaryApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${currentApiKey}`; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
            const summaryContents = [{ role: 'user', parts: [{ text: summaryPrompt }] }];
            const summaryResponse = await fetch(summaryApiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: summaryContents }) });
            
            if (!summaryResponse.ok) {
                const errorData = await summaryResponse.json(); 
                throw new Error(`æ¦‚è¦ç”ŸæˆAPIã‚¨ãƒ©ãƒ¼: ${summaryResponse.status} - ${errorData.error?.message || JSON.stringify(errorData)}`);
            }
            const data = await summaryResponse.json();
            let generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
            console.log("Raw AI Response for Summary:", generatedText); // â˜…è¿½åŠ : AIã®ç”Ÿå¿œç­”ã‚’ãƒ­ã‚°å‡ºåŠ›

            let title = 'ç„¡é¡Œã®ãƒãƒ£ãƒƒãƒˆ';
            let summary = 'æ¦‚è¦ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';

            try {
                const cleanGeneratedText = generatedText.replace(/```json\n?|\n?```/g, '').trim();
                const parsedContent = JSON.parse(cleanGeneratedText);
                if (parsedContent.title) {
                    title = parsedContent.title.trim();
                }
                if (parsedContent.summary) {
                    summary = parsedContent.summary.trim();
                }
            } catch (jsonError) {
                console.warn("AIå¿œç­”ã®JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”Ÿã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¦‚è¦ã‚’è©¦ã¿ã¾ã™ã€‚", jsonError);
                const lines = generatedText.split(/[\n\r]+/);
                if (lines.length > 0) {
                    title = lines[0].replace(/^\*\*ã‚¿ã‚¤ãƒˆãƒ«:\*\*\s*/, '').trim();
                    if (title === '') title = 'ç„¡é¡Œã®ãƒãƒ£ãƒƒãƒˆ';
                    let remainingSummary = lines.slice(1).join('\n').trim();
                    summary = remainingSummary.replace(/^\*\*æ¦‚è¦:\*\*\s*/, '').trim();
                    if (summary === '') summary = 'æ¦‚è¦ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚';
                }
            }

            // currentChatUniqueId ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆé€šå¸¸ã¯ startNewChat ã§è¨­å®šæ¸ˆã¿ï¼‰
            if (!currentChatUniqueId) {
                currentChatUniqueId = crypto.randomUUID();
            }

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆå‹•çš„ã«ç”Ÿæˆï¼‰
            const safeTitleForDownload = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50); 
            const downloadFilename = `${formattedDateForDownload}_${safeTitleForDownload}.md`;

            // å†…éƒ¨ç®¡ç†ç”¨ã® chatSummaryData ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            const chatSummaryData = { 
                chatId: currentChatUniqueId, // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
                title, 
                summary, 
                history: [...currentConversationHistory], // ç¾åœ¨ã®å±¥æ­´ã‚’ã‚³ãƒ”ãƒ¼
                date: dateForSummaryData,
                filename: downloadFilename // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒï¼ˆè¡¨ç¤ºç”¨ï¼‰
            };
            
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            downloadChatSummaryMarkdown(chatSummaryData, downloadFilename);
            
            if (statusMessage && statusMessage.parentNode) chatBox.removeChild(statusMessage);
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°allChatSummariesã«è¿½åŠ ã¾ãŸã¯æ›´æ–°
            saveChatSummaryToMemory(chatSummaryData); // chatId ã‚’ä½¿ã£ã¦æ›´æ–°ã•ã‚Œã‚‹
            alert(`ãƒãƒ£ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${chatSummaryData.title}\nï¼ˆå±¥æ­´ãƒªã‚¹ãƒˆã¸ã®è¿½åŠ ã€åŠã³JSONãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒè¡Œã‚ã‚Œã¾ã—ãŸï¼‰`);
            displayChatSummaryInChatBox(chatSummaryData);
            currentActiveSummaryData = chatSummaryData; // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ¦‚è¦ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            printPdfButton.style.display = 'inline-flex';
            
        } catch (error) {
            console.error('ãƒãƒ£ãƒƒãƒˆä¿å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
            if (statusMessage && statusMessage.parentNode) {
                statusMessage.textContent = `ãƒãƒ£ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`;
                statusMessage.className = 'message error-message';
            } else { addMessage(`ãƒãƒ£ãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'bot', { isError: true }); }
        }
    }

    // ãƒãƒ£ãƒƒãƒˆæ¦‚è¦ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªï¼‰ã«ä¿å­˜ã™ã‚‹ï¼ˆã¾ãŸã¯æ›´æ–°ã™ã‚‹ï¼‰
    function saveChatSummaryToMemory(chatSummaryData) {
        // chatId ã‚’ä½¿ã£ã¦æ—¢å­˜ã®å±¥æ­´ã‚’æ¤œç´¢
        const existingIndex = allChatSummaries.findIndex(item => item.chatId === chatSummaryData.chatId);
        if (existingIndex > -1) {
            allChatSummaries[existingIndex] = chatSummaryData; // æ—¢å­˜ã®å±¥æ­´ã‚’æ›´æ–°
        } else {
            allChatSummaries.push(chatSummaryData); // æ–°ã—ã„å±¥æ­´ã¨ã—ã¦è¿½åŠ 
        }
    }

    function displayChatSummaryInChatBox(summaryData) {
        chatBox.innerHTML = '';
        
        const filenameElement = document.createElement('div');
        filenameElement.classList.add('message', 'summary-message');
        const displayDate = summaryData.date ? formatTimestamp(new Date(summaryData.date)) : 'ä¸æ˜ãªæ—¥æ™‚';
        // ãƒ•ã‚¡ã‚¤ãƒ«åã¯ summaryData.filename (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨è¡¨ç¤ºå) ã‚’ä½¿ç”¨
        filenameElement.innerHTML = `<h3>ãƒ•ã‚¡ã‚¤ãƒ«å: ${summaryData.filename || 'ä¸æ˜'}</h3><p>ä¿å­˜æ—¥æ™‚: ${displayDate}</p>`;
        chatBox.appendChild(filenameElement);

        const summaryElement = document.createElement('div');
        summaryElement.classList.add('message', 'summary-message');
        summaryElement.innerHTML = `<h2>${summaryData.title}</h2><p>${summaryData.summary.replace(/\n/g, '<br>')}</p><hr><h3>ãƒãƒ£ãƒƒãƒˆå±¥æ­´ (ä¿å­˜æ™‚)</h3>`;
        chatBox.appendChild(summaryElement);

        currentConversationHistory = summaryData.history; // ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
        summaryData.history.forEach(item => {
            addMessage(item.content, item.role === 'user' ? 'user' : 'bot', { timestamp: item.timestamp, image: item.image });
        });

        chatBox.scrollTop = chatBox.scrollHeight;
        updateDeleteButtonVisibility();
        currentActiveSummaryData = summaryData;
        printPdfButton.style.display = 'inline-flex';
    }


    function displayChatHistoryList(searchTerm = '', sortBy = 'date', sortOrder = 'desc') {
        chatHistoryList.innerHTML = '';
        const summariesToDisplay = [...allChatSummaries]; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ã‚³ãƒ”ãƒ¼

        const filteredSummaries = summariesToDisplay.filter(summary => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            // summary.filename ã®ä»£ã‚ã‚Šã« summary.title ã¨ summary.chatId ã‚’æ¤œç´¢å¯¾è±¡ã«ã™ã‚‹ï¼ˆå¿…è¦ã§ã‚ã‚Œã°filenameã‚‚ï¼‰
            const title = (summary.title || '').toLowerCase();
            const date = (summary.date ? formatTimestamp(new Date(summary.date)) : '').toLowerCase();
            const chatId = (summary.chatId || '').toLowerCase(); // æ–°ã—ãè¿½åŠ 

            return title.includes(lowerCaseSearchTerm) ||
                   date.includes(lowerCaseSearchTerm) ||
                   chatId.includes(lowerCaseSearchTerm); // chatIdã‚‚æ¤œç´¢å¯¾è±¡ã«
        });

        filteredSummaries.sort((a, b) => {
            let compareA, compareB;

            if (sortBy === 'date') {
                compareA = new Date(a.date);
                compareB = new Date(b.date);
            } else if (sortBy === 'title') {
                compareA = a.title || '';
                compareB = b.title || '';
            }

            let comparison = 0;
            if (compareA > compareB) {
                comparison = 1;
            } else if (compareA < compareB) {
                comparison = -1;
            }

            return sortOrder === 'asc' ? comparison : -comparison;
        });


        if (filteredSummaries.length === 0) {
            chatHistoryList.innerHTML = '<li>ä¿å­˜ã•ã‚ŒãŸãƒãƒ£ãƒƒãƒˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
            if (searchTerm) {
                chatHistoryList.innerHTML = `<li>ã€Œ${searchTerm}ã€ã«ä¸€è‡´ã™ã‚‹å±¥æ­´ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</li>`;
            }
            return;
        }

        filteredSummaries.forEach((summary) => {
            const listItem = document.createElement('li');
            const displayDate = summary.date ? formatTimestamp(new Date(summary.date)) : 'ä¸æ˜ãªæ—¥æ™‚';
            
            // data-filename ã§ã¯ãªã data-chatid ã‚’ä½¿ç”¨ã€‚chatIdãŒãªã‘ã‚Œã°ç”Ÿæˆ
            if (!summary.chatId) { // æ—¢å­˜ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ã« chatId ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                summary.chatId = crypto.randomUUID();
                // ã“ã®å¤‰æ›´ã‚’ allChatSummaries ã«åæ˜ ã™ã‚‹ãŸã‚ã«ã€å¿…è¦ã§ã‚ã‚Œã° saveAllChatSummariesToStorage() ã‚’å‘¼ã¶
            }
            listItem.innerHTML = `
                <input type="checkbox" class="history-item-checkbox" data-chatid="${summary.chatId}">
                <div class="history-item-content">
                    <div class="title">${summary.title}</div>
                    <div class="date-time">${displayDate}</div>
                </div>
            `;
            
            chatHistoryList.appendChild(listItem);
        });
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆæ¦‚è¦ã‚’å‰Šé™¤ã™ã‚‹
    // deleteChatSummaryByFilename ã‚’ deleteChatSummaryByChatId ã«æ”¹å
    function deleteChatSummaryByChatId(chatIdToDelete) {
        allChatSummaries = allChatSummaries.filter(summary => summary.chatId !== chatIdToDelete); // chatId ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);
    }

    function loadChatFromSummary(summaryData) {
        chatBox.innerHTML = '';
        currentConversationHistory = summaryData.history; // ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’æ›´æ–°
        displayChatSummaryInChatBox(summaryData); 
        
        saveChatSummaryButton.style.display = 'inline-flex';
        loadChatHistoryButton.style.display = 'inline-flex';
        newChatButton.style.display = 'inline-flex';
        deleteSelectedButton.style.display = 'none';
        editSelectedButton.style.display = 'none';
        playSelectedButton.style.display = 'none';
        stopSpeechButton.style.display = 'none';

        updateDeleteButtonVisibility();

        currentActiveSummaryData = summaryData;
        currentChatUniqueId = summaryData.chatId; // â˜…è¿½åŠ ï¼šèª­ã¿è¾¼ã‚“ã ãƒãƒ£ãƒƒãƒˆã®IDã‚’è¨­å®š
        printPdfButton.style.display = 'inline-flex';
    }

    function downloadChatSummaryMarkdown(summaryData, filename) {
        let markdownContent = `# ${summaryData.title}\n\n`;
        markdownContent += `**ä¿å­˜æ—¥æ™‚:** ${formatTimestamp(new Date(summaryData.date))}\n\n`;
        markdownContent += `## æ¦‚è¦\n\n`;
        const summaryContent = summaryData.summary.replace(/<br>/g, '\n'); 
        summaryContent.split('\n').forEach(line => { markdownContent += `> ${line}\n`; });
        markdownContent += `\n---\n\n`;
        markdownContent += `# ãƒãƒ£ãƒƒãƒˆå±¥æ­´\n\n`;

        const userName = userNameInput.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
        const aiName = aiNameInput.value || 'AI'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
        
        summaryData.history.forEach(item => {
            const speaker = item.role === 'user' ? userName : aiName;
            const timestamp = formatTimestamp(new Date(item.timestamp));
            markdownContent += `**${speaker}** (${timestamp}):\n`;
            if (item.image) markdownContent += `> (ç”»åƒæ·»ä»˜)\n`; // ç”»åƒãŒã‚ã‚‹å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã‚’è¿½åŠ 
            if (item.content) item.content.split('\n').forEach(line => { markdownContent += `> ${line}\n`; });
            markdownContent += `\n`;
        });

        downloadFile(markdownContent, filename, 'text/markdown;charset=utf-8;'); // downloadMarkdownã‚’æ±ç”¨é–¢æ•°ã«ä¿®æ­£
    }

    // --- PDFå°åˆ·/ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–¢é€£ã®é–¢æ•° ---
    async function showPdfPreviewOfChatSummary() {
        if (!currentActiveSummaryData) {
            alert('PDFã‚’ç”Ÿæˆã™ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        const userName = userNameInput.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
        const aiName = aiNameInput.value || 'AI'; // UIè¦ç´ ã‹ã‚‰ç›´æ¥å–å¾—
        
        let contentForPdf = `
            <div style="font-family: 'Helvetica Neue', 'Arial', 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Meiryo', sans-serif; line-height: 1.6; padding: 20px; color: #333; margin: 0; background-color: #fff;">
                <h1 style="color: #2e8b57; border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 1.8em; margin-bottom: 15px;">${currentActiveSummaryData.title}</h1>
                <p><strong>ãƒ•ã‚¡ã‚¤ãƒ«å:</strong> ${currentActiveSummaryData.filename}</p>
                <p><strong>ä¿å­˜æ—¥æ™‚:</strong> ${formatTimestamp(new Date(currentActiveSummaryData.date))}</p>
                
                <h2 style="color: #3cb371; font-size: 1.5em; margin-top: 25px; margin-bottom: 10px;">æ¦‚è¦</h2>
                <div class="summary-content">
                    <p style="margin-top: 5px; margin-bottom: 0;">${currentActiveSummaryData.summary.replace(/\n/g,'<br>')}</p>
                </div>
                
                <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">
                <h2 style="color: #3cb371; font-size: 1.5em; margin-top: 25px; margin-bottom: 10px;">ãƒãƒ£ãƒƒãƒˆå±¥æ­´</h2>
                <div class="chat-log">`;

        currentActiveSummaryData.history.forEach(item => {
            const speaker = item.role === 'user' ? userName : aiName;
            const messageStyle = `margin-bottom: 5px; padding: 8px 12px; border-radius: 8px; max-width: 100%; word-wrap: break-word; page-break-inside: avoid; background-color: ${item.role === 'user' ? '#e0f0e0' : '#f0f0f0'}; ${item.role === 'user' ? 'text-align: left; margin-left: 0; border-bottom-right-radius: 8px; border-bottom-left-radius: 5px;' : 'text-align: left; border-bottom-left-radius: 5px;'};`; /* ä¿®æ­£é©ç”¨ */
            const timestampStyle = `font-size: 0.75em; color: #888; margin-top: 2px; display: block; ${item.role === 'user' ? 'text-align: left;' : 'text-align: left;'};`;

            contentForPdf += `<div class="message" style="${messageStyle}">
                                <span class="speaker" style="font-weight: bold; margin-bottom: 0px; display: block;">${speaker}</span>`;
            if (item.image && item.image.base64) {
                contentForPdf += `<img src="data:${item.image.mimeType};base64,${item.image.base64}" class="message-image" alt="æ·»ä»˜ç”»åƒ" style="max-width: 80%; height: auto; border-radius: 5px; margin-top: 5px; display: block; margin-left: auto; margin-right: auto;"><br>`;
            } else if (item.image) { // MDã‚¤ãƒ³ãƒãƒ¼ãƒˆãªã©ã§ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŒã€ç”»åƒæ·»ä»˜ã®è¨˜éŒ²ãŒã‚ã‚‹å ´åˆ
                contentForPdf += `<div style="text-align: center; color: #888; font-style: italic; margin-top: 5px; margin-bottom: 5px;">(ç”»åƒæ·»ä»˜)</div>`;
            }
            if (item.content) {
                contentForPdf += `<div class="message-content" style="margin-top: 2px;">${item.content.replace(/\n/g,'<br>')}</div>`;
            }
            contentForPdf += `<span class="timestamp" style="${timestampStyle}">(${formatTimestamp(new Date(item.timestamp))})</span>
                            </div>`;
        });

        contentForPdf += `</div></div>`;

        const options = {
            margin: 10,
            filename: `${currentActiveSummaryData.title}_${toDateString(new Date(currentActiveSummaryData.date))}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true, useCORS: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        try {
            const element = document.createElement('div');
            element.innerHTML = contentForPdf;

            const worker = html2pdf().from(element).set(options);

            const pdfDoc = await worker.toPdf().get('pdf');
            pdfDoc.setProperties({
                title: currentActiveSummaryData.title,
                subject: currentActiveSummaryData.summary,
                author: userName,
                creator: 'Myãƒãƒ£ãƒƒãƒˆå±¥æ­´ Ver1.06',
                keywords: 'chat, summary, AI'
            });

            const pdfBlob = await pdfDoc.output('blob');

            const pdfUrl = URL.createObjectURL(pdfBlob);
            pdfFrame.src = pdfUrl;
            pdfViewerModal.style.display = 'block';

            downloadPdfButton.onclick = () => {
                const link = document.createElement('a');
                link.href = pdfUrl;
                link.download = options.filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(pdfUrl); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œã«URLã‚’è§£æ”¾
            };

        } catch (error) {
            console.error('PDFç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            alert('PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
    }

    // --- éŸ³å£°èªè­˜é–¢é€£ã®é–¢æ•° ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isRecording = false;
    let finalTranscript = '';

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.continuous = true;
        recognition.interimResults = false;
        recognition.onstart = () => {
            isRecording = true; finalTranscript = '';
            micButton.classList.add('recording'); micButton.textContent = 'ğŸ™ï¸';
            textInput.placeholder = 'éŒ²éŸ³ä¸­...';
        };
        recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.results.length - 1; i >= 0; i--) {
                if (event.results[i].isFinal) {
                    transcript += event.results[i][0].transcript; 
                }
            }
            finalTranscript += transcript;
        };
        recognition.onend = () => {
            isRecording = false;
            micButton.classList.remove('recording'); micButton.textContent = 'ğŸ¤';
            textInput.placeholder = 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...';
            if (finalTranscript.trim()) {
                textInput.value += (textInput.value.length > 0 ? ' ' : '') + finalTranscript.trim();
                textInput.focus();
            }
        };
        recognition.onerror = (event) => {
            console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
            if (isRecording) recognition.stop();
        };
    }

    // --- ç”»åƒå‡¦ç†é–¢é€£ã®é–¢æ•° ---
    function processImageFile(file) {
        if (!file.type.startsWith('image/')) { alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
        const reader = new FileReader();
        reader.onload = (e) => {
            const dataUrl = e.target.result;
            imagePreview.src = dataUrl;
            imagePreviewContainer.style.display = 'block';
            const base64String = dataUrl.split(',')[1]; 
            const mimeType = dataUrl.match(/:(.*?);/)[1]; 
            attachedImage = { base64: base64String, mimeType: mimeType };
        };
        reader.readAsDataURL(file);
    }
    function handlePaste(event) {
        const items = (event.clipboardData || window.clipboardData).items;
        for (const item of items) {
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                event.preventDefault();
                processImageFile(item.getAsFile());
                return;
            }
        }
    }
    function handleFileSelect(event) { 
        if (event.target.files && event.target.files[0]) {
            processImageFile(event.target.files[0]); 
        }
    }
    function removeAttachedImage() {
        attachedImage = null; imagePreviewContainer.style.display = 'none';
        imagePreview.src = ''; imageFileInput.value = '';
    }

    // --- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£é–¢æ•° ---

    function exportSettingsAsCsv() {
        // UIè¦ç´ ã‹ã‚‰ç›´æ¥å€¤ã‚’å–å¾—
        const settings = {
            persona: personaTextarea.value.trim(),
            summaryPrompt: summaryPromptTextarea.value.trim(),
            userName: userNameInput.value.trim(),
            aiName: aiNameInput.value.trim(),
            soundEnabled: soundOnOff.checked,
            soundType: soundTypeSelect.value,
            ttsEnabled: ttsOnOff.checked,
            ttsVoiceName: ttsVoiceSelect.value,
            ttsRate: ttsRate,
            ttsPitch: ttsPitch,
            ttsVolume: ttsVolume,
        };

        const csvRows = ['"Key","Value"'];
        
        for (const key in settings) {
            let value = settings[key];
            if (typeof value === 'string') {
                value = value.replace(/\n/g, '\\n').replace(/"/g, '""');
            }
            csvRows.push(`"${key}","${value}"`);
        }

        const csvContent = csvRows.join('\n');
        downloadFile(csvContent, 'ai_settings_backup.csv', 'text/csv;charset=utf-8;'); // æ±ç”¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°ã‚’ä½¿ç”¨
        alert('è¨­å®šã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }

    function importSettingsFromCsv(event) {
        const file = event.target.files;
        if (!file || file.length === 0) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            const csvContent = e.target.result;
            try {
                const lines = csvContent.split('\n');
                if (lines.length < 2) throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒä¸æ­£ã§ã™ã€‚");

                const settings = {};
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (!line.trim()) continue;

                    // Improved regex to handle quoted commas within values
                    const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                    
                    if (!parts || parts.length !== 2) { 
                        console.warn(`è¡Œ ${i+1} ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${line}`);
                        continue;
                    }

                    let key = parts[0].replace(/^"|"$/g, '').replace(/""/g, '"'); 
                    let value = parts[1].replace(/^"|"$/g, '').replace(/\\n/g, '\n').replace(/""/g, '"'); 
                    
                    settings[key] = value;
                }

                personaTextarea.value = settings.persona || '';
                summaryPromptTextarea.value = settings.summaryPrompt || '';
                userNameInput.value = settings.userName || '';
                aiNameInput.value = settings.aiName || '';
                soundOnOff.checked = settings.soundEnabled === 'true' || settings.soundEnabled === true;
                soundTypeSelect.value = settings.soundType || 'sine';
                ttsOnOff.checked = settings.ttsEnabled === 'true' || settings.ttsEnabled === true;
                ttsEnabled = ttsOnOff.checked;
                if (ttsVoiceSelect) {
                    ttsVoiceSelect.value = settings.ttsVoiceName || '';
                }
                ttsRate = parseFloat(settings.ttsRate) || 1.0;
                ttsPitch = parseFloat(settings.ttsPitch) || 1.0;
                ttsVolume = parseFloat(settings.ttsVolume) || 1.0;
                ttsRateInput.value = ttsRate;
                ttsRateValue.textContent = ttsRate.toFixed(1);
                ttsPitchInput.value = ttsPitch;
                ttsPitchValue.textContent = ttsPitch.toFixed(1);
                ttsVolumeInput.value = ttsVolume;
                ttsVolumeValue.textContent = ttsVolume.toFixed(1);

                saveAllSettingsToLocalStorage(); // CSVã‹ã‚‰èª­ã¿è¾¼ã‚“ã è¨­å®šã‚’localStorageã«ä¿å­˜
                loadVoices(); // éŸ³å£°ãƒªã‚¹ãƒˆã‚’å†ãƒ­ãƒ¼ãƒ‰

                alert('è¨­å®šã‚’CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
                event.target.value = '';

            } catch (error) {
                console.error('CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                event.target.value = '';
            }
        };
        reader.onerror = () => {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            event.target.value = '';
        };
        reader.readAsText(file[0]); 
    }

    // --- å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢æ•° ---
    function exportAllChatSummaries() {
        if (allChatSummaries.length === 0) { // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        const jsonContent = JSON.stringify(allChatSummaries, null, 2); // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
        const today = new Date();
        const formattedDate = `${today.getFullYear()}${('0' + (today.getMonth() + 1)).slice(-2)}${('0' + today.getDate()).slice(-2)}`;
        const filename = `my_chat_history_backup_${formattedDate}.json`;
        downloadFile(jsonContent, filename, 'application/json;charset=utf-8;'); // æ±ç”¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°ã‚’ä½¿ç”¨
        alert('å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚');
    }

    function importAllChatSummaries(event) {
        const file = event.target.files;
        if (!file || file.length === 0) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedSummaries = JSON.parse(e.target.result);
                if (!Array.isArray(importedSummaries)) {
                    throw new Error("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒä¸æ­£ã§ã™ã€‚");
                }

                if (confirm('æ—¢å­˜ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒªã‚¹ãƒˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå±¥æ­´ã‚’è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿï¼ˆã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã‚’é¸æŠã™ã‚‹ã¨æ—¢å­˜ã®å±¥æ­´ã¯å…¨ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼‰')) {
                    let existingSummaries = [...allChatSummaries]; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ã‚³ãƒ”ãƒ¼
                    const mergedSummaries = [...existingSummaries];

                    importedSummaries.forEach(importedSummary => {
                        // chatId ãŒãªã„ãƒ‡ãƒ¼ã‚¿ã«ã¯æ–°ã—ãç”Ÿæˆ
                        if (!importedSummary.chatId) {
                            importedSummary.chatId = crypto.randomUUID();
                        }
                        // chatId ã‚’ä½¿ã£ã¦æ—¢å­˜ã®å±¥æ­´ã‚’æ¤œç´¢
                        const existingIndex = mergedSummaries.findIndex(
                            s => s.chatId === importedSummary.chatId
                        );
                        if (existingIndex > -1) {
                            mergedSummaries[existingIndex] = importedSummary; // æ—¢å­˜ã®å±¥æ­´ã‚’æ›´æ–°
                        } else {
                            mergedSummaries.push(importedSummary); // æ–°ã—ã„å±¥æ­´ã¨ã—ã¦è¿½åŠ 
                        }
                    });
                    allChatSummaries = mergedSummaries; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
                    alert('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸã€‚');

                } else {
                    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚ŒãŸå±¥æ­´ã« chatId ãŒãªã„å ´åˆã«å¯¾å¿œ
                    importedSummaries.forEach(importedSummary => {
                        if (!importedSummary.chatId) {
                            importedSummary.chatId = crypto.randomUUID();
                        }
                    });
                    allChatSummaries = importedSummaries; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä¸Šæ›¸ã
                    alert('ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¸Šæ›¸ãã—ã¾ã—ãŸã€‚');
                }
                
                startNewChat(true); 
                displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);

            } catch (error) {
                console.error('å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                event.target.value = '';
            }
        };
        reader.onerror = () => {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            event.target.value = '';
        };
        reader.readAsText(file[0]);
    }

    // MDãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢é€£ã®é–¢æ•°ã‚’è¿½åŠ 
    // Helper to escape regex special characters for dynamic user/AI names
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
    }

    function importMarkdownFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const markdownContent = e.target.result;
            try {
                const parsedSummary = parseMarkdownChatHistory(markdownContent);
                if (parsedSummary) {
                    saveChatSummaryToMemory(parsedSummary); // Add/update in allChatSummaries
                    displayChatHistoryList(chatHistorySearchInput.value, currentSortBy, currentSortOrder);
                    alert(`Markdownãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’èª­ã¿è¾¼ã¿ã€å±¥æ­´ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                } else {
                    alert('Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            } catch (error) {
                console.error('Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                alert(`Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                event.target.value = ''; // Clear file input
            }
        };
        reader.onerror = () => {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    // Function to parse a Markdown chat history file
    function parseMarkdownChatHistory(markdownContent) {
        let title = 'ç„¡é¡Œã®ãƒãƒ£ãƒƒãƒˆ';
        let summary = '';
        let dateIsoString = new Date().toISOString();
        let history = [];
        let currentRole = '';
        let currentContentLines = [];
        let currentMessageTimestampIso = '';
        let currentMessageHasImage = false; // Flag for current message

        const userName = userNameInput.value || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        const aiName = aiNameInput.value || 'AI';

        const lines = markdownContent.split('\n');
        let section = 'none'; // 'title', 'header_info', 'summary', 'history'
        let readingSummary = false;
        let readingHistory = false;

        for (const line of lines) {
            const trimmedLine = line.trim();

            if (trimmedLine.startsWith('# ')) {
                if (trimmedLine.startsWith('# ãƒãƒ£ãƒƒãƒˆå±¥æ­´')) {
                    // Before switching to history, save any pending message
                    if (currentRole && (currentContentLines.length > 0 || currentMessageHasImage)) {
                        history.push({
                            role: currentRole,
                            content: currentContentLines.join('\n').trim(), // Trim content for leading/trailing newlines
                            timestamp: currentMessageTimestampIso,
                            image: currentMessageHasImage ? { base64: null, mimeType: null } : null
                        });
                    }
                    readingSummary = false;
                    readingHistory = true;
                    currentRole = '';
                    currentContentLines = [];
                    currentMessageTimestampIso = '';
                    currentMessageHasImage = false; // Reset flag
                    continue; // Process next line
                } else if (section === 'none') { // Assume first # H1 is the main title
                    title = trimmedLine.substring(2).trim();
                    section = 'title';
                    continue; // Process next line
                }
            }

            if (trimmedLine.startsWith('**ä¿å­˜æ—¥æ™‚:** ')) {
                const dateStr = trimmedLine.substring('**ä¿å­˜æ—¥æ™‚:** '.length).trim();
                // Expected format from formatTimestamp: YYYY/MM/DD HH:mm
                const parts = dateStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/);
                if (parts) {
                    const year = parseInt(parts[1], 10);
                    const month = parseInt(parts[2], 10) - 1; // Month is 0-indexed
                    const day = parseInt(parts[3], 10);
                    const hour = parseInt(parts[4], 10);
                    const minute = parseInt(parts[5], 10);
                    dateIsoString = new Date(year, month, day, hour, minute).toISOString();
                } else {
                    console.warn("Could not parse date string for summary:", dateStr);
                }
                section = 'header_info';
                continue;
            }

            if (trimmedLine.startsWith('## æ¦‚è¦')) {
                readingSummary = true;
                readingHistory = false;
                section = 'summary';
                summary = ''; // Reset summary to collect lines
                continue;
            }

            if (trimmedLine === '---') { // Separator
                readingSummary = false; // Stop reading summary
                continue;
            }

            if (readingSummary && trimmedLine.startsWith('> ')) {
                summary += trimmedLine.substring(2) + '\n';
                continue;
            }

            if (readingHistory) {
                const userSpeakerMatch = trimmedLine.match(`^\\*\\*${escapeRegExp(userName)}\\*\\* \\((\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2})\\):`);
                const aiSpeakerMatch = trimmedLine.match(`^\\*\\*${escapeRegExp(aiName)}\\*\\* \\((\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2})\\):`);
                
                if (userSpeakerMatch || aiSpeakerMatch) {
                    // If there was a previous message, save it
                    if (currentRole && (currentContentLines.length > 0 || currentMessageHasImage)) {
                        history.push({
                            role: currentRole,
                            content: currentContentLines.join('\n').trim(),
                            timestamp: currentMessageTimestampIso,
                            image: currentMessageHasImage ? { base64: null, mimeType: null } : null
                        });
                    }
                    // Start new message
                    currentRole = userSpeakerMatch ? 'user' : 'assistant';
                    const timestampStr = userSpeakerMatch ? userSpeakerMatch[1] : aiSpeakerMatch[1];
                    const parts = timestampStr.match(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}):(\d{2})/);
                    if (parts) {
                         const year = parseInt(parts[1], 10);
                         const month = parseInt(parts[2], 10) - 1;
                         const day = parseInt(parts[3], 10);
                         const hour = parseInt(parts[4], 10);
                         const minute = parseInt(parts[5], 10);
                         currentMessageTimestampIso = new Date(year, month, day, hour, minute).toISOString();
                    } else {
                        console.warn("Could not parse timestamp string in history:", timestampStr);
                        currentMessageTimestampIso = new Date().toISOString(); // Fallback
                    }
                    currentContentLines = [];
                    currentMessageHasImage = false; // Reset for new message
                } else if (trimmedLine.startsWith('> ')) {
                    const contentPart = trimmedLine.substring(2);
                    if (contentPart === '(ç”»åƒæ·»ä»˜)') {
                        currentMessageHasImage = true;
                    } else {
                        currentContentLines.push(contentPart);
                    }
                }
                // Ignore empty lines within history if they don't start with '>'
            }
        }

        // Save the last collected message if any
        if (currentRole && (currentContentLines.length > 0 || currentMessageHasImage)) {
            history.push({
                role: currentRole,
                content: currentContentLines.join('\n').trim(),
                timestamp: currentMessageTimestampIso,
                image: currentMessageHasImage ? { base64: null, mimeType: null } : null
            });
        }

        // Trim final summary
        summary = summary.trim();
        if (summary === '') summary = 'æ¦‚è¦ãªã—';

        // Generate a new unique ID for the imported chat
        const chatId = crypto.randomUUID();
        const safeTitleForDownload = title.replace(/[\\/:*?"<>|]/g, '_').substring(0, 50);
        // Date format for filename: YYYYMMDD
        const filenameDatePart = new Date(dateIsoString).getFullYear().toString() +
                                 (new Date(dateIsoString).getMonth() + 1).toString().padStart(2, '0') +
                                 new Date(dateIsoString).getDate().toString().padStart(2, '0');
        const downloadFilename = `${filenameDatePart}_${safeTitleForDownload}.md`;

        return {
            chatId: chatId,
            title: title,
            summary: summary,
            history: history,
            date: dateIsoString,
            filename: downloadFilename
        };
    }


    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
    function playNotificationSound(soundType = 'sine') {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode); gainNode.connect(audioContext.destination);
            oscillator.type = soundType;
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            let frequency = 440;
            switch(soundType) {
                case 'square':   frequency = 660; break;
                case 'sawtooth': frequency = 220; break;
                case 'triangle': frequency = 523; break;
            }
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.start(); oscillator.stop(audioContext.currentTime + 0.1);
        } catch (e) { console.error("ã‚µã‚¦ãƒ³ãƒ‰ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:", e); }
    }
    function updateCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear(); const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const week = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][now.getDay()];
        const reiwaYear = year - 2018;
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        datetimeDisplay.textContent = `${year}å¹´${month}æœˆ${day}æ—¥(${week})ã€€ä»¤å’Œ${reiwaYear}å¹´ã€€${hours}æ™‚${minutes}åˆ†`;
    }
    function checkApiKey() {
        if (!currentApiKey) { // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨
            alert('ã€ŒAPIè¨­å®šã€ãƒœã‚¿ãƒ³ã‹ã‚‰APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
            settingsModal.style.display = 'block';
            return false;
        }
        return true;
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’æ±ç”¨é–¢æ•°åŒ–
    function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob); 
        link.download = filename;
        document.body.appendChild(link); 
        link.click();
        document.body.removeChild(link); 
        URL.revokeObjectURL(link.href);
    }
    
    function toDateString(date) { return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; }
    function formatTimestamp(date) { return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`; }

    function showHelp() {
        const helpContent = `<!DOCTYPE html><html lang="ja"><head><meta charset="UTF-8"><title>ï¼­ï½™ãƒãƒ£ãƒƒãƒˆå±¥æ­´ - å–æ‰±èª¬æ˜æ›¸</title><style>
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;line-height:1.7;margin:0;padding:25px;color:#333;background-color:#f9f9f9}
        .container{max-width:800px;margin:0 auto;background-color:#fff;padding:20px 30px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.08);position:relative;}
        h1{color:#2e8b57;border-bottom:3px solid #66cdaa;padding-bottom:10px;font-size:1.8em}
        h2{color:#3cb371;border-bottom:2px solid #e0f2f1;padding-bottom:8px;margin-top:30px;font-size:1.5em}
        h3{color:#2e8b57;border-left:5px solid #66cdaa;padding-left:10px;font-size:1.2em}
        ul{list-style-type:none;padding-left:0}
        li{margin-bottom:15px;padding-left:20px;position:relative}
        li::before{content:'âœ“';color:#3cb371;position:absolute;left:0;font-weight:bold}
        p{text-align:justify}
        code{background-color:#eef;color:#d63384;padding:2px 6px;border-radius:4px;font-family:'Courier New',Courier,monospace}
        .icon{display:inline-block;width:24px;height:24px;line-height:24px;text-align:center;border-radius:50%;color:#fff;font-size:1.1em;vertical-align:middle;margin-right:5px}
        .save-icon{background-color:#3cb371}
        .important{background-color:#fffbe6;border:1px solid #ffeeba;border-left:5px solid #ffc107;padding:15px 20px;margin:20px 0;border-radius:5px}
        .important strong{color:#856404}
        .button-desc{font-weight:bold}
        .close-help-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease;
        }
        .close-help-button:hover {
            background-color: #d32f2f;
        }
        </style></head><body><div class="container">
        <button class="close-help-button" onclick="window.close()">&times;</button>
        <h1>ï¼­ï½™ãƒãƒ£ãƒƒãƒˆå±¥æ­´ - å–æ‰±èª¬æ˜æ›¸</h1>
        <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€AIã¨ã®è‡ªç”±ãªå¯¾è©±ã‚’è¨˜éŒ²ã—ã€è¦ç´„ã‚’ç”Ÿæˆã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ãƒ»ç®¡ç†ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p>
        <div class="important"><p><strong>ã€é‡è¦ã€‘</strong> åˆã‚ã¦ã”åˆ©ç”¨ã«ãªã‚‹éš›ã¯ã€å³ä¸Šã®ã€Œ<b>APIè¨­å®š</b>ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã”è‡ªèº«ã®Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ã“ã®APIã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œãšã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã«ã®ã¿æœ‰åŠ¹ã§ã™ã€‚</p></div>
        <div class="important"><p><strong>ã€é‡è¦ã€‘</strong> ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŠã‚ˆã³è¨­å®šã¯è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚ã€Œ<b>å„ç¨®è¨­å®š</b>ã€å†…ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æ˜ç¤ºçš„ã«JSONã‚„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p></div>
        <h2>ä¸»ãªæ©Ÿèƒ½</h2>
        <h3>1. AIã¨ã®ãƒãƒ£ãƒƒãƒˆ</h3>
        <ul>
            <li><span class="button-desc">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡:</span> <code>Enter</code>ã‚­ãƒ¼ã§é€ä¿¡ã€<code>Shift + Enter</code>ã§æ”¹è¡Œã§ãã¾ã™ã€‚</li>
            <li><span class="button-desc">ç”»åƒã®æ·»ä»˜:</span> ã‚¯ãƒªãƒƒãƒ—ãƒœã‚¿ãƒ³<code>ğŸ“</code>ã‹ã€å…¥åŠ›æ¬„ã¸ã®ãƒšãƒ¼ã‚¹ãƒˆã§ç”»åƒã‚’æ·»ä»˜ã§ãã¾ã™ã€‚</li>
            <li><span class="button-desc">éŸ³å£°å…¥åŠ›:</span> ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³<code>ğŸ¤</code>ã§ãƒãƒ£ãƒƒãƒˆå†…å®¹ã®éŸ³å£°å…¥åŠ›ãŒå¯èƒ½ã§ã™ã€‚</li>
            <li><span class="button-desc">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤:</span> å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œ<b>é¸æŠã‚’å‰Šé™¤</b>ã€ã§å‰Šé™¤ã§ãã¾ã™ã€‚</li>
            <li><span class="button-desc">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç·¨é›†:</span> å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œ<b>é¸æŠã‚’ç·¨é›†</b>ã€ã§ç·¨é›†ã§ãã¾ã™ã€‚</li>
            <li><span class="button-desc">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å†ç”Ÿ:</span> å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠã—ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œ<b>é¸æŠã‚’å†ç”Ÿ</b>ã€ã§éŸ³å£°èª­ã¿ä¸Šã’ã§ãã¾ã™ã€‚</li>
            <li><span class="button-desc">éŸ³å£°åœæ­¢:</span> éŸ³å£°ãŒå†ç”Ÿä¸­ã®å ´åˆã€ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œ<b>éŸ³å£°åœæ­¢</b>ã€ãƒœã‚¿ãƒ³ã§å†ç”Ÿã‚’åœæ­¢ã§ãã¾ã™ã€‚</li>
        </ul>
        <h3>2. ãƒãƒ£ãƒƒãƒˆã®ä¿å­˜ã¨å±¥æ­´ç®¡ç†</h3>
        <ul>
            <li><span class="icon save-icon">âœˆï¸</span> <span class="button-desc">ãƒãƒ£ãƒƒãƒˆä¿å­˜:</span> ç¾åœ¨ã®ä¼šè©±å†…å®¹ã‚’AIãŒåˆ†æã—ã€ã‚¿ã‚¤ãƒˆãƒ«ã¨æ¦‚è¦ã‚’ç”Ÿæˆã—ã¦ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚åŒæ™‚ã«ã€Œå±¥æ­´ä¸€è¦§ã€ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚ï¼ˆæ°¸ç¶šåŒ–ã«ã¯ã€Œå…¨å±¥æ­´ã‚’JSONã§ä¿å­˜ã€ãŒå¿…è¦ã§ã™ã€‚ï¼‰</li>
            <li><span class="button-desc">å±¥æ­´ä¸€è¦§:</span> ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€Œ<b>å±¥æ­´ä¸€è¦§</b>ã€ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã—ã€éå»ã®ãƒãƒ£ãƒƒãƒˆã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚</li>
            <li><span class="button-desc">æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆ:</span> ç¾åœ¨ã®ä¼šè©±ã‚’ç ´æ£„ã—ã¦ã€æ–°ã—ã„ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚ï¼ˆä¿å­˜ã—ã¦ã„ãªã„å†…å®¹ã¯å¤±ã‚ã‚Œã¾ã™ã€‚ï¼‰</li>
        </ul>
        <h3>3. ãƒ˜ãƒƒãƒ€ãƒ¼ã®å„ç¨®ãƒœã‚¿ãƒ³</h3>
        <ul>
            <li><span class="button-desc">å„ç¨®è¨­å®š:</span> AIã®æ€§æ ¼ã€ãƒãƒ£ãƒƒãƒˆæ¦‚è¦ç”Ÿæˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã€ã‚ãªãŸã¨AIã®åå‰ã€ã‚µã‚¦ãƒ³ãƒ‰ã€TTSè¨­å®šãªã©ã‚’è¨­å®šã§ãã¾ã™ã€‚<b>ã€Œè¨­å®šã‚’CSVã§ä¿å­˜ã€/ã€Œè¨­å®šã‚’CSVã‹ã‚‰èª­è¾¼ã€ã§è¨­å®šã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒãŒå¯èƒ½ã§ã™ã€‚</b>
                <br><b>ã€Œå…¨å±¥æ­´ã‚’JSONã§ä¿å­˜ã€/ã€Œå…¨å±¥æ­´ã‚’JSONã‹ã‚‰èª­è¾¼ã€ã§å…¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒãŒå¯èƒ½ã§ã™ã€‚</b>
                <br><b>ã€ŒMDãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­è¾¼ã€ã§ã€ã€Œãƒãƒ£ãƒƒãƒˆä¿å­˜ã€ã§ä½œæˆã—ãŸãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å±¥æ­´ãƒªã‚¹ãƒˆã«è¿½åŠ ã§ãã¾ã™ã€‚</b>
            </li>
            <li><span class="button-desc">APIè¨­å®š:</b> Gemini APIã‚­ãƒ¼ã‚’è¨­å®šãƒ»ãƒ†ã‚¹ãƒˆãƒ»ã‚¯ãƒªã‚¢ã§ãã¾ã™ã€‚ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œãšã€ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿æœ‰åŠ¹ã§ã™ã€‚</li>
            <li><span class="button-desc">PDFãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</b> ç¾åœ¨ã®ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’PDFå½¢å¼ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚</li>
        </ul>
        <h2>æ³¨æ„äº‹é …</h2>
        <ul>
            <li>APIã‚­ãƒ¼ã€ä¼šè©±å±¥æ­´ã€ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã€å„ç¨®è¨­å®šã¯ã€**ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯è‡ªå‹•ã§ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚** ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«ã¯ã€æ˜ç¤ºçš„ã«ã€Œå„ç¨®è¨­å®šã€å†…ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</li>
            <li>Gemini APIã®åˆ©ç”¨æ–™é‡‘ã¯ã€APIã‚­ãƒ¼ã‚’ç™ºè¡Œã—ãŸã”è‡ªèº«ã®Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æº–ã˜ã¾ã™ã€‚åˆ©ç”¨é‡ã«ã”æ³¨æ„ãã ã•ã„ã€‚</li>
        </ul></div></body></html>`;
        const helpWindow = window.open('', '_blank');
        helpWindow.document.write(helpContent);
        helpWindow.document.close();
    }

    // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‰Šé™¤ãƒ»ç·¨é›†ãƒ»å†ç”Ÿé–¢é€£ã®é–¢æ•° ---
    function updateDeleteButtonVisibility() {
        const selectedMessages = document.querySelectorAll('.message.selected');
        deleteSelectedButton.style.display = selectedMessages.length > 0 ? 'block' : 'none';
        editSelectedButton.style.display = selectedMessages.length === 1 ? 'block' : 'none';
        playSelectedButton.style.display = selectedMessages.length > 0 ? 'block' : 'none';
        // éŸ³å£°åœæ­¢ãƒœã‚¿ãƒ³ã¯åˆ¥ã®ãƒ­ã‚¸ãƒƒã‚¯ã§åˆ¶å¾¡ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å¤‰æ›´ã—ãªã„
    }
    function deleteSelectedMessages() {
        const selectedMessages = document.querySelectorAll('.message.selected');
        if (selectedMessages.length === 0) { alert('å‰Šé™¤ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'); return; }
        if (confirm(`é¸æŠã—ãŸ ${selectedMessages.length} ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®å¤‰æ›´ã¯ãƒãƒ£ãƒƒãƒˆã‚’ä¿å­˜ã™ã‚‹ã¾ã§æ°¸ç¶šåŒ–ã•ã‚Œã¾ã›ã‚“ï¼‰`)) {
            const idsToDelete = new Set();
            selectedMessages.forEach(msg => {
                idsToDelete.add(msg.dataset.id);
                msg.remove();
            });
            currentConversationHistory = currentConversationHistory.filter(item => !idsToDelete.has(String(new Date(item.timestamp).getTime()))); // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
            updateDeleteButtonVisibility();
        }
    }

    function openEditMessageModal() {
        const selectedMessage = document.querySelector('.message.selected');
        if (!selectedMessage) return;

        editingMessageElement = selectedMessage;
        const messageText = selectedMessage.querySelector('.message-content-text')?.textContent || '';

        editMessageTextarea.value = messageText;
        editMessageModal.style.display = 'block';
    }

    saveEditedMessageButton.addEventListener('click', () => {
        if (!editingMessageElement) return;

        const newText = editMessageTextarea.value;
        const messageId = editingMessageElement.dataset.id;

        const textElement = editingMessageElement.querySelector('.message-content-text');
        if (textElement) {
            const urlRegex = /(?:^|(?<=\s))\[?(https?:\/\/[^\s]+?)(?:\]|\)|\.)?(?=\s|$)/g;
            let processedText = newText.replace(/\n/g, '<br>');
            processedText = processedText.replace(urlRegex, (match, url) => {
                let cleanUrl = url.replace(/^[.,!?:;\]\)]+|[.,!?:;\]\)]+$/g, '');
                return `<a href="${cleanUrl}" target="_blank">${cleanUrl}</a>`;
            });
            textElement.innerHTML = processedText;
        } else if (!editingMessageElement.querySelector('.message-image')) {
             const newTextElement = document.createElement('div');
             newTextElement.classList.add('message-content-text');
             const urlRegex = /(?:^|(?<=\s))\[?(https?:\/\/[^\s]+?)(?:\]|\)|\.)?(?=\s|$)/g;
             let processedText = newText.replace(/\n/g, '<br>');
             processedText = processedText.replace(urlRegex, (match, url) => {
                 let cleanUrl = url.replace(/^[.,!?:;\]\)]+|[.,!?:;\]\)]+$/g, '');
                 return `<a href="${cleanUrl}" target="_blank">${cleanUrl}</a>`;
             });
             newTextElement.innerHTML = processedText;
             editingMessageElement.prepend(newTextElement);
        }

        const messageIndex = currentConversationHistory.findIndex(item => String(new Date(item.timestamp).getTime()) === messageId); // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰æ¤œç´¢
        if (messageIndex !== -1) {
            currentConversationHistory[messageIndex].content = newText; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
        }

        editingMessageElement.classList.remove('selected');
        editingMessageElement = null;
        editMessageModal.style.display = 'none';
        updateDeleteButtonVisibility();
    });

    closeEditMessageModal.addEventListener('click', () => {
        editingMessageElement = null;
        editMessageModal.style.display = 'none';
    });

    function playSelectedMessages() {
        if (!ttsEnabled || !window.speechSynthesis) {
            alert("éŸ³å£°èª­ã¿ä¸Šã’æ©Ÿèƒ½ãŒã‚ªãƒ•ã«ãªã£ã¦ã„ã‚‹ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
            return;
        }

        window.speechSynthesis.cancel(); // æ–°ã—ã„å†ç”Ÿå‰ã«åœæ­¢

        let combinedText = '';
        const selectedMessages = document.querySelectorAll('.message.selected');
        
        // é¸æŠã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †ã«ã‚½ãƒ¼ãƒˆ
        const sortedSelectedMessages = Array.from(selectedMessages).sort((a, b) => {
            return parseInt(a.dataset.id) - parseInt(b.dataset.id);
        });

        sortedSelectedMessages.forEach((message, index) => {
            const messageTextElement = message.querySelector('.message-content-text');
            if (messageTextElement && messageTextElement.textContent.trim() !== '') {
                combinedText += messageTextElement.textContent.trim();
                if (index < sortedSelectedMessages.length - 1) {
                    combinedText += 'ã€‚';
                }
            } else if (message.querySelector('.message-image')) {
                combinedText += 'ï¼ˆç”»åƒï¼‰';
                if (index < sortedSelectedMessages.length - 1) {
                    combinedText += 'ã€‚';
                }
            }
        });

        if (combinedText.trim() === '') {
            alert('é¸æŠã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯èª­ã¿ä¸Šã’å¯èƒ½ãªãƒ†ã‚­ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return;
        }

        speakText(combinedText);
    }


    // --- TTSé–¢é€£é–¢æ•° ---
    function loadVoices() {
        if (!window.speechSynthesis) {
            console.warn("SpeechSynthesis API not supported.");
            ttsOnOff.checked = false;
            ttsOnOff.disabled = true;
            ttsVoiceSelect.disabled = true;
            ttsVoiceSelect.innerHTML = '<option value="">éŸ³å£°éå¯¾å¿œ</option>';
            ttsRateInput.disabled = true;
            ttsPitchInput.disabled = true;
            ttsVolumeInput.disabled = true;
            return;
        }

        availableVoices = window.speechSynthesis.getVoices();
        ttsVoiceSelect.innerHTML = '';

        let japaneseVoices = availableVoices.filter(voice => voice.lang.startsWith('ja'));
        let defaultVoiceName = null;

        if (japaneseVoices.length > 0) {
            japaneseVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                ttsVoiceSelect.appendChild(option);
                if (!defaultVoiceName || voice.default) {
                    defaultVoiceName = voice.name;
                }
            });
        } else {
            availableVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.name;
                ttsVoiceSelect.appendChild(option);
                if (!defaultVoiceName || voice.default) {
                    defaultVoiceName = voice.name;
                }
            });
            console.warn("No Japanese voices found. Falling back to available voices.");
        }

        // TTSéŸ³å£°è¨­å®šã®åˆæœŸå€¤ã‚’é©ç”¨ (UIè¦ç´ ã®ç¾åœ¨ã®å€¤)
        const currentVoiceName = ttsVoiceSelect.value;
        if (currentVoiceName && availableVoices.some(voice => voice.name === currentVoiceName)) {
            selectedTtsVoice = availableVoices.find(voice => voice.name === currentVoiceName);
        } else if (defaultVoiceName) {
            ttsVoiceSelect.value = defaultVoiceName;
            selectedTtsVoice = availableVoices.find(voice => voice.name === defaultVoiceName);
        } else {
            selectedTtsVoice = null;
        }
    }

    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speakText(text) {
        if (!ttsEnabled || !window.speechSynthesis || text.trim() === '') {
            return;
        }

        window.speechSynthesis.cancel(); // æ–°ã—ã„ç™ºè©±ã‚’é–‹å§‹ã™ã‚‹å‰ã«æ—¢å­˜ã®ã‚‚ã®ã‚’åœæ­¢

        // çµµæ–‡å­—ã€ã‚¢ã‚¹ã‚¿ãƒªã‚¹ã‚¯ã€ãƒãƒƒã‚¯ã‚¯ã‚©ãƒ¼ãƒˆã‚’é™¤å»
        // \p{Emoji} ã¯Unicodeãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã§ã€å¤šãã®çµµæ–‡å­—ã«ãƒãƒƒãƒã—ã¾ã™ï¼ˆuãƒ•ãƒ©ã‚°ãŒå¿…è¦ï¼‰
        let speechText = text.replace(/\p{Emoji}/gu, '').replace(/\*/g, '').replace(/`/g, '');

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã«ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã«ãªã£ãŸå ´åˆã¯å†ç”Ÿã—ãªã„
        if (speechText.trim() === '') {
            return;
        }

        const utterance = new SpeechSynthesisUtterance(speechText);
        utterance.lang = 'ja-JP';

        if (selectedTtsVoice) {
            utterance.voice = selectedTtsVoice;
        } else {
            const defaultJapaneseVoice = availableVoices.find(voice => voice.lang.startsWith('ja'));
            if (defaultJapaneseVoice) {
                utterance.voice = defaultJapaneseVoice;
            }
        }
        
        utterance.rate = ttsRate;
        utterance.pitch = ttsPitch;
        utterance.volume = ttsVolume;

        window.speechSynthesis.speak(utterance);
        updateSpeechControlButtonVisibility(); // ç™ºè©±é–‹å§‹æ™‚ã«éŸ³å£°åœæ­¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

        utterance.onend = () => {
            updateSpeechControlButtonVisibility(); // ç™ºè©±çµ‚äº†æ™‚ã«éŸ³å£°åœæ­¢ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        };
        utterance.onerror = (event) => { // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã‚‚éŸ³å£°åœæ­¢ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            console.error('TTSã‚¨ãƒ©ãƒ¼:', event.error);
            updateSpeechControlButtonVisibility(); 
        };
    }

    // éŸ³å£°åœæ­¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateSpeechControlButtonVisibility() {
        if (window.speechSynthesis.speaking && ttsEnabled) {
            stopSpeechButton.style.display = 'block';
        } else {
            stopSpeechButton.style.display = 'none';
        }
    }

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
    function loadSettingsFromMemoryOrDefault() {
        // UIè¦ç´ ãŒç©ºã®å ´åˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
        if (!personaTextarea.value) personaTextarea.value = '';
        if (!summaryPromptTextarea.value) summaryPromptTextarea.value = 
            `ä»¥ä¸‹ã®ä¼šè©±å±¥æ­´ã‚’åŸºã«ã€ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ30æ–‡å­—ç¨‹åº¦ï¼‰ã¨ã€ä¼šè©±ã®è¦ç´„ã‚’ç®‡æ¡æ›¸ãã«ã—ã¦ä½œæˆã—ã€JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå‡ºåŠ›ã¯ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¾“ã£ã¦ãã ã•ã„ã€‚\n{\n  "title": "ã“ã“ã«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨˜è¿° (15æ–‡å­—ç¨‹åº¦)",\n  "summary": "ã“ã“ã«ä¼šè©±ã®è¦ç´„ã‚’è¨˜è¿° (ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã‹ã‚‰è‡ªç„¶ãªæ–‡ç« ã§)"\n}\n\n---\n[ä¼šè©±å±¥æ­´]\n{CONVERSATION_HISTORY}\n---`;
        if (!userNameInput.value) userNameInput.value = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
        if (!aiNameInput.value) aiNameInput.value = 'AI';
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¯DOMåˆæœŸåŒ–æ™‚ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šã„
        // ã“ã“ã§ã¯å¿µã®ãŸã‚ã€ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«åæ˜ 
        soundOnOff.checked = soundOnOff.checked;
        soundTypeSelect.value = soundTypeSelect.value;
        ttsOnOff.checked = ttsOnOff.checked;
        ttsEnabled = ttsOnOff.checked;
        
        // TTSè¨­å®šå€¤ã®åæ˜  (range inputã®å€¤ã¯è‡ªå‹•ã§DOMã«è¨­å®šã•ã‚Œã¦ã„ã‚‹)
        ttsRate = parseFloat(ttsRateInput.value);
        ttsPitch = parseFloat(ttsPitchInput.value);
        ttsVolume = parseFloat(ttsVolumeInput.value);

        ttsRateValue.textContent = ttsRate.toFixed(1);
        ttsPitchValue.textContent = ttsPitch.toFixed(1);
        ttsVolumeValue.textContent = ttsVolume.toFixed(1);
    }

    // â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã‹ã‚‰â˜… ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
    function switchTab(event) {
        const clickedTab = event.target;
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã®ãŒã‚¿ãƒ–ãƒœã‚¿ãƒ³ã§ãªãã€æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãªã‚‰ä½•ã‚‚ã—ãªã„
        if (!clickedTab.classList.contains('tab-button') || clickedTab.classList.contains('active')) {
            return;
        }

        // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãƒœã‚¿ãƒ³ã¨ãƒšã‚¤ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        document.querySelector('.tab-button.active')?.classList.remove('active');
        document.querySelector('.tab-pane.active')?.classList.remove('active');

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ã€å¯¾å¿œã™ã‚‹ãƒšã‚¤ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
        clickedTab.classList.add('active');
        const targetTabId = clickedTab.dataset.tab;
        document.getElementById(targetTabId)?.classList.add('active');
    }

    // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    tabNavigation.addEventListener('click', switchTab);
    // â˜…ç”»é¢æ§‹æˆæ”¹å–„ã“ã“ã¾ã§â˜…
</script>

</body>
</html>